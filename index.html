<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>AV Verbal Scenario Assessment Tool</title>
<style>
:root {
  --navy: #1C3A6E; --navy-dark: #122849; --navy-light: #2A4F8F;
  --red: #C0392B; --red-light: #FDEDEC;
  --amber: #E8921A; --amber-light: #FEF5E7;
  --green: #27833A; --green-light: #EAFAF1;
  --blue: #2E86C1; --blue-light: #EBF5FB;
  --purple: #7D3C98; --purple-light: #F5EEF8;
  --grey: #6C7A89; --light: #F4F6F9; --white: #FFFFFF; --text: #1A1A2E; --border: #D5D8DC;
  --shadow: 0 2px 8px rgba(28,58,110,0.10);
  --tap: 48px; /* minimum tap target */
}
* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
html { font-size: 16px; }
body { font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; background: var(--light); color: var(--text); line-height: 1.5; overscroll-behavior: none; }

/* ============================================================ TOP BAR */
#topbar { background: var(--navy); color: white; padding: 0 16px; display: flex; align-items: center; gap: 10px; height: 56px; position: fixed; top: 0; left: 0; right: 0; z-index: 100; box-shadow: 0 2px 8px rgba(0,0,0,0.25); }
#topbar .logo { display: flex; align-items: center; gap: 10px; }
#topbar .logo-icon { width: 38px; height: 38px; background: white; border-radius: 6px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
#topbar h1 { font-size: 14px; font-weight: 700; line-height: 1.2; }
#topbar .subtitle { font-size: 10px; opacity: 0.7; }
.topbar-actions { margin-left: auto; display: flex; gap: 8px; align-items: center; }
.tb-btn { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 6px; min-height: var(--tap); white-space: nowrap; }
.tb-btn:active { background: rgba(255,255,255,0.3); }
.ai-dot { width: 8px; height: 8px; border-radius: 50%; background: #F39C12; }
.ai-active .ai-dot { background: #2ECC71; animation: pulse 2s infinite; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
#hamburger { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); color: white; width: 44px; height: 44px; border-radius: 8px; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
#hamburger:active { background: rgba(255,255,255,0.3); }

/* ============================================================ LAYOUT */
#main-wrapper { display: flex; margin-top: 56px; min-height: calc(100vh - 56px); position: relative; }

/* ============================================================ SIDEBAR ‚Äî slide-over drawer on iPad */
#sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 60; top: 56px; }
#sidebar-overlay.open { display: block; }
#sidebar { width: 300px; min-width: 300px; background: white; border-right: 1px solid var(--border); display: flex; flex-direction: column; position: fixed; top: 56px; left: 0; bottom: 0; overflow-y: auto; z-index: 70; transform: translateX(-100%); transition: transform 0.28s cubic-bezier(0.4,0,0.2,1); box-shadow: 4px 0 20px rgba(0,0,0,0.15); }
#sidebar.open { transform: translateX(0); }
#sidebar::-webkit-scrollbar { width: 4px; }
#sidebar::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
#sidebar-header { padding: 14px 16px 10px; border-bottom: 1px solid var(--border); background: var(--navy); color: white; }
#sidebar-header h2 { font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; opacity: 0.85; }
#search-box { padding: 10px 12px; border-bottom: 1px solid var(--border); }
#search-input { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; background: var(--light); outline: none; }
#search-input:focus { border-color: var(--navy); }
.category-group { border-bottom: 1px solid var(--border); }
.category-header { padding: 10px 14px; font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.6px; color: white; display: flex; align-items: center; gap: 6px; cursor: pointer; user-select: none; min-height: var(--tap); }
.category-header.medical { background: var(--navy); }
.category-header.trauma { background: var(--red); }
.category-header.paediatric { background: var(--blue); }
.category-header.obstetric { background: var(--purple); }
.category-header.custom { background: #16A085; }
.cat-count { margin-left: auto; background: rgba(255,255,255,0.25); border-radius: 10px; padding: 2px 8px; font-size: 11px; }
.scenario-item { padding: 10px 14px 10px 24px; cursor: pointer; border-bottom: 1px solid #f0f0f0; transition: background 0.15s; min-height: 60px; display: flex; flex-direction: column; justify-content: center; }
.scenario-item:active { background: var(--light); }
.scenario-item.active { background: var(--blue-light); border-left: 3px solid var(--navy); padding-left: 21px; }
.scenario-item .si-title { font-size: 13px; font-weight: 600; }
.scenario-item .si-sub { font-size: 12px; color: var(--grey); }
.scenario-item .si-cpg { font-size: 11px; color: var(--navy); font-weight: 600; margin-top: 2px; }
.scenario-item .si-badges { display: flex; gap: 4px; margin-top: 3px; flex-wrap: wrap; }
.si-badge { font-size: 10px; padding: 1px 6px; border-radius: 10px; font-weight: 600; }
.si-badge.custom { background: #E8F8F5; color: #16A085; border: 1px solid #A2D9CE; }
.si-badge.ai { background: var(--purple-light); color: var(--purple); border: 1px solid #C39BD3; }
.sidebar-bottom { padding: 12px; border-top: 2px solid var(--border); background: var(--light); display: flex; flex-direction: column; gap: 8px; }
.sidebar-bottom-btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: 700; font-size: 13px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; min-height: var(--tap); }
.sidebar-bottom-btn.amber { background: var(--amber); color: white; }
.sidebar-bottom-btn.green { background: var(--green); color: white; }
.sidebar-bottom-btn.purple { background: var(--purple); color: white; }
.sidebar-bottom-btn:active { opacity: 0.85; }

/* ============================================================ CONTENT */
#content { flex: 1; padding: 16px; min-height: calc(100vh - 56px); width: 100%; }

/* ============================================================ SCORE PANEL ‚Äî bottom sheet on iPad */
#score-panel { display: none; }
#score-panel.visible { display: block; }
#score-panel-toggle { position: fixed; bottom: 16px; right: 16px; z-index: 50; width: 60px; height: 60px; border-radius: 50%; background: var(--navy); color: white; border: none; font-size: 22px; cursor: pointer; box-shadow: 0 4px 16px rgba(0,0,0,0.25); display: none; align-items: center; justify-content: center; }
#score-panel-toggle.visible { display: flex; }
#score-panel-toggle:active { background: var(--navy-dark); }
#score-sheet { position: fixed; bottom: 0; left: 0; right: 0; z-index: 80; background: white; border-radius: 20px 20px 0 0; box-shadow: 0 -4px 24px rgba(0,0,0,0.18); transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4,0,0.2,1); max-height: 75vh; overflow-y: auto; padding-bottom: env(safe-area-inset-bottom); }
#score-sheet.open { transform: translateY(0); }
#score-sheet-handle { width: 40px; height: 4px; background: var(--border); border-radius: 2px; margin: 12px auto 0; }
#score-sheet-header { padding: 12px 20px 10px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
#score-sheet-header h3 { font-size: 14px; font-weight: 700; }
#close-score-sheet { background: var(--light); border: none; border-radius: 50%; width: 32px; height: 32px; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
#score-sheet-body { padding: 16px 20px; }
#score-sheet-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.3); z-index: 79; }
#score-sheet-overlay.open { display: block; }

/* HOME */
#home-screen { max-width: 820px; margin: 0 auto; }
.welcome-header { background: var(--navy); color: white; border-radius: 12px; padding: 24px 24px; margin-bottom: 16px; }
.welcome-header h2 { font-size: 20px; font-weight: 700; margin-bottom: 6px; }
.welcome-header p { font-size: 13px; opacity: 0.8; }
.stats-grid { display: grid; grid-template-columns: repeat(2,1fr); gap: 10px; margin-bottom: 16px; }
@media (min-width: 600px) { .stats-grid { grid-template-columns: repeat(4,1fr); } }
.stat-card { background: white; border-radius: 10px; padding: 14px; text-align: center; border: 1px solid var(--border); box-shadow: var(--shadow); }
.stat-card .stat-num { font-size: 26px; font-weight: 800; line-height: 1; }
.stat-card .stat-label { font-size: 11px; color: var(--grey); margin-top: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
.stat-card.navy .stat-num { color: var(--navy); }
.stat-card.red .stat-num { color: var(--red); }
.stat-card.blue .stat-num { color: var(--blue); }
.stat-card.purple .stat-num { color: var(--purple); }
.stat-card.green .stat-num { color: var(--green); }
.category-overview { display: grid; grid-template-columns: 1fr; gap: 10px; }
@media (min-width: 600px) { .category-overview { grid-template-columns: repeat(2,1fr); } }
.cat-card { background: white; border-radius: 10px; padding: 14px 18px; border: 1px solid var(--border); border-left: 4px solid var(--navy); box-shadow: var(--shadow); }
.cat-card.trauma { border-left-color: var(--red); }
.cat-card.paediatric { border-left-color: var(--blue); }
.cat-card.obstetric { border-left-color: var(--purple); }
.cat-card.custom { border-left-color: #16A085; }
.cat-card h3 { font-size: 13px; font-weight: 700; margin-bottom: 4px; }
.cat-card p { font-size: 12px; color: var(--grey); line-height: 1.4; }
.quick-actions { display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; }
.quick-action-btn { flex: 1; min-width: 140px; padding: 14px 16px; border-radius: 10px; border: none; cursor: pointer; font-weight: 700; font-size: 13px; display: flex; align-items: center; gap: 8px; box-shadow: var(--shadow); min-height: var(--tap); }
.quick-action-btn.amber { background: var(--amber); color: white; }
.quick-action-btn.green { background: var(--green); color: white; }
.quick-action-btn.purple { background: var(--purple); color: white; }
.quick-action-btn:active { opacity: 0.85; }

/* SCENARIO VIEW */
#scenario-view { display: none; max-width: 1000px; margin: 0 auto; }
.scenario-header { background: var(--navy); color: white; border-radius: 12px 12px 0 0; padding: 16px 20px; display: flex; align-items: flex-start; justify-content: space-between; gap: 12px; }
.sh-left h2 { font-size: 17px; font-weight: 800; }
.sh-left .sh-sub { font-size: 12px; opacity: 0.8; margin-top: 2px; }
.sh-badges { display: flex; gap: 6px; margin-top: 8px; flex-wrap: wrap; }
.badge { padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; background: rgba(255,255,255,0.15); color: white; }
.badge.amber-badge { background: var(--amber); }
.ai-generated-badge { display: inline-flex; align-items: center; gap: 5px; background: linear-gradient(135deg,var(--purple),var(--blue)); color: white; padding: 3px 10px; border-radius: 20px; font-size: 10px; font-weight: 700; }
.custom-badge { background: #16A085; }
.ai-disclaimer { background: rgba(255,255,255,0.12); border: 1px solid rgba(255,255,255,0.25); border-radius: 6px; padding: 6px 10px; font-size: 11px; margin-top: 8px; }
.sh-timer { text-align: center; min-width: 80px; flex-shrink: 0; }
#timer-display { font-size: 26px; font-weight: 900; font-family: 'Courier New', monospace; color: white; line-height: 1; }
#timer-display.warning { color: #F39C12; }
#timer-display.danger { color: #E74C3C; animation: blink 1s step-end infinite; }
@keyframes blink { 50%{opacity:0.4} }
.timer-controls { display: flex; gap: 4px; margin-top: 6px; justify-content: center; }
.timer-btn { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.25); color: white; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; min-height: 36px; min-width: 36px; }
.timer-btn:active { background: rgba(255,255,255,0.3); }

/* SCENARIO BODY */
.scenario-body { background: white; border: 1px solid var(--border); border-top: none; border-radius: 0 0 12px 12px; overflow: hidden; }
.dispatch-card { background: var(--navy-dark); color: white; padding: 14px 16px; }
@media (min-width: 700px) { .dispatch-card { display: grid; grid-template-columns: 1fr auto; gap: 16px; align-items: start; } }
.dc-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.8px; opacity: 0.6; margin-bottom: 4px; }
.dc-text { font-size: 13px; line-height: 1.5; }
.vitals-grid { display: grid; grid-template-columns: repeat(2,1fr); gap: 4px; margin-top: 12px; }
@media (min-width: 700px) { .vitals-grid { min-width: 210px; margin-top: 0; } }
.vital-item { background: rgba(255,255,255,0.08); border-radius: 5px; padding: 5px 8px; font-size: 12px; }
.vital-item .vl { opacity: 0.6; font-size: 10px; }
.vital-item .vv { font-weight: 700; }
.vital-item.abnormal { background: rgba(192,57,43,0.4); }

/* SECTIONS */
.section { border-bottom: 1px solid var(--border); }
.section-header { padding: 14px 16px; display: flex; align-items: center; gap: 10px; cursor: pointer; user-select: none; transition: background 0.15s; min-height: 54px; }
.section-header:active { background: var(--light); }
.section-icon { width: 30px; height: 30px; border-radius: 7px; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 800; color: white; flex-shrink: 0; }
.section-icon.navy { background: var(--navy); }
.section-icon.red { background: var(--red); }
.section-icon.amber { background: var(--amber); }
.section-icon.green { background: var(--green); }
.section-icon.blue { background: var(--blue); }
.section-icon.purple { background: var(--purple); }
.section-title { font-size: 13px; font-weight: 700; flex: 1; }
.section-badge { background: var(--light); border: 1px solid var(--border); border-radius: 12px; padding: 3px 8px; font-size: 11px; font-weight: 700; white-space: nowrap; }
.section-chevron { font-size: 12px; color: var(--grey); transition: transform 0.2s; flex-shrink: 0; }
.section-header.open .section-chevron { transform: rotate(180deg); }
.section-body { padding: 0 16px 14px; display: none; }
.section-body.open { display: block; }

/* GRAD BAR */
.grad-bar { background: var(--blue-light); border-bottom: 1px solid var(--border); padding: 10px 16px; display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
.grad-field { display: flex; align-items: center; gap: 6px; }
.grad-field label { font-size: 11px; font-weight: 700; color: var(--grey); white-space: nowrap; }
.grad-field input, .grad-field select { padding: 8px 10px; border: 1px solid var(--border); border-radius: 7px; font-size: 13px; font-family: inherit; outline: none; background: white; min-height: 40px; }
.grad-field input:focus, .grad-field select:focus { border-color: var(--navy); }
.action-bar { padding: 8px 16px; background: var(--light); border-bottom: 1px solid var(--border); display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
.action-btn { padding: 8px 14px; border-radius: 7px; border: 1px solid var(--border); background: white; font-size: 12px; font-weight: 600; cursor: pointer; min-height: 40px; }
.action-btn:active { border-color: var(--navy); color: var(--navy); }

/* ============================================================ ASSESSMENT TABLE */
.asmt-section-title { background: var(--navy); color: white; padding: 8px 12px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 10px; border-radius: 5px 5px 0 0; }
.asmt-section-title.trauma { background: var(--red); }
.asmt-section-title.history { background: var(--amber); }
.asmt-section-title.vss { background: var(--blue); }
.asmt-section-title.diagnosis { background: var(--purple); }
.asmt-section-title.implement { background: var(--green); }
.asmt-table { width: 100%; border-collapse: collapse; font-size: 12px; border: 1px solid var(--border); }
.asmt-table th { background: var(--light); font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.4px; color: var(--grey); padding: 8px 6px; text-align: center; border: 1px solid var(--border); }
.asmt-table th.left { text-align: left; padding-left: 10px; }
.asmt-table td { padding: 6px 8px; border: 1px solid #eee; vertical-align: middle; }
.asmt-table td.elem-label { padding-left: 10px; }
.asmt-table td.elem-label.indent { padding-left: 22px; color: var(--grey); font-size: 11px; }
.tick-col { text-align: center; width: 80px; }
.tick-btn { width: 36px; height: 36px; border-radius: 7px; border: 2px solid var(--border); cursor: pointer; display: inline-flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 800; transition: all 0.15s; background: white; user-select: none; }
.tick-btn:active { transform: scale(0.92); }
.tick-btn.prompted { background: var(--amber); border-color: var(--amber); color: white; }
.tick-btn.incomplete { background: var(--red); border-color: var(--red); color: white; }
.tick-btn.complete { background: var(--green); border-color: var(--green); color: white; }
.score-row td { background: var(--light); font-weight: 700; padding: 10px 8px; font-size: 12px; }
.score-radio-group { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }
.score-radio-btn { width: 40px; height: 40px; border-radius: 7px; border: 2px solid var(--border); cursor: pointer; display: inline-flex; align-items: center; justify-content: center; font-weight: 800; font-size: 15px; background: white; transition: all 0.15s; }
.score-radio-btn:active { transform: scale(0.92); }
.score-radio-btn.sel-1 { background: #E74C3C; border-color: #E74C3C; color: white; }
.score-radio-btn.sel-2 { background: #E67E22; border-color: #E67E22; color: white; }
.score-radio-btn.sel-3 { background: #F1C40F; border-color: #F1C40F; color: #333; }
.score-radio-btn.sel-4 { background: #27AE60; border-color: #27AE60; color: white; }
.score-radio-btn.sel-5 { background: #1ABC9C; border-color: #1ABC9C; color: white; }
.asmt-freetext { width: 100%; border: 1px solid var(--border); border-radius: 6px; padding: 6px 10px; font-size: 13px; font-family: inherit; resize: vertical; min-height: 36px; }
.ddx-input { width: 100%; border: 1px solid var(--border); border-radius: 6px; padding: 6px 10px; font-size: 13px; font-family: inherit; }

/* ============================================================ KQ */
.kq-block { background: var(--light); border: 1px solid var(--border); border-radius: 10px; margin-bottom: 12px; overflow: hidden; }
.kq-question { padding: 12px 14px; font-size: 13px; font-weight: 600; line-height: 1.4; background: var(--blue-light); border-bottom: 1px solid var(--border); display: flex; gap: 10px; align-items: flex-start; }
.kq-num { width: 24px; height: 24px; border-radius: 50%; background: var(--navy); color: white; font-size: 11px; font-weight: 800; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 1px; }
.kq-body { padding: 12px 14px; }
.kq-score-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; flex-wrap: wrap; }
.kq-score-label { font-size: 11px; font-weight: 700; color: var(--grey); }
.kq-score-btn { width: 40px; height: 40px; border-radius: 7px; border: 2px solid var(--border); background: white; font-size: 14px; font-weight: 700; cursor: pointer; transition: all 0.15s; display: flex; align-items: center; justify-content: center; }
.kq-score-btn:active { transform: scale(0.92); }
.kq-score-btn.sel-0 { background: var(--red); border-color: var(--red); color: white; }
.kq-score-btn.sel-1 { background: var(--amber); border-color: var(--amber); color: white; }
.kq-score-btn.sel-2 { background: var(--green); border-color: var(--green); color: white; }
.kq-criteria { font-size: 11px; color: var(--grey); margin-bottom: 8px; line-height: 1.6; }
.kq-criteria li { margin-left: 16px; }
.reveal-btn { padding: 8px 14px; border: 1px solid var(--navy); background: white; color: var(--navy); border-radius: 7px; cursor: pointer; font-size: 12px; font-weight: 700; margin-left: auto; min-height: 40px; }
.reveal-btn:active { background: var(--navy); color: white; }
.kq-answer { background: var(--green-light); border: 1px solid #A9DFBF; border-radius: 7px; padding: 10px 14px; font-size: 12px; line-height: 1.5; margin-top: 8px; display: none; }
.kq-answer.visible { display: block; }

/* ============================================================ FLAGS */
.flags-list { list-style: none; }
.flag-item { display: flex; gap: 8px; padding: 6px 0; font-size: 13px; border-bottom: 1px solid #f5f5f5; align-items: flex-start; }
.flag-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--red); margin-top: 6px; flex-shrink: 0; }
.ddx-info { background: var(--blue-light); border: 1px solid #AED6F1; border-radius: 8px; padding: 10px 14px; font-size: 12px; margin-top: 10px; }

/* ============================================================ SCORE PANEL CONTENT */
.sp-section { margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid var(--border); }
.sp-section-label { font-size: 11px; font-weight: 700; color: var(--grey); text-transform: uppercase; margin-bottom: 6px; }
.sp-score-row { display: flex; justify-content: space-between; align-items: center; font-size: 13px; padding: 3px 0; }
.sp-score-val { font-weight: 800; font-size: 16px; }
.sp-score-val.s1 { color: #E74C3C; } .sp-score-val.s2 { color: #E67E22; } .sp-score-val.s3 { color: #F39C12; } .sp-score-val.s4 { color: #27AE60; } .sp-score-val.s5 { color: #1ABC9C; } .sp-score-val.none { color: var(--grey); }
.total-score-display { text-align: center; margin-top: 12px; padding: 16px; border-radius: 10px; background: var(--light); }
.ts-num { font-size: 48px; font-weight: 900; line-height: 1; }
.ts-denom { font-size: 18px; color: var(--grey); }
.ts-label { font-size: 11px; text-transform: uppercase; margin-top: 4px; color: var(--grey); }
.result-badge { display: inline-block; padding: 6px 20px; border-radius: 20px; font-weight: 800; font-size: 14px; margin-top: 10px; }
.result-badge.pass { background: var(--green-light); color: var(--green); border: 2px solid var(--green); }
.result-badge.fail { background: var(--red-light); color: var(--red); border: 2px solid var(--red); }
.result-badge.pending { background: var(--light); color: var(--grey); border: 2px solid var(--border); }
.lookup-table { width: 100%; border-collapse: collapse; font-size: 10px; margin-top: 6px; }
.lookup-table td, .lookup-table th { border: 1px solid var(--border); padding: 3px 4px; text-align: center; }
.lookup-table th { background: var(--navy); color: white; font-size: 9px; }
.lookup-table .highlight { background: #FFF9C4; font-weight: 800; }
#reset-btn { width: 100%; margin-top: 10px; padding: 12px; background: white; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; font-size: 13px; color: var(--grey); min-height: var(--tap); }
#reset-btn:active { border-color: var(--red); color: var(--red); }

/* ============================================================ TREATMENT BOX */
.treatment-box { background: var(--green-light); border: 1px solid #A9DFBF; border-radius: 8px; padding: 12px 14px; margin: 10px 0; }
.treatment-box h4 { font-size: 11px; font-weight: 700; color: var(--green); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
.treatment-box ol { margin-left: 18px; font-size: 13px; line-height: 1.7; }

/* ============================================================ MODAL BASE */
.modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; align-items: center; justify-content: center; padding: 16px; }
.modal-overlay.open { display: flex; }
.modal-inner { background: white; border-radius: 14px; width: 100%; max-width: 580px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
.modal-header { background: var(--navy); color: white; padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; border-radius: 14px 14px 0 0; position: sticky; top: 0; z-index: 1; }
.modal-header h2 { font-size: 15px; font-weight: 700; }
.modal-close { background: rgba(255,255,255,0.15); border: none; color: white; width: 36px; height: 36px; border-radius: 50%; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
.modal-body { padding: 20px; }

/* ============================================================ AI MODAL */
.form-group { margin-bottom: 14px; }
.form-group label { display: block; font-size: 13px; font-weight: 700; margin-bottom: 6px; }
.form-group select, .form-group input[type=text], .form-group input[type=password], .form-group textarea { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; outline: none; font-family: inherit; min-height: 44px; }
.form-group select:focus, .form-group input:focus, .form-group textarea:focus { border-color: var(--navy); }
.form-group .hint { font-size: 11px; color: var(--grey); margin-top: 4px; }
.api-key-section { background: var(--amber-light); border: 1px solid #F5CBA7; border-radius: 10px; padding: 14px; margin-bottom: 16px; }
.api-key-section h3 { font-size: 12px; font-weight: 700; color: var(--amber); margin-bottom: 6px; }
.api-key-section p { font-size: 12px; color: #7D6608; line-height: 1.5; margin-bottom: 10px; }
.modal-submit-btn { width: 100%; padding: 14px; border: none; border-radius: 10px; font-weight: 700; font-size: 15px; cursor: pointer; min-height: var(--tap); }
.modal-submit-btn.navy { background: var(--navy); color: white; }
.modal-submit-btn.green { background: var(--green); color: white; }
.modal-submit-btn:disabled { background: #ccc; cursor: not-allowed; }
.modal-submit-btn:active:not(:disabled) { opacity: 0.88; }
#ai-status { margin-top: 12px; padding: 12px 14px; border-radius: 8px; font-size: 13px; display: none; align-items: center; gap: 10px; }
#ai-status.loading { background: var(--blue-light); color: var(--blue); display: flex; }
#ai-status.error { background: var(--red-light); color: var(--red); display: block; }
#ai-status.success { background: var(--green-light); color: var(--green); display: block; }
.ai-spinner { width: 18px; height: 18px; border: 3px solid rgba(46,134,193,0.25); border-top-color: var(--blue); border-radius: 50%; animation: spin 0.8s linear infinite; flex-shrink: 0; }
@keyframes spin { to { transform: rotate(360deg); } }
.save-scenario-bar { background: var(--green-light); border: 1px solid #A9DFBF; border-radius: 8px; padding: 12px 14px; margin-top: 14px; display: none; flex-direction: column; gap: 8px; }
.save-scenario-bar.visible { display: flex; }
.save-scenario-bar p { font-size: 12px; color: var(--green); font-weight: 600; }
.save-btn { padding: 10px 18px; background: var(--green); color: white; border: none; border-radius: 8px; font-weight: 700; font-size: 13px; cursor: pointer; min-height: var(--tap); align-self: flex-start; }
.save-btn:active { opacity: 0.85; }

/* ============================================================ MANUAL CREATE MODAL */
.create-section-title { font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--grey); letter-spacing: 0.5px; margin: 18px 0 8px; padding-top: 14px; border-top: 1px solid var(--border); }
.create-section-title:first-child { margin-top: 0; border-top: none; padding-top: 0; }
.vitals-grid-form { display: grid; grid-template-columns: repeat(2,1fr); gap: 8px; }
.repeating-list { border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
.repeating-item { display: flex; gap: 8px; padding: 8px; border-bottom: 1px solid var(--border); align-items: center; }
.repeating-item:last-child { border-bottom: none; }
.repeating-item input, .repeating-item textarea { flex: 1; border: 1px solid var(--border); border-radius: 6px; padding: 8px 10px; font-size: 13px; font-family: inherit; outline: none; }
.repeating-item input:focus, .repeating-item textarea:focus { border-color: var(--navy); }
.rep-remove-btn { width: 34px; height: 34px; border-radius: 50%; background: var(--red-light); color: var(--red); border: 1px solid #F5B7B1; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.rep-remove-btn:active { background: var(--red); color: white; }
.add-item-btn { width: 100%; padding: 10px; background: var(--light); border: 2px dashed var(--border); border-radius: 8px; color: var(--grey); font-size: 13px; font-weight: 600; cursor: pointer; margin-top: 6px; min-height: 44px; }
.add-item-btn:active { border-color: var(--navy); color: var(--navy); }
.kq-create-block { border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 8px; background: var(--light); }
.kq-create-block label { font-size: 12px; font-weight: 700; color: var(--grey); display: block; margin-bottom: 4px; }
.kq-create-block textarea { width: 100%; border: 1px solid var(--border); border-radius: 6px; padding: 8px; font-size: 13px; font-family: inherit; resize: vertical; min-height: 60px; outline: none; margin-bottom: 8px; }
.kq-create-block textarea:focus { border-color: var(--navy); }
.kq-max-select { display: flex; gap: 8px; align-items: center; }
.kq-max-select label { font-size: 12px; color: var(--grey); font-weight: 600; }
.kq-max-btn { width: 40px; height: 40px; border-radius: 7px; border: 2px solid var(--border); background: white; font-size: 14px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; }
.kq-max-btn.active { background: var(--navy); border-color: var(--navy); color: white; }
.form-info { background: var(--blue-light); border: 1px solid #AED6F1; border-radius: 8px; padding: 10px 14px; font-size: 12px; color: var(--blue); line-height: 1.5; margin-bottom: 14px; }

/* ============================================================ CUSTOM SCENARIO MANAGEMENT */
.manage-scenario-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 8px; background: white; }
.msi-info { flex: 1; }
.msi-title { font-size: 13px; font-weight: 700; }
.msi-sub { font-size: 12px; color: var(--grey); }
.msi-delete-btn { padding: 8px 12px; background: var(--red-light); color: var(--red); border: 1px solid #F5B7B1; border-radius: 7px; cursor: pointer; font-size: 12px; font-weight: 700; min-height: 40px; }
.msi-delete-btn:active { background: var(--red); color: white; }
.no-custom-msg { text-align: center; padding: 24px; color: var(--grey); font-size: 13px; }

/* ============================================================ NEW SIDEBAR HIERARCHY */
.sidebar-group { border-bottom: 1px solid var(--border); }
.sidebar-group-header { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; color: white; font-size: 12px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer; user-select: none; }
.sidebar-group-header:active { opacity: 0.85; }
.group-chevron { font-size: 12px; transition: transform 0.2s; }
.sidebar-subcat { border-top: 1px solid rgba(0,0,0,0.06); }
.sidebar-subcat-header { display: flex; align-items: center; justify-content: space-between; padding: 8px 14px 8px 20px; background: var(--light); font-size: 11px; font-weight: 700; color: var(--text); cursor: pointer; user-select: none; border-bottom: 1px solid var(--border); }
.sidebar-subcat-header:active { background: #e8eaf6; }
.sidebar-subcat-items .scenario-item { padding-left: 24px; }
/* ============================================================ ECG STRIP */
.ecg-strip-section { margin: 10px 0 4px; }
.ecg-strip-label { font-size: 11px; font-weight: 700; color: var(--grey); text-transform: uppercase; letter-spacing: 0.6px; margin-bottom: 6px; display: flex; align-items: center; gap: 6px; }
.ecg-strip-img { display: block; width: 100%; max-width: 680px; border-radius: 6px; border: 1px solid var(--border); background: #f0f0f0; }
.ecg-strip-caption { font-size: 10px; color: var(--grey); margin-top: 4px; }
.ecg-strip-caption a { color: var(--grey); }
.ecg-strip-loading { font-size: 11px; color: var(--grey); font-style: italic; padding: 6px 0; }
/* ============================================================ VITAL HINTS */
.vital-hint { display: inline-block; margin-left: 6px; background: var(--navy); color: white; font-size: 10px; font-weight: 600; padding: 1px 6px; border-radius: 4px; vertical-align: middle; opacity: 0.9; font-family: monospace; letter-spacing: 0.3px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.elem-label { vertical-align: middle; }
/* ============================================================ ALL-COMPLETE BUTTON */
.asmt-section-header { display: flex; align-items: center; justify-content: space-between; margin-top: 10px; }
.asmt-section-header .asmt-section-title { margin-top: 0; flex: 1; border-radius: 6px 0 0 6px; }
.all-complete-btn { background: var(--green); color: white; border: none; border-radius: 0 6px 6px 0; padding: 0 12px; font-size: 11px; font-weight: 700; cursor: pointer; white-space: nowrap; flex-shrink: 0; height: 32px; line-height: 32px; }
.all-complete-btn:active { opacity: 0.85; }
/* ============================================================ AUTO-SCORE */
.auto-score-indicator { font-size: 10px; color: var(--grey); margin-top: 4px; font-style: italic; }
/* ============================================================ FOOTER */
#site-footer { background: #1a1a2e; color: rgba(255,255,255,0.5); padding: 24px 24px 32px; font-size: 11px; line-height: 1.7; border-top: 1px solid rgba(255,255,255,0.08); margin-top: 40px; }
#site-footer .footer-inner { max-width: 960px; margin: 0 auto; }
#site-footer hr { border: none; border-top: 1px solid rgba(255,255,255,0.1); margin: 12px 0; }
#site-footer strong { color: rgba(255,255,255,0.75); font-weight: 600; }
/* ============================================================ CPG SCENARIO FOOTER */
.scenario-cpg-footer { background: var(--light); border: 1px solid var(--border); border-top: none; border-radius: 0 0 12px 12px; padding: 10px 20px; font-size: 11px; color: var(--grey); line-height: 1.6; }
.scenario-cpg-footer strong { color: var(--text); }
/* ============================================================ COMMENTS */
.comments-area { padding: 14px 16px; }
.comments-area h3 { font-size: 12px; font-weight: 700; text-transform: uppercase; color: var(--grey); letter-spacing: 0.5px; margin-bottom: 8px; }
.comments-area textarea { width: 100%; border: 1px solid var(--border); border-radius: 8px; padding: 10px 12px; font-size: 14px; font-family: inherit; resize: vertical; min-height: 80px; outline: none; }
.comments-area textarea:focus { border-color: var(--navy); }

/* ============================================================ PRINT */
@media print {
  #topbar, #sidebar, #sidebar-overlay, .modal-overlay, .action-bar, .timer-controls, .sidebar-bottom, #score-panel-toggle, #score-sheet, #score-sheet-overlay, #sticky-bar, .sticky-bar-offset { display: none !important; }
  #content { margin: 0 !important; padding: 0 !important; }
  .section-body { display: block !important; }
  .kq-answer { display: block !important; }
  body { font-size: 11px; }
}

/* ============================================================ STICKY SCENARIO BAR (timer + vitals) */
#sticky-bar { display: none; position: fixed; top: 56px; left: 0; right: 0; z-index: 45; background: var(--navy-dark); color: white; box-shadow: 0 2px 8px rgba(0,0,0,0.25); }
#sticky-bar.visible { display: block; }
#sticky-bar-inner { display: flex; align-items: center; gap: 0; overflow: hidden; }

/* Timer section */
#sticky-timer { display: flex; align-items: center; gap: 8px; padding: 6px 14px; background: rgba(0,0,0,0.2); flex-shrink: 0; border-right: 1px solid rgba(255,255,255,0.15); }
#sticky-timer-display { font-size: 20px; font-weight: 900; font-family: 'Courier New', monospace; color: white; min-width: 56px; }
#sticky-timer-display.warning { color: #F39C12; }
#sticky-timer-display.danger { color: #E74C3C; animation: blink 1s step-end infinite; }
.sticky-timer-btn { background: rgba(255,255,255,0.12); border: 1px solid rgba(255,255,255,0.2); color: white; width: 30px; height: 30px; border-radius: 5px; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center; }
.sticky-timer-btn:active { background: rgba(255,255,255,0.3); }

/* Scenario title */
#sticky-title { padding: 0 12px; flex-shrink: 0; border-right: 1px solid rgba(255,255,255,0.15); display: none; }
@media (min-width: 500px) { #sticky-title { display: block; } }
#sticky-title .st-name { font-size: 12px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 150px; }
#sticky-title .st-sub { font-size: 10px; opacity: 0.65; white-space: nowrap; }

/* Vitals strip */
#sticky-vitals { display: flex; align-items: center; gap: 0; overflow-x: auto; flex: 1; padding: 0 4px; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
#sticky-vitals::-webkit-scrollbar { display: none; }
.sv-item { display: flex; flex-direction: column; align-items: center; padding: 5px 10px; border-right: 1px solid rgba(255,255,255,0.1); flex-shrink: 0; cursor: default; }
.sv-item.abnormal { background: rgba(192,57,43,0.35); }
.sv-label { font-size: 9px; opacity: 0.6; text-transform: uppercase; letter-spacing: 0.5px; }
.sv-value { font-size: 13px; font-weight: 700; white-space: nowrap; }

/* Edit button in sticky bar */
#sticky-edit-btn { padding: 6px 12px; background: rgba(255,255,255,0.12); border: 1px solid rgba(255,255,255,0.25); color: white; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 700; flex-shrink: 0; margin: 0 8px; min-height: 32px; display: flex; align-items: center; gap: 4px; }
#sticky-edit-btn:active { background: rgba(255,255,255,0.25); }

/* Push content down to account for topbar + sticky bar */
#main-wrapper { margin-top: 56px; }
#content { padding-top: 16px; }
.sticky-bar-offset { height: 0; transition: height 0.2s; }
.sticky-bar-offset.visible { height: 44px; }

/* ============================================================ TOAST */
#toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%) translateY(20px); background: #2C3E50; color: white; padding: 12px 20px; border-radius: 24px; font-size: 13px; font-weight: 600; z-index: 500; opacity: 0; transition: all 0.3s; pointer-events: none; white-space: nowrap; }
#toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
</style>
</head>
<body>

<div id="topbar">
  <button id="hamburger" onclick="toggleSidebar()">‚ò∞</button>
  <div class="logo">
    <div class="logo-icon">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
        <path d="M12 2L4 7V12C4 16.55 7.84 20.74 12 22C16.16 20.74 20 16.55 20 12V7L12 2Z" fill="#1C3A6E"/>
        <path d="M11 11H9V13H11V15H13V13H15V11H13V9H11V11Z" fill="white"/>
      </svg>
    </div>
    <div>
      <h1>AV Scenario Assessment</h1>
      <div class="subtitle">Ambulance Victoria ‚Äî ALS Level C/D</div>
    </div>
  </div>
  <div class="topbar-actions">
    <button class="tb-btn" id="ai-toggle-btn" onclick="openAIModal()"><span class="ai-dot"></span>‚ú¶ AI</button>
    <button class="tb-btn" onclick="openCreateModal()" style="background:rgba(39,131,58,0.6)">‚úèÔ∏è Create</button>
  </div>
</div>

<!-- Sticky scenario bar: timer + vitals -->
<div id="sticky-bar">
  <div id="sticky-bar-inner">
    <div id="sticky-timer">
      <div id="sticky-timer-display">28:00</div>
      <button class="sticky-timer-btn" onclick="startTimer()">‚ñ∂</button>
      <button class="sticky-timer-btn" onclick="stopTimer()">‚è∏</button>
      <button class="sticky-timer-btn" onclick="resetTimer()">‚Ü∫</button>
    </div>
    <div id="sticky-title">
      <div class="st-name" id="sticky-title-name">‚Äî</div>
      <div class="st-sub" id="sticky-title-sub">‚Äî</div>
    </div>
    <div id="sticky-vitals"></div>
    <button id="sticky-edit-btn" onclick="openEditModal()">‚úèÔ∏è Edit</button>
  </div>
</div>
<div class="sticky-bar-offset" id="sticky-bar-offset"></div>

<div id="sidebar-overlay" onclick="closeSidebar()"></div>
<div id="sidebar">
  <div id="sidebar-header"><h2>Scenario Library</h2></div>
  <div id="search-box"><input type="text" id="search-input" placeholder="Search scenarios‚Ä¶" oninput="filterScenarios(this.value)"></div>
  <div id="scenario-list"></div>
  <div class="sidebar-bottom">
    <button class="sidebar-bottom-btn amber" onclick="closeSidebar();openAIModal()">‚ú¶ AI Generator</button>
    <button class="sidebar-bottom-btn green" onclick="closeSidebar();openCreateModal()">‚úèÔ∏è Create Manually</button>
    <button class="sidebar-bottom-btn purple" onclick="closeSidebar();openManageModal()">‚öô Manage Custom</button>
  </div>
</div>

<div id="main-wrapper">
  <div id="content">
    <div id="home-screen">
      <div class="welcome-header">
        <h2>AV Verbal Scenario Assessment Tool</h2>
        <p>Assessor-facing tool for ALS (Level C/D) verbal scenarios. Select a scenario from the library or create your own.</p>
      </div>
      <div class="quick-actions">
        <button class="quick-action-btn amber" onclick="openAIModal()">‚ú¶ AI Generator</button>
        <button class="quick-action-btn green" onclick="openCreateModal()">‚úèÔ∏è Create Manually</button>
        <button class="quick-action-btn purple" onclick="openManageModal()">‚öô Custom Library</button>
      </div>
      <div class="stats-grid">
        <div class="stat-card navy"><div class="stat-num">30</div><div class="stat-label">Built-in</div></div>
        <div class="stat-card navy"><div class="stat-num">20</div><div class="stat-label">Adult</div></div>
        <div class="stat-card blue"><div class="stat-num">6</div><div class="stat-label">Paediatric</div></div>
        <div class="stat-card purple"><div class="stat-num">4</div><div class="stat-label">Maternity</div></div>
        <div class="stat-card green" id="custom-stat"><div class="stat-num" id="custom-count">0</div><div class="stat-label">Custom</div></div>
      </div>
      <div class="category-overview">
        <div class="cat-card"><h3>Adult (20)</h3><p>Cardiac Arrest, Cardiac (STEMI, APO, Bradycardia), Respiratory (Asthma), Medical (Anaphylaxis, Stroke, Hypoglycaemia, Sepsis, Syncope, Epilepsy), Mental Health (ABD), Infection, Toxicology (Opioids), Trauma, Environment (Burns, Drowning)</p></div>
        <div class="cat-card paediatric"><h3>Paediatric (6)</h3><p>Cardiac Arrest, Respiratory (Asthma, Croup), Medical (Febrile Seizure, Anaphylaxis), Trauma</p></div>
        <div class="cat-card obstetric"><h3>Maternity (4)</h3><p>Normal Birth, Pre-eclampsia/Eclampsia, Primary PPH, Cord Prolapse</p></div>
        <div class="cat-card custom"><h3>Custom Scenarios</h3><p>AI-generated and manually created scenarios are saved to this device and appear here.</p></div>
      </div>
    </div>
    <div id="scenario-view"></div>
  </div>
</div>

<!-- Score FAB + Sheet -->
<button id="score-panel-toggle" onclick="toggleScoreSheet()">üìä</button>
<div id="score-sheet-overlay" onclick="closeScoreSheet()"></div>
<div id="score-sheet">
  <div id="score-sheet-handle"></div>
  <div id="score-sheet-header">
    <h3>üìä Scoring</h3>
    <button id="close-score-sheet" onclick="closeScoreSheet()">‚úï</button>
  </div>
  <div id="score-sheet-body"></div>
</div>

<!-- AI Modal -->
<div class="modal-overlay" id="ai-modal">
  <div class="modal-inner">
    <div class="modal-header">
      <h2>‚ú¶ AI Scenario Generator</h2>
      <button class="modal-close" onclick="closeAIModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="api-key-section">
        <h3>üîë Anthropic API Key</h3>
        <p>Your key is used for this session only and never stored.</p>
        <div class="form-group" style="margin-bottom:8px"><input type="password" id="api-key-input" placeholder="sk-ant-api03-‚Ä¶" style="font-family:monospace"></div>
        <div style="display:flex;align-items:center;gap:8px">
          <input type="password" id="unlock-password" placeholder="Or enter access code‚Ä¶" style="flex:1;padding:8px 10px;border:1px solid var(--border);border-radius:7px;font-size:13px;font-family:monospace" oninput="checkUnlockCode(this.value)">
          <span id="unlock-status" style="font-size:12px;white-space:nowrap"></span>
        </div>
      </div>
      <div class="form-group"><label>Category</label><select id="gen-category"><optgroup label="Adult">
          <option value="Adult|Cardiac Arrest">Adult ‚Äî Cardiac Arrest</option>
          <option value="Adult|Airway Management">Adult ‚Äî Airway Management</option>
          <option value="Adult|Cardiac">Adult ‚Äî Cardiac</option>
          <option value="Adult|Pain Relief">Adult ‚Äî Pain Relief</option>
          <option value="Adult|Respiratory">Adult ‚Äî Respiratory</option>
          <option value="Adult|Medical">Adult ‚Äî Medical</option>
          <option value="Adult|Infection">Adult ‚Äî Infection</option>
          <option value="Adult|Mental Health">Adult ‚Äî Mental Health</option>
          <option value="Adult|Trauma">Adult ‚Äî Trauma</option>
          <option value="Adult|Environment">Adult ‚Äî Environment</option>
          <option value="Adult|Toxicology">Adult ‚Äî Toxicology</option>
        </optgroup>
        <optgroup label="Paediatric">
          <option value="Paediatric|Cardiac Arrest">Paediatric ‚Äî Cardiac Arrest</option>
          <option value="Paediatric|Airway Management">Paediatric ‚Äî Airway Management</option>
          <option value="Paediatric|Pain Relief">Paediatric ‚Äî Pain Relief</option>
          <option value="Paediatric|Respiratory">Paediatric ‚Äî Respiratory</option>
          <option value="Paediatric|Medical">Paediatric ‚Äî Medical</option>
          <option value="Paediatric|Infection">Paediatric ‚Äî Infection</option>
          <option value="Paediatric|Trauma">Paediatric ‚Äî Trauma</option>
          <option value="Paediatric|Environment">Paediatric ‚Äî Environment</option>
          <option value="Paediatric|Toxicology">Paediatric ‚Äî Toxicology</option>
        </optgroup>
        <optgroup label="Maternity">
          <option value="Maternity|Antepartum Haemorrhage">Maternity ‚Äî Antepartum Haemorrhage</option>
          <option value="Maternity|Pre-eclampsia / Eclampsia">Maternity ‚Äî Pre-eclampsia / Eclampsia</option>
          <option value="Maternity|Normal Birth">Maternity ‚Äî Normal Birth</option>
          <option value="Maternity|Breech / Compound">Maternity ‚Äî Breech / Compound</option>
          <option value="Maternity|Preterm Labour">Maternity ‚Äî Preterm Labour</option>
          <option value="Maternity|Cord Prolapse">Maternity ‚Äî Cord Prolapse</option>
          <option value="Maternity|Shoulder Dystocia">Maternity ‚Äî Shoulder Dystocia</option>
          <option value="Maternity|Primary Postpartum Haemorrhage">Maternity ‚Äî Primary PPH</option>
          <option value="Maternity|Miscarriage">Maternity ‚Äî Miscarriage</option>
        </optgroup>
        <optgroup label="Newborn">
          <option value="Newborn|Newborn Resuscitation">Newborn ‚Äî Resuscitation</option>
        </optgroup>
        <optgroup label="Treat and Refer">
          <option value="Treat and Refer|Epistaxis">Treat and Refer ‚Äî Epistaxis</option>
          <option value="Treat and Refer|Minor Burns">Treat and Refer ‚Äî Minor Burns</option>
        </optgroup></select></div>
      <div class="form-group"><label>Presentation (optional)</label><input type="text" id="gen-complaint" placeholder="e.g. chest pain, altered consciousness‚Ä¶"><div class="hint">Leave blank for a random presentation.</div></div>
      <div class="form-group"><label>Complexity</label><select id="gen-complexity"><option value="standard">Standard ‚Äî core presentation</option><option value="complex">Complex ‚Äî complication or comorbidity</option><option value="high-acuity">High acuity ‚Äî multi-system, time-critical</option></select></div>
      <div style="background:var(--blue-light);border:1px solid #AED6F1;border-radius:8px;padding:10px 14px;font-size:12px;color:#1a5276;margin-bottom:14px">
        üìã Scenarios are generated with reference to <strong>AV Clinical Practice Guidelines Version 7.1.0</strong>. AI-generated content should be independently verified against the current published edition before use in any formal assessment.
      </div>
      <button class="modal-submit-btn navy" id="generate-scenario-btn" onclick="generateAIScenario()">‚ú¶ Generate Scenario</button>
      <div id="ai-status"></div>
      <div class="save-scenario-bar" id="ai-save-bar">
        <p>‚úì Scenario generated! Save it to your permanent library?</p>
        <button class="save-btn" id="ai-save-btn" onclick="saveLastAIScenario()">üíæ Save to Library</button>
      </div>
    </div>
  </div>
</div>

<!-- Manual Create Modal -->
<div class="modal-overlay" id="create-modal">
  <div class="modal-inner">
    <div class="modal-header" style="background:var(--green)">
      <h2>‚úèÔ∏è Create Scenario</h2>
      <button class="modal-close" onclick="closeCreateModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-info">Fill in as much or as little as you like. All fields except Title and Category are optional. Custom scenarios are saved permanently to this device.</div>

      <div class="create-section-title">Basic Info</div>
      <div class="form-group"><label>Title *</label><input type="text" id="c-title" placeholder="e.g. Anaphylaxis"></div>
      <div class="form-group"><label>Subtitle</label><input type="text" id="c-subtitle" placeholder="e.g. 42yo Female ‚Äî Bee Sting"></div>
      <div class="form-group"><label>Category *</label>
        <select id="c-category">
          <optgroup label="Adult">
          <option value="Adult|Cardiac Arrest">Adult ‚Äî Cardiac Arrest</option>
          <option value="Adult|Airway Management">Adult ‚Äî Airway Management</option>
          <option value="Adult|Cardiac">Adult ‚Äî Cardiac</option>
          <option value="Adult|Pain Relief">Adult ‚Äî Pain Relief</option>
          <option value="Adult|Respiratory">Adult ‚Äî Respiratory</option>
          <option value="Adult|Medical">Adult ‚Äî Medical</option>
          <option value="Adult|Infection">Adult ‚Äî Infection</option>
          <option value="Adult|Mental Health">Adult ‚Äî Mental Health</option>
          <option value="Adult|Trauma">Adult ‚Äî Trauma</option>
          <option value="Adult|Environment">Adult ‚Äî Environment</option>
          <option value="Adult|Toxicology">Adult ‚Äî Toxicology</option>
        </optgroup>
        <optgroup label="Paediatric">
          <option value="Paediatric|Cardiac Arrest">Paediatric ‚Äî Cardiac Arrest</option>
          <option value="Paediatric|Airway Management">Paediatric ‚Äî Airway Management</option>
          <option value="Paediatric|Pain Relief">Paediatric ‚Äî Pain Relief</option>
          <option value="Paediatric|Respiratory">Paediatric ‚Äî Respiratory</option>
          <option value="Paediatric|Medical">Paediatric ‚Äî Medical</option>
          <option value="Paediatric|Infection">Paediatric ‚Äî Infection</option>
          <option value="Paediatric|Trauma">Paediatric ‚Äî Trauma</option>
          <option value="Paediatric|Environment">Paediatric ‚Äî Environment</option>
          <option value="Paediatric|Toxicology">Paediatric ‚Äî Toxicology</option>
        </optgroup>
        <optgroup label="Maternity">
          <option value="Maternity|Antepartum Haemorrhage">Maternity ‚Äî Antepartum Haemorrhage</option>
          <option value="Maternity|Pre-eclampsia / Eclampsia">Maternity ‚Äî Pre-eclampsia / Eclampsia</option>
          <option value="Maternity|Normal Birth">Maternity ‚Äî Normal Birth</option>
          <option value="Maternity|Breech / Compound">Maternity ‚Äî Breech / Compound</option>
          <option value="Maternity|Preterm Labour">Maternity ‚Äî Preterm Labour</option>
          <option value="Maternity|Cord Prolapse">Maternity ‚Äî Cord Prolapse</option>
          <option value="Maternity|Shoulder Dystocia">Maternity ‚Äî Shoulder Dystocia</option>
          <option value="Maternity|Primary Postpartum Haemorrhage">Maternity ‚Äî Primary PPH</option>
          <option value="Maternity|Miscarriage">Maternity ‚Äî Miscarriage</option>
        </optgroup>
        <optgroup label="Newborn">
          <option value="Newborn|Newborn Resuscitation">Newborn ‚Äî Resuscitation</option>
        </optgroup>
        <optgroup label="Treat and Refer">
          <option value="Treat and Refer|Epistaxis">Treat and Refer ‚Äî Epistaxis</option>
          <option value="Treat and Refer|Minor Burns">Treat and Refer ‚Äî Minor Burns</option>
        </optgroup>
        </select>
      </div>
      <div class="form-group"><label>CPG Reference</label><input type="text" id="c-cpg" placeholder="e.g. CPG A0704"></div>

      <div class="create-section-title">Dispatch & History</div>
      <div class="form-group"><label>Dispatch / Presentation</label><textarea id="c-dispatch" rows="3" placeholder="Describe the dispatch and initial presentation‚Ä¶"></textarea></div>
      <div class="form-group"><label>Key History</label><textarea id="c-keyhx" rows="2" placeholder="PMHx, medications, allergies, relevant background‚Ä¶"></textarea></div>

      <div class="create-section-title">Vitals</div>
      <div class="vitals-grid-form">
        <div class="form-group"><label>GCS</label><input type="text" id="cv-gcs" placeholder="15"></div>
        <div class="form-group"><label>SpO‚ÇÇ</label><input type="text" id="cv-spo2" placeholder="98%"></div>
        <div class="form-group"><label>RR</label><input type="text" id="cv-rr" placeholder="18/min"></div>
        <div class="form-group"><label>HR</label><input type="text" id="cv-hr" placeholder="88 bpm"></div>
        <div class="form-group"><label>BP</label><input type="text" id="cv-bp" placeholder="130/80"></div>
        <div class="form-group"><label>Temp</label><input type="text" id="cv-temp" placeholder="36.8¬∞C"></div>
        <div class="form-group"><label>BGL</label><input type="text" id="cv-bgl" placeholder="6.2 mmol/L"></div>
        <div class="form-group"><label>Rhythm</label><input type="text" id="cv-rhythm" placeholder="Sinus tachycardia"></div>
      </div>

      <div class="create-section-title">Clinical Flags</div>
      <div class="repeating-list" id="c-flags-list"></div>
      <button class="add-item-btn" onclick="addRepItem('c-flags-list','flag')">+ Add Flag</button>

      <div class="create-section-title">Differential Diagnoses</div>
      <div class="repeating-list" id="c-ddx-list"></div>
      <button class="add-item-btn" onclick="addRepItem('c-ddx-list','ddx')">+ Add DDx</button>

      <div class="create-section-title">Provisional Diagnosis</div>
      <div class="form-group"><input type="text" id="c-provisional" placeholder="e.g. Anaphylaxis ‚Äî bee sting, haemodynamically unstable"></div>

      <div class="create-section-title">Treatment / Expected Management</div>
      <div class="repeating-list" id="c-treatment-list"></div>
      <button class="add-item-btn" onclick="addRepItem('c-treatment-list','treatment')">+ Add Treatment Step</button>

      <div class="create-section-title">Knowledge Questions (up to 3)</div>
      <div id="c-kq-list"></div>
      <button class="add-item-btn" id="c-add-kq-btn" onclick="addKQBlock()">+ Add Knowledge Question</button>

      <div style="margin-top:20px">
        <button class="modal-submit-btn green" onclick="saveManualScenario()">üíæ Save to Library</button>
      </div>
    </div>
  </div>
</div>

<!-- Manage Modal -->
<div class="modal-overlay" id="manage-modal">
  <div class="modal-inner">
    <div class="modal-header" style="background:var(--purple)">
      <h2>‚öô Manage Custom Scenarios</h2>
      <button class="modal-close" onclick="closeManageModal()">‚úï</button>
    </div>
    <div class="modal-body" id="manage-modal-body">
    </div>
  </div>
</div>

<!-- Edit Scenario Modal -->
<div class="modal-overlay" id="edit-modal">
  <div class="modal-inner">
    <div class="modal-header" style="background:var(--amber)">
      <h2>‚úèÔ∏è Edit Scenario</h2>
      <button class="modal-close" onclick="closeEditModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-info">Editing a built-in scenario saves your changes permanently to this device. The original is preserved ‚Äî your edits override it for you only.</div>

      <div class="create-section-title">Basic Info</div>
      <div class="form-group"><label>Title</label><input type="text" id="e-title"></div>
      <div class="form-group"><label>Subtitle</label><input type="text" id="e-subtitle"></div>
      <div class="form-group"><label>Category</label>
        <select id="e-category">
          <optgroup label="Adult">
          <option value="Adult|Cardiac Arrest">Adult ‚Äî Cardiac Arrest</option>
          <option value="Adult|Airway Management">Adult ‚Äî Airway Management</option>
          <option value="Adult|Cardiac">Adult ‚Äî Cardiac</option>
          <option value="Adult|Pain Relief">Adult ‚Äî Pain Relief</option>
          <option value="Adult|Respiratory">Adult ‚Äî Respiratory</option>
          <option value="Adult|Medical">Adult ‚Äî Medical</option>
          <option value="Adult|Infection">Adult ‚Äî Infection</option>
          <option value="Adult|Mental Health">Adult ‚Äî Mental Health</option>
          <option value="Adult|Trauma">Adult ‚Äî Trauma</option>
          <option value="Adult|Environment">Adult ‚Äî Environment</option>
          <option value="Adult|Toxicology">Adult ‚Äî Toxicology</option>
        </optgroup>
        <optgroup label="Paediatric">
          <option value="Paediatric|Cardiac Arrest">Paediatric ‚Äî Cardiac Arrest</option>
          <option value="Paediatric|Airway Management">Paediatric ‚Äî Airway Management</option>
          <option value="Paediatric|Pain Relief">Paediatric ‚Äî Pain Relief</option>
          <option value="Paediatric|Respiratory">Paediatric ‚Äî Respiratory</option>
          <option value="Paediatric|Medical">Paediatric ‚Äî Medical</option>
          <option value="Paediatric|Infection">Paediatric ‚Äî Infection</option>
          <option value="Paediatric|Trauma">Paediatric ‚Äî Trauma</option>
          <option value="Paediatric|Environment">Paediatric ‚Äî Environment</option>
          <option value="Paediatric|Toxicology">Paediatric ‚Äî Toxicology</option>
        </optgroup>
        <optgroup label="Maternity">
          <option value="Maternity|Antepartum Haemorrhage">Maternity ‚Äî Antepartum Haemorrhage</option>
          <option value="Maternity|Pre-eclampsia / Eclampsia">Maternity ‚Äî Pre-eclampsia / Eclampsia</option>
          <option value="Maternity|Normal Birth">Maternity ‚Äî Normal Birth</option>
          <option value="Maternity|Breech / Compound">Maternity ‚Äî Breech / Compound</option>
          <option value="Maternity|Preterm Labour">Maternity ‚Äî Preterm Labour</option>
          <option value="Maternity|Cord Prolapse">Maternity ‚Äî Cord Prolapse</option>
          <option value="Maternity|Shoulder Dystocia">Maternity ‚Äî Shoulder Dystocia</option>
          <option value="Maternity|Primary Postpartum Haemorrhage">Maternity ‚Äî Primary PPH</option>
          <option value="Maternity|Miscarriage">Maternity ‚Äî Miscarriage</option>
        </optgroup>
        <optgroup label="Newborn">
          <option value="Newborn|Newborn Resuscitation">Newborn ‚Äî Resuscitation</option>
        </optgroup>
        <optgroup label="Treat and Refer">
          <option value="Treat and Refer|Epistaxis">Treat and Refer ‚Äî Epistaxis</option>
          <option value="Treat and Refer|Minor Burns">Treat and Refer ‚Äî Minor Burns</option>
        </optgroup>
        </select>
      </div>
      <div class="form-group"><label>CPG Reference</label><input type="text" id="e-cpg"></div>

      <div class="create-section-title">Dispatch & History</div>
      <div class="form-group"><label>Dispatch / Presentation</label><textarea id="e-dispatch" rows="3"></textarea></div>
      <div class="form-group"><label>Key History</label><textarea id="e-keyhx" rows="2"></textarea></div>

      <div class="create-section-title">Vitals</div>
      <div class="vitals-grid-form">
        <div class="form-group"><label>GCS</label><input type="text" id="ev-gcs"></div>
        <div class="form-group"><label>SpO‚ÇÇ</label><input type="text" id="ev-spo2"></div>
        <div class="form-group"><label>RR</label><input type="text" id="ev-rr"></div>
        <div class="form-group"><label>HR</label><input type="text" id="ev-hr"></div>
        <div class="form-group"><label>BP</label><input type="text" id="ev-bp"></div>
        <div class="form-group"><label>Temp</label><input type="text" id="ev-temp"></div>
        <div class="form-group"><label>BGL</label><input type="text" id="ev-bgl"></div>
        <div class="form-group"><label>Rhythm</label><input type="text" id="ev-rhythm"></div>
      </div>

      <div class="create-section-title">Clinical Flags</div>
      <div class="repeating-list" id="e-flags-list"></div>
      <button class="add-item-btn" onclick="addRepItemTo('e-flags-list','flag')">+ Add Flag</button>

      <div class="create-section-title">Differential Diagnoses</div>
      <div class="repeating-list" id="e-ddx-list"></div>
      <button class="add-item-btn" onclick="addRepItemTo('e-ddx-list','ddx')">+ Add DDx</button>

      <div class="create-section-title">Provisional Diagnosis</div>
      <div class="form-group"><input type="text" id="e-provisional"></div>

      <div class="create-section-title">Treatment / Expected Management</div>
      <div class="repeating-list" id="e-treatment-list"></div>
      <button class="add-item-btn" onclick="addRepItemTo('e-treatment-list','treatment')">+ Add Treatment Step</button>

      <div class="create-section-title">Knowledge Questions (up to 3)</div>
      <div id="e-kq-list"></div>
      <button class="add-item-btn" id="e-add-kq-btn" onclick="addEditKQBlock()">+ Add Knowledge Question</button>

      <div style="display:flex;gap:10px;margin-top:20px">
        <button class="modal-submit-btn amber" style="flex:1" onclick="saveEditedScenario()">üíæ Save Changes</button>
        <button class="modal-submit-btn" style="flex:0 0 auto;background:var(--red-light);color:var(--red);border:1px solid #F5B7B1" onclick="revertScenarioEdits()">‚Ü∫ Revert to Original</button>
      </div>
    </div>
  </div>
</div>

<!-- Site Footer -->
<footer id="site-footer">
  <div class="footer-inner">
    <p><strong>Clinical Content Notice:</strong> The clinical scenarios, drug doses, CPG references, and assessment criteria contained in this tool are based on <strong>Ambulance Victoria Clinical Practice Guidelines (CPGs) Version 7.1.0</strong>. Clinical content derived from AV CPGs remains the intellectual property of Ambulance Victoria. This tool reproduces CPG-based clinical content for educational and assessment purposes only. AV CPGs are publicly available documents intended to guide clinical practice; reproduction of scenario-based educational content derived from these guidelines is undertaken in good faith for non-commercial training use.</p>
    <hr>
    <p><strong>Tool Design &amp; Purpose &copy; 2026 Tim Pearson.</strong> The design, structure, user interface, assessment framework, scoring methodology, and overall concept of this tool ‚Äî including the digital adaptation of AV verbal scenario assessment processes, the RABCDE-based checklist format, the three-section scoring system, and the AI-assisted scenario generation feature ‚Äî are original works. Unauthorised reproduction, redistribution, or commercial use of the tool design is prohibited.</p>
    <hr>
    <p>This tool is <strong>not affiliated with, endorsed by, or approved by Ambulance Victoria</strong>. It is an independent educational aid. All clinical content should be verified against current official AV CPGs before use in formal assessment. &nbsp;|&nbsp; <strong>v0.9-beta</strong> &nbsp;|&nbsp; Built for ALS Level C/D verbal scenario assessment</p>
  </div>
</footer>

<!-- Disclaimer Modal -->
<div class="modal-overlay" id="disclaimer-modal" style="z-index:1000;align-items:center">
  <div class="modal-inner" style="max-width:480px;border-radius:16px;overflow:hidden">
    <div style="background:var(--amber);padding:20px 24px;display:flex;align-items:center;gap:12px">
      <div style="font-size:28px;flex-shrink:0">‚ö†Ô∏è</div>
      <div>
        <div style="color:white;font-size:16px;font-weight:800;line-height:1.2">Not an Official AV Product</div>
        <div style="color:rgba(255,255,255,0.8);font-size:12px;margin-top:2px">Please read before continuing</div>
      </div>
    </div>
    <div style="padding:24px">
      <p style="font-size:14px;line-height:1.7;color:var(--text);margin-bottom:16px">
        This tool was built using AI and is <strong>not affiliated with, endorsed by, or approved by Ambulance Victoria</strong>.
      </p>
      <p style="font-size:14px;line-height:1.7;color:var(--text);margin-bottom:16px">
        Clinical content is based on AV CPGs but <strong>may contain errors, omissions, or outdated information</strong>. It should be used as a study and assessment aid only ‚Äî never as a substitute for official AV documentation, CPGs, or clinical judgement.
      </p>
      <p style="font-size:14px;line-height:1.7;color:var(--text);margin-bottom:20px">
        Always verify drug doses, clinical criteria, and management steps against current official AV CPGs before use.
      </p>
      <div style="background:var(--amber-light);border:1px solid #F5CBA7;border-radius:8px;padding:12px 14px;margin-bottom:20px">
        <p style="font-size:12px;color:#7D6608;font-weight:600;line-height:1.5">By continuing, you acknowledge this tool is unofficial and may contain inaccuracies.</p>
      </div>
      <div style="display:flex;gap:10px">
        <button onclick="acceptDisclaimer()" style="flex:1;padding:14px;background:var(--navy);color:white;border:none;border-radius:10px;font-weight:700;font-size:14px;cursor:pointer;min-height:48px">I understand ‚Äî continue</button>
      </div>
      <div style="margin-top:12px;display:flex;align-items:center;gap:8px">
        <input type="checkbox" id="disclaimer-dont-show" style="width:18px;height:18px;cursor:pointer;accent-color:var(--navy)">
        <label for="disclaimer-dont-show" style="font-size:12px;color:var(--grey);cursor:pointer">Don't show this again on this device</label>
      </div>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
const SCENARIOS = [

// ============================================================
// ADULT MEDICAL (12 scenarios)
// ============================================================
{
  id: 1, category: "Adult", subcategory: "Cardiac", type: "medical",
  title: "STEMI", subtitle: "64yo Male ‚Äî Chest Pain",
  cpg: "CPG A0401", level: "C/D",
  dispatch: "Responded to a private residence in Sunbury. 64-year-old male, onset of severe central chest pain 45 minutes ago, radiating to left arm and jaw. Diaphoretic. Wife called 000. Patient conscious.",
  vitals: { GCS:15, SpO2:"97%", RR:"20/min", HR:"88 bpm", BP:"138/86", Temp:"36.8¬∞C", BGL:"7.1 mmol/L", Rhythm:"ST elevation leads II,III,aVF" },
  key_hx: "Hypertension, hypercholesterolaemia. On ramipril, atorvastatin. No Aspirin allergy. No PDE5 inhibitors.",
  flags: ["Inferior STEMI ‚Äî right ventricular involvement risk", "GTN caution with inferior STEMI if BP <160 mmHg", "No PDE5 inhibitors confirmed ‚Äî GTN safe", "Time critical ‚Äî pre-notify receiving hospital"],
  ddx: ["STEMI (primary)", "NSTEMI / Unstable Angina", "Aortic dissection", "Pulmonary embolism"],
  provisional: "STEMI ‚Äî Inferior (Leads II, III, aVF)",
  treatment: [
    "Aspirin 300mg oral ‚Äî chew and swallow",
    "GTN 300-600mcg SL ‚Äî caution with inferior STEMI, ensure BP >100 mmHg, reassess",
    "IV access",
    "Pain management ‚Äî Morphine/Fentanyl if not adequate with GTN",
    "O2 only if SpO2 <94% (hyperoxaemia detrimental in STEMI)",
    "12-lead ECG ‚Äî document and transmit/share",
    "Cardiac monitoring continuous",
    "Nausea/vomiting ‚Äî Ondansetron if required",
    "Pre-notify receiving hospital (PCI capable) ‚Äî Code Crimson",
    "Position of comfort ‚Äî avoid unnecessary exertion",
    "Consider MICA escalation"
  ],
  kq: [
    { q: "Why is high-flow oxygen NOT routinely indicated in this patient with STEMI and SpO2 of 97%?", max: 2, answer: "Hyperoxaemia (SpO2 >98%) is detrimental in STEMI. It causes coronary vasoconstriction and increases infarct size. O2 therapy should only be administered if SpO2 <94% as per CPG A0001. The goal is normoxia, not hyperoxia." },
    { q: "What are the contraindications to GTN in this patient, and why is inferior STEMI a special consideration?", max: 2, answer: "GTN is contraindicated if: BP <100mmHg, HR >150 or <50, PDE5 inhibitors used, VT, or bleeding in pregnancy. Inferior STEMI (II,III,aVF) may indicate RV involvement ‚Äî RV is preload dependent and GTN's venodilation can precipitate severe hypotension. Use cautiously if SBP <160mmHg in this context." },
    { q: "What is the pre-notification you would give to the receiving hospital?", max: 1, answer: "Code Crimson notification: Crew ID, 64yo male, STEMI (inferior leads), vitals, interventions to date, ETA. This allows activation of the cath lab and PCI team prior to arrival ‚Äî time is myocardium." }
  ]
},

{
  id: 2, category: "Adult", subcategory: "Medical", type: "medical",
  title: "Anaphylaxis", subtitle: "56yo Male ‚Äî Bee Sting",
  cpg: "CPG A0704", level: "C/D",
  dispatch: "Response to a private residence in Kew. 56-year-old male, known bee allergy, stung in the garden approximately 15 minutes ago. Patient reports throat tightening and difficulty breathing. Wife called 000. Patient is conscious.",
  vitals: { GCS:15, SpO2:"93%", RR:"24/min", HR:"118 bpm", BP:"88/50", Temp:"37.0¬∞C", BGL:"6.2 mmol/L", Rhythm:"Sinus tachycardia" },
  key_hx: "Hypertension on Metoprolol (beta-blocker). Known bee allergy. Has Epipen ‚Äî did not use.",
  flags: ["Beta-blocker on board ‚Äî attenuated Adrenaline response", "Hypotension BP <90 ‚Äî refractory anaphylaxis risk", "Respiratory symptoms + skin + CVS + GI = all 4 systems involved", "MICA escalation criteria met"],
  ddx: ["Anaphylaxis (primary)", "Severe asthma", "Vasovagal", "Hereditary angioedema"],
  provisional: "Anaphylaxis ‚Äî multi-system, bee sting",
  treatment: [
    "Adrenaline 0.5mg (500mcg) IM ‚Äî anterolateral mid-thigh ‚Äî IMMEDIATE, no delay",
    "Position supine with legs elevated (hypotension) ‚Äî unless respiratory distress dictates sitting",
    "O2 high flow via NRB if SpO2 <94%",
    "IV access",
    "IV Normal Saline bolus ‚Äî hypotension (BP <90)",
    "Repeat Adrenaline IM at 5 min if no response",
    "Consider Glucagon ‚Äî patient on beta-blocker, remains hypotensive after 2x Adrenaline",
    "Salbutamol + Ipratropium + Dexamethasone if bronchospasm persists (ONLY after Adrenaline)",
    "Bring patient's Epipen to hospital",
    "Transport ALL anaphylaxis patients ‚Äî minimum 4 hours observation (biphasic risk ~20%)",
    "MICA escalation ‚Äî risk factors: beta-blocker, BP <90, respiratory symptoms"
  ],
  kq: [
    { q: "This patient is on Metoprolol. How does this affect your management and what additional medication should you consider?", max: 2, answer: "Beta-blockers blunt the beta-mediated bronchodilation and positive chronotropy/inotropy of Adrenaline. Patient may have refractory anaphylaxis. Consider Glucagon after 2 doses of Adrenaline fail ‚Äî Glucagon has beta-receptor independent inotropic and bronchospastic effects. Continue Adrenaline ‚Äî Glucagon must not delay it." },
    { q: "The patient improves (BP 105/70, breathing better) but reports shaking, nausea and HR is now 135. How do you interpret this and what is your next step?", max: 2, answer: "This is Adrenaline toxicity ‚Äî clinical improvement (BP, breathing) with nausea, tremor, tachycardia. Do NOT give further Adrenaline routinely. Monitor for deterioration. Transport to hospital for minimum 4 hours (biphasic reaction in ~20% of cases). Bring Epipen to hospital." },
    { q: "Why must all anaphylaxis patients be transported to hospital even if fully recovered?", max: 1, answer: "Biphasic anaphylaxis ‚Äî symptoms can recur hours after initial resolution without further allergen exposure, occurring in approximately 20% of cases. Minimum 4 hours hospital observation required to detect and treat biphasic reaction." }
  ]
},

{
  id: 3, category: "Adult", subcategory: "Medical", type: "medical",
  title: "Status Epilepticus", subtitle: "28yo Female ‚Äî Ongoing Seizure",
  cpg: "CPG A0703", level: "C/D",
  dispatch: "Urgent response to a share house in Fitzroy. 28-year-old female found seizing by housemates. Known epilepsy. Seizing continuously for approximately 8 minutes prior to your arrival. Patient still actively seizing on your arrival.",
  vitals: { GCS:"3 (seizing)", SpO2:"88% (seizing)", RR:"Irregular", HR:"122 bpm", BP:"148/92", Temp:"37.4¬∞C", BGL:"5.6 mmol/L", Rhythm:"Sinus tachycardia" },
  key_hx: "Known epilepsy on Levetiracetam (Keppra). No known allergies. Lives alone with housemates. History of breakthrough seizures if misses medication.",
  flags: ["Convulsive Status Epilepticus ‚Äî >5 min continuous seizure", "SpO2 88% ‚Äî airway/oxygenation at risk", "Rapid control is the priority ‚Äî underdosing is a common failure", "Providing additional doses beyond 2x Midazolam unlikely to provide benefit"],
  ddx: ["Status epilepticus ‚Äî breakthrough (epilepsy)", "Hypoglycaemia-induced seizure", "Drug toxicity / withdrawal", "Intracranial pathology"],
  provisional: "Convulsive Status Epilepticus",
  treatment: [
    "Scene safety ‚Äî uncapped sharps risk from bystander emergency meds",
    "Airway management concurrent with seizure termination",
    "Position ‚Äî left lateral/recovery if able",
    "High flow O2 ‚Äî maintain SpO2",
    "BGL ‚Äî check immediately (5.6 confirmed, not hypoglycaemia)",
    "Midazolam IM (if no IV) ‚Äî weight-based. For 60kg patient: 10mg IM. Or IV: 0.1mg/kg IV",
    "IV access ‚Äî attempt during or after first dose",
    "Second dose Midazolam if seizure continues after 5 min",
    "Do NOT give >2 doses Midazolam without AV Clinician consult",
    "Levetiracetam infusion if required ‚Äî 60mg/kg IV (max 4500mg) over 5 min",
    "Protect from injury ‚Äî do NOT restrain, do NOT put anything in mouth",
    "Document: onset time, duration, character, post-ictal state",
    "MICA escalation if refractory"
  ],
  kq: [
    { q: "What is the definition of convulsive status epilepticus and why is rapid termination critical?", max: 2, answer: "CSE is continuous seizure activity with motor symptoms and impaired consciousness for ‚â•5 minutes, or repeated seizures with no return to baseline. Rapid termination is critical because: it becomes progressively harder to treat the longer it continues; neuronal injury occurs; hypoxia worsens; systemic complications accumulate. Underdosing is a common clinical failure." },
    { q: "The patient continues to seize after two doses of Midazolam. What is your next step?", max: 2, answer: "Beyond 2 doses of Midazolam, additional doses are unlikely to provide benefit and increase adverse risk (respiratory depression). Consult AV Medical Advisor via AV Clinician. Levetiracetam infusion: 60mg/kg IV over 5 minutes (max 4500mg). Ensure airway and ventilation supported. MICA escalation." },
    { q: "Name three potential underlying causes of a first seizure or breakthrough seizure in a known epileptic that you must consider.", max: 1, answer: "Missed medication/non-compliance; hypoglycaemia; metabolic derangements (hyponatraemia); drugs/alcohol withdrawal; intracranial pathology (new lesion, bleed); infection/fever; eclampsia (if pregnant)." }
  ]
},

{
  id: 4, category: "Adult", subcategory: "Medical", type: "medical",
  title: "Hypoglycaemia", subtitle: "52yo Male ‚Äî Altered Consciousness",
  cpg: "CPG A0702", level: "C/D",
  dispatch: "Response to a workplace in Dandenong. 52-year-old male Type 1 diabetic, found unresponsive at his desk by a colleague. Insulin-dependent. Last seen well 2 hours ago. Patient is not responding to voice.",
  vitals: { GCS:"8 (E2V2M4)", SpO2:"97%", RR:"16/min", HR:"108 bpm", BP:"134/78", Temp:"36.6¬∞C", BGL:"1.8 mmol/L", Rhythm:"Sinus tachycardia" },
  key_hx: "Type 1 Diabetes. Insulin pump user. Colleague reports he skipped lunch. No other known medical history.",
  flags: ["BGL 1.8 ‚Äî severe hypoglycaemia", "GCS 8 ‚Äî unsuitable for oral intake", "Insulin pump in situ ‚Äî do NOT disconnect", "Requires IV Dextrose 10% as first line"],
  ddx: ["Severe hypoglycaemia (primary)", "Stroke / TIA", "Seizure postictal state", "Drug/alcohol intoxication"],
  provisional: "Severe hypoglycaemia ‚Äî Type 1 Diabetes",
  treatment: [
    "IV access immediately",
    "Dextrose 10% IV ‚Äî 100-250mL (25g) IV bolus ‚Äî first line for altered consciousness",
    "Do NOT give oral glucose ‚Äî GCS 8, unsafe airway protection",
    "Do NOT disconnect insulin pump",
    "Reassess BGL at 5 minutes",
    "Repeat Dextrose 10% if BGL does not improve to >4 mmol/L or conscious state does not improve",
    "If IV access fails ‚Äî Glucagon 1mg IM",
    "O2 as per CPG A0001",
    "Airway management if GCS deteriorates",
    "Monitor: BGL every 5-10 min, conscious state trends",
    "Disposition: requires hospital (>2 doses IV dextrose, T1DM, insulin pump, unknown cause)",
    "Provide snack once conscious and able to swallow safely"
  ],
  kq: [
    { q: "Why is Glucagon considered second line (after IV Dextrose) in adults with severe hypoglycaemia?", max: 2, answer: "IV Dextrose 10% is first-line in adults as it provides rapid, reliable, and quantifiable glucose replacement. Glucagon is second line because: it requires glycogen stores to be effective (depleted in starvation, chronic hypoglycaemia, alcohol); it causes nausea/vomiting; it has slower onset. Use Glucagon only if IV access cannot be obtained." },
    { q: "This patient has an insulin pump. What are two important considerations regarding the pump during management?", max: 2, answer: "1. Do NOT disconnect the pump ‚Äî Type 1 diabetics on pumps have no long-acting insulin; cessation causes rapid hyperglycaemia/DKA. 2. The pump doesn't need to be adjusted in the acute setting ‚Äî hypoglycaemia will respond to dextrose therapy. Follow the patient's management plan if available." },
    { q: "After two doses of IV Dextrose 10%, BGL is now 7.2 mmol/L and GCS is 15. The patient feels well and wants to refuse transport. What do you advise?", max: 1, answer: "This patient should be transported. Criteria for transport include: T1DM, insulin pump, required >2 doses IV dextrose. The cause of the episode needs investigation. Provide safety netting. Document capacity and refusal if they still decline." }
  ]
},

{
  id: 5, category: "Adult", subcategory: "Respiratory", type: "medical",
  title: "Acute Asthma", subtitle: "34yo Female ‚Äî Severe Exacerbation",
  cpg: "CPG A0601", level: "C/D",
  dispatch: "Urgent response to an apartment in St Kilda. 34-year-old female with known asthma, acute shortness of breath for 1 hour, not responding to her own puffer. Housemate called 000. Patient is conscious.",
  vitals: { GCS:14, SpO2:"89%", RR:"32/min", HR:"128 bpm", BP:"124/76", Temp:"37.1¬∞C", BGL:"5.8 mmol/L", Rhythm:"Sinus tachycardia" },
  key_hx: "Asthma diagnosed age 12. Previous ICU admission 2 years ago. Used own Ventolin puffer 12 times in last hour. On Seretide preventer (not taken today). No allergies. Non-smoker.",
  flags: ["SpO2 89% ‚Äî severe/life-threatening", "Previous ICU admission ‚Äî high risk LTA", "Silent chest on auscultation ‚Äî imminent respiratory arrest", "12 puffs own puffer ‚Äî inadequate bronchodilation"],
  ddx: ["Severe/Life-threatening asthma (primary)", "Anaphylaxis (consider ‚Äî no skin signs, known asthma trigger?)", "COPD exacerbation", "Pulmonary embolism"],
  provisional: "Severe/Life-threatening Asthma",
  treatment: [
    "Salbutamol pMDI 4-12 puffs via spacer ‚Äî titrate to response (min effective dose)",
    "O2 ‚Äî maintain SpO2 94-98% via nasal cannulae during pMDI",
    "Ipratropium Bromide pMDI up to 8 puffs if prescribed/available",
    "Dexamethasone ‚Äî reduce airway inflammation (all but mildest presentations)",
    "IV access",
    "Consider NIV (CPAP/BiPAP) if inadequate response to bronchodilators",
    "Parenteral Adrenaline IM if unable to inhale adequately (patient cannot use pMDI effectively)",
    "Consider Magnesium Sulfate ‚Äî severe/life-threatening (MICA or consult)",
    "Position upright ‚Äî tripod position",
    "Continuous monitoring ‚Äî watch for 'bradying down' (cardiac arrest imminent)",
    "MICA escalation ‚Äî previous ICU admission, SpO2 89%, life-threatening features",
    "Pre-notify receiving hospital"
  ],
  kq: [
    { q: "Why is a 'silent chest' on auscultation a particularly ominous finding in severe asthma?", max: 2, answer: "A silent chest (absent wheeze) in a patient with acute asthma does NOT mean improvement ‚Äî it means there is insufficient airflow to generate a wheeze. It indicates critical airflow obstruction and is a sign of impending respiratory arrest. This patient requires immediate escalation of treatment ‚Äî likely parenteral bronchodilators and preparation for intubation." },
    { q: "This patient has used her Ventolin 12 times in the last hour. What does this tell you about her risk profile and how does it influence your management?", max: 2, answer: "Frequent reliever use (>6 puffs/day average, ‚â•12 canisters/year) is a risk factor for life-threatening asthma. Additionally, 12 puffs in one hour without response indicates severe bronchospasm with likely mucus plugging ‚Äî pMDI alone is less effective. Consider nebulised delivery, parenteral Adrenaline if inadequate ventilatory effort, NIV, and early MICA escalation. Previous ICU admission further elevates risk." },
    { q: "When is parenteral (IM) Adrenaline indicated in the management of acute asthma?", max: 1, answer: "Parenteral Adrenaline IM is indicated when the patient cannot adequately inhale a bronchodilator ‚Äî i.e. those without adequate ventilation. It should NOT replace inhaled bronchodilators when the patient can inhale effectively. Also indicated if anaphylaxis is suspected as a trigger." }
  ]
},

{
  id: 6, category: "Adult", subcategory: "Medical", type: "medical",
  title: "Suspected Stroke (MASS+)", subtitle: "71yo Female ‚Äî Facial Droop & Arm Weakness",
  cpg: "CPG A0711", level: "C/D",
  dispatch: "Response to a residential aged care facility in Heidelberg. 71-year-old female, sudden onset right-sided facial droop and right arm weakness, first noted by staff 40 minutes ago. She was last seen well 50 minutes ago. RACF staff are present.",
  vitals: { GCS:13, SpO2:"96%", RR:"18/min", HR:"88 bpm irregular", BP:"178/96", Temp:"36.9¬∞C", BGL:"6.4 mmol/L", Rhythm:"Atrial Fibrillation" },
  key_hx: "Known AF (not anticoagulated). Hypertension. On amlodipine. Lives in RACF for falls risk. No known allergies. Last seen well 50 min ago.",
  flags: ["MASS positive ‚Äî time critical, potential thrombolysis/ECR candidate", "Symptom onset 50 min ago ‚Äî within thrombolysis window", "Known AF ‚Äî cardioembolic stroke risk", "Not anticoagulated ‚Äî thrombolysis more likely eligible", "Atrial Fibrillation on monitor ‚Äî note for hospital"],
  ddx: ["Ischaemic stroke (primary ‚Äî cardioembolic)", "Haemorrhagic stroke / ICH", "TIA", "Todd's paralysis post-seizure", "Hypoglycaemia (excluded ‚Äî BGL 6.4)"],
  provisional: "Suspected Ischaemic Stroke ‚Äî MASS positive",
  treatment: [
    "ACT-FAST / MASS assessment ‚Äî document all findings with timestamps",
    "Note symptom onset time (last seen well) ‚Äî 50 min ago",
    "Do NOT give Aspirin ‚Äî possible haemorrhagic stroke until imaging confirms",
    "IV access ‚Äî do NOT delay transport for IV",
    "O2 only if SpO2 <94%",
    "Maintain BP (do NOT aggressively lower ‚Äî cerebral perfusion pressure dependent)",
    "BSL confirmed ‚Äî not hypoglycaemia",
    "Nausea ‚Äî Ondansetron if required",
    "Position semi-recumbent, head midline",
    "Opioid analgesia with caution ‚Äî risk of deterioration in conscious state",
    "Pre-notify receiving stroke hospital ‚Äî Code Stroke (include MASS findings, onset time, NIHSS if trained)",
    "Transport with priority ‚Äî time is brain",
    "Consider ECR eligibility (MASS positive)"
  ],
  kq: [
    { q: "Why must you NOT administer Aspirin to this patient despite your provisional diagnosis of ischaemic stroke?", max: 2, answer: "Ischaemic stroke and intracranial haemorrhage (ICH) are clinically indistinguishable without CT imaging. Approximately 15-20% of strokes are haemorrhagic. Aspirin in an ICH patient would worsen bleeding and be potentially fatal. Aspirin is NOT administered until haemorrhagic stroke has been excluded by CT at hospital." },
    { q: "The patient's blood pressure is 178/96. Should you aggressively lower this prehospital? Justify your answer.", max: 2, answer: "No. Elevated BP in acute ischaemic stroke is a compensatory mechanism to maintain cerebral perfusion pressure (CPP) around the ischaemic penumbra. Aggressive prehospital BP reduction can extend infarct size. BP management is guided by the receiving hospital/stroke team. Prehospital treatment of hypertension in stroke is NOT standard ALS practice ‚Äî only treat if causing other acute harm (e.g. hypertensive emergency with end-organ effects)." },
    { q: "What information must you relay in your pre-notification to the receiving stroke hospital?", max: 1, answer: "Crew ID, patient age/sex, MASS findings (face, arm, speech, time), symptom onset time (last seen well = 50 min ago), current GCS/neuro status, vitals, relevant history (AF, not anticoagulated), interventions, ETA. This allows activation of stroke team and pre-ordering CT prior to arrival." }
  ]
},

{
  id: 7, category: "Adult", subcategory: "Cardiac", type: "medical",
  title: "Cardiogenic Pulmonary Oedema", subtitle: "78yo Male ‚Äî Acute SOB",
  cpg: "CPG A0406", level: "C/D",
  dispatch: "Response to a private residence in Brighton. 78-year-old male with known heart failure, acute onset severe shortness of breath, woke from sleep 1 hour ago unable to breathe lying flat. Wife called 000.",
  vitals: { GCS:14, SpO2:"84%", RR:"34/min", HR:"112 bpm", BP:"190/104", Temp:"37.0¬∞C", BGL:"7.8 mmol/L", Rhythm:"Sinus tachycardia with frequent PVCs" },
  key_hx: "Ischaemic cardiomyopathy, CCF EF 25%. On frusemide, ramipril, carvedilol. Had 'flu' last week (possible precipitant). Orthopnoea for 3 days (worsening). No allergies.",
  flags: ["SpO2 84% ‚Äî critical hypoxia, NIV indicated", "BP 190/104 ‚Äî hypertensive APO ‚Äî GTN indicated", "Bilateral fine crackles + wheeze ‚Äî cardiogenic APO", "PVCs on monitor ‚Äî watch for deterioration"],
  ddx: ["Cardiogenic Acute Pulmonary Oedema (primary)", "COPD exacerbation", "Pneumonia", "Pulmonary embolism"],
  provisional: "Cardiogenic Acute Pulmonary Oedema",
  treatment: [
    "Position upright ‚Äî sitting forward, legs dependent",
    "NIV (CPAP/BiPAP) ‚Äî primary treatment for respiratory failure in cardiogenic APO",
    "GTN SL 300-600mcg ‚Äî BP >100 mmHg, no PDE5 inhibitors confirmed. Repeat 5 min",
    "Consider GTN infusion if NIV not sufficient or persistent hypertension",
    "O2 ‚Äî high flow, titrate to SpO2 94-98%",
    "IV access ‚Äî do NOT delay NIV for IV",
    "Furosemide IV ‚Äî if signs of fluid overload (cardiogenic APO + fluid overload only)",
    "12-lead ECG ‚Äî identify precipitating ACS/arrhythmia",
    "Continuous monitoring ‚Äî BP, SpO2, RR response to NIV + GTN",
    "Pre-notify receiving hospital ‚Äî critical respiratory failure",
    "MICA escalation ‚Äî SpO2 84%, critical presentation"
  ],
  kq: [
    { q: "Why is Non-Invasive Ventilation (NIV/CPAP) the primary treatment for this patient rather than just high-flow oxygen?", max: 2, answer: "NIV provides positive end-expiratory pressure (PEEP) which: forces fluid out of alveoli back into circulation; reduces afterload (improves cardiac output); recruits atelectatic alveoli; reduces work of breathing. High-flow O2 alone does not address the underlying pathophysiology of alveolar flooding. NIV significantly reduces intubation rates and mortality in cardiogenic APO." },
    { q: "Furosemide is available and the patient has a history of heart failure. Should it be administered immediately? Why or why not?", max: 2, answer: "Furosemide is a second-line treatment in cardiogenic APO ‚Äî indicated only when signs of fluid overload are present. The priority is GTN and NIV (preload/afterload reduction). Furosemide has a slow onset of action (peak diuresis 1-2 hours) and will not provide acute benefit. It should not delay NIV or GTN. Additionally, Furosemide is NOT indicated in non-cardiogenic APO." },
    { q: "When is GTN contraindicated in this patient's presentation?", max: 1, answer: "GTN is contraindicated if: BP <100mmHg; HR >150 or <50; PDE5 inhibitors (sildenafil/tadalafil) taken within 24-48 hours; VT; bleeding in pregnancy. For this elderly patient, use lower doses (300mcg) and monitor closely as more susceptible to adverse effects." }
  ]
},

{
  id: 8, category: "Adult", subcategory: "Infection", type: "medical",
  title: "Sepsis", subtitle: "68yo Female ‚Äî Altered Consciousness + Infection",
  cpg: "CPG A0729", level: "C/D",
  dispatch: "Response to a private residence in Ringwood. 68-year-old female, 3-day history of UTI symptoms, now confused and unable to stand. Son called 000. Patient semi-conscious.",
  vitals: { GCS:12, SpO2:"93%", RR:"26/min", HR:"118 bpm", BP:"86/54", Temp:"38.9¬∞C", BGL:"5.2 mmol/L", Rhythm:"Sinus tachycardia" },
  key_hx: "Type 2 Diabetes (oral medications). Recent UTI ‚Äî not yet treated (no antibiotics). Lives alone, son lives nearby. On metformin. No allergies.",
  flags: ["qSOFA: 2+ (altered GCS, RR‚â•22, BP‚â§100) ‚Äî high sepsis risk", "BP 86/54 ‚Äî septic shock", "Temperature 38.9¬∞C + suspected UTI source", "Requires urgent IV fluid resuscitation and IV antibiotics (hospital)"],
  ddx: ["Septic shock ‚Äî urinary source (primary)", "Hypoglycaemia (excluded ‚Äî BGL 5.2)", "ACS", "Dehydration/hypovolaemia"],
  provisional: "Septic Shock ‚Äî suspected urinary source",
  treatment: [
    "IV access ‚Äî two large bore IVs",
    "IV Normal Saline or Hartmann's fluid bolus ‚Äî 500mL-1000mL for hypotension (BP 86/54)",
    "O2 ‚Äî titrate to SpO2 94-98%",
    "Temperature management ‚Äî do NOT actively cool (fever is physiological response)",
    "Continuous monitoring ‚Äî BP, HR, SpO2, conscious state trends",
    "NEWS2 score ‚Äî document for clinical picture and handover",
    "BGL monitoring ‚Äî diabetic patient",
    "Position ‚Äî supine with legs elevated if tolerated (hypotension)",
    "IV antibiotics ‚Äî hospital administration (NOT prehospital ALS scope unless specific protocol)",
    "Pre-notify receiving hospital ‚Äî septic shock, time critical",
    "MICA escalation ‚Äî septic shock criteria met",
    "Warm patient ‚Äî hypothermic patients at higher mortality risk"
  ],
  kq: [
    { q: "What is the qSOFA score and what does a score of 2 or more indicate in this patient?", max: 2, answer: "qSOFA (Quick Sequential Organ Failure Assessment) includes: SBP ‚â§100mmHg (yes), altered GCS <15 (yes), RR ‚â•22 (yes). Score of 3/3. A qSOFA of ‚â•2 in the setting of suspected infection indicates increased risk of sepsis, ICU admission and mortality. It is a clinical tool to prompt prompt prehospital resuscitation ‚Äî not a standalone diagnostic test." },
    { q: "How much IV fluid should you administer and what monitoring guides reassessment?", max: 2, answer: "Initial bolus 250-500mL Normal Saline or Hartmann's, reassess BP/HR/conscious state, repeat as required. There is no fixed maximum prehospital ‚Äî titrate to clinical response. Monitor: BP trending, HR trending, SpO2, GCS, urine output (not measurable prehospital). Avoid fluid overload (signs: SpO2 drop, respiratory deterioration). Target SBP >90 mmHg." },
    { q: "Why are IV antibiotics not within standard ALS scope prehospital, and how does this affect your role?", max: 1, answer: "IV antibiotics are MICA scope (Ceftriaxone). ALS role is supportive: IV access, fluid resuscitation, O2, monitoring, early hospital notification. Time to antibiotics is critical ‚Äî early hospital notification activates sepsis pathways and reduces time to definitive treatment. Pre-notification is a high-value ALS intervention in sepsis." }
  ]
},

{
  id: 9, category: "Adult", subcategory: "Mental Health", type: "medical",
  title: "Acute Behavioural Disturbance", subtitle: "32yo Male ‚Äî Agitated + Psychostimulant Use",
  cpg: "CPG A0708", level: "C/D",
  dispatch: "Response to a CBD nightclub in Melbourne. 32-year-old male, acutely agitated and aggressive, suspected methamphetamine use. Security staff present. Patient is combative and not responding to verbal direction.",
  vitals: { GCS:"12 (combative)", SpO2:"97%", RR:"24/min", HR:"148 bpm", BP:"168/106", Temp:"38.8¬∞C", BGL:"6.8 mmol/L", Rhythm:"Sinus tachycardia" },
  key_hx: "Unknown PMH. Friends report methamphetamine use 2-3 hours ago. No known medications. Dilated pupils bilaterally. Diaphoretic.",
  flags: ["Excited delirium features ‚Äî hyperthermia, tachycardia, agitation, diaphoresis", "Excited delirium is a medical emergency ‚Äî high mortality risk", "Psychostimulant use ‚Äî Aspirin contraindicated if BP >160 mmHg", "MICA escalation for sedation"],
  ddx: ["Acute Behavioural Disturbance ‚Äî psychostimulant (primary)", "Excited delirium syndrome", "Hypoglycaemia (excluded)", "Head injury (must consider)"],
  provisional: "Acute Behavioural Disturbance ‚Äî Suspected Excited Delirium",
  treatment: [
    "Scene safety ‚Äî crew safety primary, maintain distance until safe approach established",
    "Request police if not already present ‚Äî do NOT approach without safety",
    "De-escalation ‚Äî calm, non-threatening, clear communication",
    "Droperidol IM ‚Äî first-line sedation for moderate ABD (MICA scope in most cases ‚Äî ALS consult)",
    "Midazolam IM ‚Äî ALS may administer under consult for significant/persistent reactions",
    "Monitor temperature ‚Äî hyperthermia is a marker of excited delirium",
    "IV access when safe",
    "O2 monitoring",
    "Avoid prone restraint ‚Äî risk of positional asphyxia",
    "12-lead ECG when able ‚Äî QT prolongation risk with antipsychotics",
    "Hydration (cool environment, IV fluids if able)",
    "MICA escalation ‚Äî suspected excited delirium, temperature 38.8¬∞C",
    "Pre-notify receiving hospital ‚Äî potential excited delirium"
  ],
  kq: [
    { q: "What features in this patient suggest excited delirium and why is this a medical emergency?", max: 2, answer: "Excited delirium features: hyperthermia (38.8¬∞C), extreme agitation, tachycardia (148), hypertension, diaphoresis, altered consciousness, suspected stimulant use. It is a medical emergency because: rapid progression to cardiorespiratory arrest; high mortality without prompt sedation; associated with hyperthermia causing rhabdomyolysis, renal failure, and arrhythmias. Requires rapid cooling and sedation." },
    { q: "What are the risks of prone restraint in this patient and what position should be used?", max: 2, answer: "Prone restraint risks: positional asphyxia (impaired diaphragm movement); compounded by hyperthermia, obesity, stimulant use. This patient should be moved to a lateral or supine position as soon as safe. Police restraint protocols must also consider this risk. AV clinicians can advise on positioning." },
    { q: "As an ALS paramedic, what is your role regarding sedation in this patient?", max: 1, answer: "Droperidol is primarily MICA scope for ABD. ALS may administer Midazolam 0.5-1mg IV under AV Clinician consult for significant or persistent reactions. De-escalation, scene safety, and early MICA escalation are the primary ALS interventions. Do NOT attempt chemical sedation without consult if outside scope." }
  ]
},

{
  id: 10, category: "Adult", subcategory: "Cardiac", type: "medical",
  title: "Bradycardia", subtitle: "81yo Male ‚Äî Symptomatic Complete Heart Block",
  cpg: "CPG A0402", level: "C/D",
  dispatch: "Response to a retirement village in Werribee. 81-year-old male, found by carer slumped in chair, pale and barely conscious. HR reported as very slow on home monitor. Patient has a history of heart disease.",
  vitals: { GCS:10, SpO2:"91%", RR:"18/min", HR:"32 bpm", BP:"72/44", Temp:"36.6¬∞C", BGL:"5.9 mmol/L", Rhythm:"Complete (3rd degree) heart block ‚Äî P waves independent of QRS" },
  key_hx: "Known ischaemic heart disease, previous inferior MI. On Metoprolol, aspirin. Pacemaker implant being planned ‚Äî no device currently in situ.",
  flags: ["Complete heart block ‚Äî Atropine unlikely effective but administer", "BP 72/44 ‚Äî haemodynamically compromised", "Adrenaline infusion indicated if Atropine fails ‚Äî MICA", "Pacing (TCP) may be required ‚Äî MICA scope"],
  ddx: ["Symptomatic Complete (3rd degree) Heart Block", "High degree AV block ‚Äî type 2", "Inferior STEMI with heart block", "Medication toxicity (beta-blocker)"],
  provisional: "Symptomatic 3rd Degree (Complete) Heart Block",
  treatment: [
    "Position supine",
    "O2 ‚Äî high flow, SpO2 91%",
    "IV access ‚Äî large bore",
    "Atropine 600mcg IV ‚Äî note: unlikely effective in CHB but administer",
    "Repeat Atropine 600mcg IV if partial response (max 3000mcg total)",
    "12-lead ECG ‚Äî confirm block, identify inferior STEMI as precipitant",
    "Cardiac monitoring continuous",
    "Fluid challenge ‚Äî cautious in ischaemic heart disease",
    "Adrenaline infusion ‚Äî MICA if Atropine ineffective (1-10 mcg/min, titrate to HR)",
    "Transcutaneous pacing (TCP) ‚Äî MICA if medications fail",
    "Urgent hospital pre-notification ‚Äî time critical, pacing facility required",
    "MICA escalation ‚Äî immediate"
  ],
  kq: [
    { q: "Why is Atropine unlikely to be effective in 3rd degree (complete) heart block, yet you still administer it?", max: 2, answer: "Atropine works by blocking vagal tone on the SA node and AV node, increasing automaticity above the block. In complete heart block the escape rhythm originates below the AV node (ventricular escape) where Atropine has no effect. However, it should still be administered as: the block may not be complete; it may increase atrial rate and support haemodynamics temporarily; it is low-risk and forms part of the treatment algorithm." },
    { q: "The patient is on Metoprolol (beta-blocker). How might this be contributing and what does it change about your management?", max: 2, answer: "Metoprolol (beta-blocker) can precipitate or worsen heart block ‚Äî it slows AV conduction. This increases the likelihood of Atropine being ineffective. It reduces the heart's response to Adrenaline. Management change: consider beta-blocker toxicity as a contributing cause; Glucagon (MICA) may be beneficial; early TCP pacing more likely needed; MICA escalation priority." },
    { q: "What are the absolute indications for pacing in a patient with bradycardia?", max: 1, answer: "Transcutaneous pacing is indicated when: haemodynamically significant bradycardia fails to respond to Atropine (as in CHB); life-threatening arrhythmia is present; the patient is in extremis. In this case, BP 72/44, GCS 10, CHB with no response to Atropine = TCP indicated (MICA scope)." }
  ]
},

{
  id: 11, category: "Adult", subcategory: "Medical", type: "medical",
  title: "Syncope / Undifferentiated Collapse", subtitle: "45yo Female ‚Äî Witnessed Collapse",
  cpg: "CPG A0725", level: "C/D",
  dispatch: "Response to a shopping centre in Chadstone. 45-year-old female, collapsed in a shop, witnessed by staff. Brief LOC approximately 30 seconds. Now conscious and oriented. Denies chest pain. Reports feeling hot prior to collapse.",
  vitals: { GCS:15, SpO2:"99%", RR:"16/min", HR:"72 bpm", BP:"118/74", Temp:"36.8¬∞C", BGL:"5.4 mmol/L", Rhythm:"Normal sinus rhythm ‚Äî QTc 490ms on 12-lead" },
  key_hx: "No significant PMH. Not on any regular medications. Prolonged standing in a warm environment prior to episode. Stressful event (witnessed accident). Periods prior to collapse (nausea, visual greyout).",
  flags: ["QTc 490ms ‚Äî prolonged QT, risk of Torsades de Pointes", "Syncope workup required ‚Äî Cardiac cause must be excluded", "Prolonged QT of concern ‚Äî requires hospital assessment"],
  ddx: ["Vasovagal syncope (most likely)", "Cardiac syncope ‚Äî arrhythmia (prolonged QT)", "Orthostatic hypotension", "Seizure"],
  provisional: "Syncope ‚Äî vasovagal likely, prolonged QT requires investigation",
  treatment: [
    "12-lead ECG ‚Äî measure QTc, identify arrhythmia",
    "BGL confirmed",
    "Supine position with legs elevated during recovery",
    "IV access (consider given QT prolongation finding)",
    "Continuous cardiac monitoring",
    "Thorough history ‚Äî prodrome, duration, post-event, medications, family history (sudden death?)",
    "Post-syncope neurological examination",
    "Do NOT discharge ‚Äî prolonged QTc (490ms) warrants hospital assessment",
    "Orthostatic BP measurements",
    "Transport to hospital ‚Äî QT prolongation is a clinical flag requiring investigation",
    "Advise patient not to drive"
  ],
  kq: [
    { q: "What features help differentiate vasovagal syncope from cardiac syncope in the history?", max: 2, answer: "Vasovagal features: precipitating trigger (prolonged standing, heat, pain, stress), prodrome (nausea, diaphoresis, visual greyout/'tunnel vision'), brief LOC, full rapid recovery. Cardiac syncope features: no warning, sudden onset, exertional, occurs supine, palpitations before/after, family history of sudden death, structural heart disease, abnormal ECG (prolonged QT, WPW, LBBB). This patient has vasovagal features BUT the QTc of 490ms requires investigation." },
    { q: "The 12-lead shows a QTc of 490ms. Why is this clinically significant and what is the normal range?", max: 2, answer: "Normal QTc: <450ms (male), <460ms (female). QTc >480ms is significantly prolonged. Prolonged QT is associated with Torsades de Pointes (TdP) ‚Äî a life-threatening polymorphic VT. Causes: medications (antipsychotics, antibiotics, antiarrhythmics), electrolyte abnormalities, congenital LQTS. This patient has no documented QT-prolonging medications ‚Äî requires investigation for congenital LQTS or electrolyte cause. Do NOT discharge ‚Äî requires hospital investigation." },
    { q: "What questions in the social/family history are particularly important for this patient?", max: 1, answer: "Family history of sudden unexplained cardiac death (especially <50yo), family history of LQTS or Brugada syndrome, personal history of near-drowning episodes (arrhythmia in water = red flag for LQTS), exertional syncope in family members. A family history of sudden death + prolonged QT = likely inherited channelopathy requiring urgent cardiology review." }
  ]
},

{
  id: 12, category: "Adult", subcategory: "Toxicology", type: "medical",
  title: "Opioid Toxicity", subtitle: "26yo Male ‚Äî Unresponsive",
  cpg: "CPG A0722", level: "C/D",
  dispatch: "Response to a public toilet in Collingwood. 26-year-old male found unresponsive by passers-by. Suspected heroin use. Patient is not responding. Bystanders confirm seeing him inject approximately 20 minutes ago.",
  vitals: { GCS:"4 (E1V1M2)", SpO2:"72%", RR:"4/min", HR:"58 bpm", BP:"86/52", Temp:"35.8¬∞C", BGL:"4.8 mmol/L", Rhythm:"Sinus bradycardia" },
  key_hx: "Unknown PMH. Bystanders report regular IV heroin use. Syringe and foil present on scene. Pinpoint pupils bilaterally. Cyanotic lips.",
  flags: ["Classic opioid toxicity triad ‚Äî pinpoint pupils, respiratory depression, GCS‚Üì", "SpO2 72% ‚Äî critical, immediate BVM ventilation", "Naloxone indicated ‚Äî ALS scope", "Fentanyl analogues may require higher/repeat Naloxone doses"],
  ddx: ["Opioid toxicity ‚Äî heroin (primary)", "Polysubstance toxicity", "Hypoglycaemia (excluded ‚Äî BGL 4.8)", "Head injury / intracranial bleed"],
  provisional: "Opioid Toxicity ‚Äî suspected heroin",
  treatment: [
    "Immediate BVM ventilation ‚Äî SpO2 72%, RR 4 ‚Äî DO NOT DELAY",
    "Airway ‚Äî position, OPA if tolerated",
    "O2 ‚Äî 100% via BVM initially",
    "Naloxone IN/IM/IV ‚Äî 400mcg-800mcg IV/IM or 800mcg-2mg IN",
    "Titrate Naloxone to adequate respiratory effort ‚Äî NOT full reversal (avoid acute withdrawal, vomiting, aggression)",
    "IV access",
    "Reassess GCS and respiratory effort after Naloxone",
    "Repeat Naloxone if effect wanes ‚Äî Naloxone shorter half-life than opioids",
    "Monitor temperature ‚Äî hypothermia (35.8¬∞C)",
    "Warm patient",
    "Scene management ‚Äî safe sharps, don gloves",
    "Transport ALL opioid toxicity patients ‚Äî re-sedation risk",
    "Consider fentanyl analogue ‚Äî may require higher Naloxone doses"
  ],
  kq: [
    { q: "Why should Naloxone be titrated to adequate respiratory effort rather than full reversal of consciousness?", max: 2, answer: "Full reversal with high-dose Naloxone causes: acute opioid withdrawal (vomiting ‚Äî aspiration risk; agitation ‚Äî combative patient; patient may leave before safe); extreme distress. The clinical goal is adequate respiratory effort to maintain SpO2 without precipitating withdrawal. Titrate to RR >12/min and SpO2 >94%. Supportive ventilation (BVM) while Naloxone takes effect is preferred over high-dose bolus." },
    { q: "Why does the patient require hospital transport even after a good response to Naloxone?", max: 2, answer: "Naloxone has a shorter half-life (30-90 min) than most opioids, especially long-acting or synthetic opioids. Re-sedation is a significant risk after apparent recovery. Fentanyl analogues may require multiple or infusion doses of Naloxone. The patient requires monitoring for re-sedation, aspiration pneumonia, rhabdomyolysis, hypothermia complications. All opioid toxicity patients should be transported." },
    { q: "What three clinical features form the classic opioid toxicity triad?", max: 1, answer: "The classic opioid toxicity triad: (1) Miosis ‚Äî pinpoint pupils; (2) Respiratory depression ‚Äî reduced RR and depth; (3) Decreased conscious state (GCS). Additional features include bradycardia, hypotension, hypothermia, and cyanosis in severe cases." }
  ]
},

// ============================================================
// ADULT TRAUMA (8 scenarios)
// ============================================================
{
  id: 13, category: "Adult", subcategory: "Trauma", type: "trauma",
  title: "Traumatic Head Injury", subtitle: "19yo Male ‚Äî MVC, Unrestrained",
  cpg: "CPG A0803", level: "C/D",
  dispatch: "Urgent response to a highway in Ballarat. 19-year-old male, unrestrained driver, high speed MVC, ejected from vehicle. Bystanders report GCS was 15 initially but is now reduced. Fire crew on scene.",
  vitals: { GCS:"9 (E2V2M5 ‚Äî deteriorating from 15)", SpO2:"93%", RR:"22/min", HR:"58 bpm", BP:"178/98", Temp:"36.5¬∞C", BGL:"7.2 mmol/L", Rhythm:"Sinus bradycardia" },
  key_hx: "No PMH. Unrestrained. Ejected. Significant mechanism. Laceration to occiput. Bilateral periorbital ecchymosis (raccoon eyes). GCS deteriorating since arrival.",
  flags: ["Cushing's triad ‚Äî hypertension + bradycardia + respiratory irregularity = raised ICP", "GCS deteriorating ‚Äî critical finding, imminent herniation risk", "Cervical spine injury must be assumed", "Time critical ‚Äî MICA/neurosurgical centre", "Bilateral raccoon eyes ‚Äî base of skull fracture"],
  ddx: ["Severe TBI with raised ICP", "Extradural haematoma", "Subdural haematoma", "Diffuse axonal injury"],
  provisional: "Severe TBI ‚Äî Raised ICP / Imminent Herniation",
  treatment: [
    "C-spine ‚Äî manual immobilisation, collar application",
    "Airway management ‚Äî RSI consideration (MICA), OPA/NPA if tolerated",
    "O2 ‚Äî maintain SpO2 94-98% (NOT hyperoxia, NOT hypoxia ‚Äî both worsen outcomes)",
    "Ventilation ‚Äî avoid hyperventilation unless imminent herniation signs (ETCO2 35-40 target)",
    "IV access",
    "Fluid ‚Äî cautious, maintain CPP ‚Äî do NOT over-resuscitate",
    "Target SBP >100 mmHg (hypotension worsens TBI outcome)",
    "Do NOT give GTN or medications that lower BP",
    "Log roll ‚Äî spinal precautions",
    "Rapid extrication ‚Äî time critical, transport priority",
    "MICA escalation ‚Äî immediate, consider HEMS",
    "Pre-notify neurosurgical centre (RMH, Alfred, Austin etc.)",
    "Avoid: hypoxia, hypotension, hyperglycaemia, hyperthermia, hypercapnia"
  ],
  kq: [
    { q: "What is Cushing's triad and what does it indicate in this patient?", max: 2, answer: "Cushing's triad: hypertension + bradycardia + respiratory irregularity (Cheyne-Stokes). It is a late sign of severely raised intracranial pressure (ICP) indicating impending cerebral herniation. The brain is compensating for raised ICP by increasing systemic BP (to maintain CPP). The bradycardia is a reflex vagal response. This is a critical emergency requiring immediate neurosurgical assessment. Do NOT lower BP." },
    { q: "Why must hyperventilation be avoided in this patient, except in specific circumstances?", max: 2, answer: "Hyperventilation causes hypocapnia (low PaCO2) which causes cerebral vasoconstriction ‚Äî reducing ICP but also reducing cerebral perfusion. Chronic hyperventilation worsens ischaemia and outcome. However, brief controlled hyperventilation (ETCO2 30-35) may be used as a temporising measure only when signs of imminent herniation are present (Cushing's triad, blown pupil). Target ETCO2 35-40 normally." },
    { q: "Bilateral 'raccoon eyes' (periorbital ecchymosis) is noted. What does this suggest and what other findings are associated?", max: 1, answer: "Raccoon eyes (bilateral periorbital bruising) indicate basal skull fracture (anterior fossa). Associated signs: Battle's sign (mastoid bruising ‚Äî posterior fossa fracture), CSF rhinorrhoea/otorrhoea, haemotympanum. Implications: DO NOT insert nasopharyngeal airway (risk of intracranial placement); heightened suspicion of significant intracranial injury." }
  ]
},

{
  id: 14, category: "Adult", subcategory: "Trauma", type: "trauma",
  title: "Chest Trauma", subtitle: "55yo Male ‚Äî Industrial Crush Injury",
  cpg: "CPG A0802", level: "C/D",
  dispatch: "Response to an industrial site in Laverton. 55-year-old male, trapped between forklift and racking for approximately 5 minutes. Chest and abdominal compression. Fire crew performing extrication. GCS 14 on scene.",
  vitals: { GCS:14, SpO2:"87%", RR:"28/min", HR:"122 bpm", BP:"94/62", Temp:"36.8¬∞C", BGL:"6.6 mmol/L", Rhythm:"Sinus tachycardia" },
  key_hx: "Hypertension. On lisinopril. Visible chest wall deformity right side. Paradoxical chest wall movement right hemithorax. Decreased air entry right. Tracheal deviation to left. Absent breath sounds right.",
  flags: ["Tension pneumothorax ‚Äî tracheal deviation, absent BS, SpO2 87%, haemodynamic compromise", "Immediate needle thoracostomy / finger thoracostomy may be life-saving", "Flail chest (paradoxical movement) ‚Äî splinting and ventilatory support", "DO NOT apply airtight dressings ‚Äî can create tension pneumothorax"],
  ddx: ["Tension pneumothorax (primary ‚Äî life threatening)", "Haemothorax", "Flail chest with pulmonary contusion", "Traumatic aortic injury"],
  provisional: "Tension Pneumothorax ‚Äî Right",
  treatment: [
    "IMMEDIATE ‚Äî needle decompression right side: 2nd ICS MCL or 4th/5th ICS AAL",
    "Finger thoracostomy if needle ineffective (MICA) or confirm decompression",
    "High flow O2 immediately ‚Äî do NOT delay for other interventions",
    "Chest seals ‚Äî 3-sided vent seal to open wounds (NOT airtight)",
    "IV access ‚Äî large bore bilateral",
    "Fluid resuscitation ‚Äî hypotension: 250-500mL boluses, titrate to response",
    "Analgesia ‚Äî Morphine/Fentanyl for pain, cautious with hypotension",
    "Spinal precautions concurrent",
    "Log roll ‚Äî examine back",
    "Reassess after decompression ‚Äî SpO2, trachea, BP, air entry",
    "MICA escalation ‚Äî immediate",
    "Major trauma pre-notification ‚Äî time critical",
    "Rapid transport ‚Äî do NOT delay on scene"
  ],
  kq: [
    { q: "This patient has all the clinical signs of tension pneumothorax. List the classic signs and describe the pathophysiology.", max: 2, answer: "Classic signs: absent breath sounds (right), tracheal deviation (away from side ‚Äî to left), SpO2‚Üì, hypotension, tachycardia, raised JVP (in awake patients), respiratory distress. Pathophysiology: air enters pleural space but cannot escape (one-way valve effect). Progressive accumulation of air compresses the ipsilateral lung, shifts mediastinum (tracheal deviation), compresses contralateral lung and SVC/IVC (reducing venous return ‚Üí hypotension ‚Üí cardiac arrest if untreated). Life-threatening ‚Äî needle decompression is immediate treatment." },
    { q: "Where do you place a needle for chest decompression and why does location matter?", max: 2, answer: "Two accepted sites: (1) 2nd ICS midclavicular line (traditional) ‚Äî needle perpendicular to skin, over superior border of 3rd rib to avoid neurovascular bundle. Risk: may not reach pleural space in obese/muscular patients. (2) 4th/5th ICS anterior axillary line (now preferred by many) ‚Äî higher success rate, longer effective needle length, avoids subclavian vessels. Insert 14G IV cannula until air hisses, then remove needle, leave cannula." },
    { q: "What type of chest dressing should be applied to an open chest wound and why?", max: 1, answer: "3-sided (vented) chest seal ‚Äî allows air to escape on exhalation but prevents air entry on inhalation. An airtight dressing can convert an open pneumothorax into a tension pneumothorax by trapping air. Commercial 3-sided dressings (e.g. Asherman seal) or improvised 3-sided tape are acceptable." }
  ]
},

{
  id: 15, category: "Adult", subcategory: "Trauma", type: "trauma",
  title: "Major Trauma", subtitle: "38yo Female ‚Äî Pedestrian vs Vehicle",
  cpg: "CPG A0810", level: "C/D",
  dispatch: "Urgent response to a suburban street in Footscray. 38-year-old female pedestrian struck by vehicle at estimated 60km/h. Airbags not applicable. Patient is on the ground, conscious but distressed. Police on scene.",
  vitals: { GCS:13, SpO2:"95%", RR:"26/min", HR:"132 bpm", BP:"82/50", Temp:"36.4¬∞C", BGL:"5.8 mmol/L", Rhythm:"Sinus tachycardia" },
  key_hx: "Unknown PMH. Pedestrian impact at speed. Obvious deformity right femur (mid-shaft). Pelvic instability on gentle pressure. Open wound right thigh with active bleeding. Tender abdomen.",
  flags: ["Haemorrhagic shock ‚Äî mechanism, BP 82/50, HR 132, pelvic instability", "Do NOT compress/spring pelvis repeatedly ‚Äî 1 test only, then stabilise", "Permissive hypotension ‚Äî target SBP 80-90 for penetrating, 90 for blunt (until haemostasis)", "Femoral fracture can lose 1.5-2.5L blood into thigh alone"],
  ddx: ["Haemorrhagic shock ‚Äî pelvic/femoral (primary)", "Intraabdominal haemorrhage", "Retroperitoneal haemorrhage", "Traumatic brain injury (concurrent)"],
  provisional: "Haemorrhagic Shock ‚Äî Blunt Trauma",
  treatment: [
    "Haemorrhage control ‚Äî wound packing + tourniquet or direct pressure right thigh",
    "Pelvic binder ‚Äî pelvic instability present: apply at level of greater trochanter",
    "Traction splint ‚Äî femur fracture (right mid-shaft) AFTER pelvic binder",
    "C-spine ‚Äî manual immobilisation, collar",
    "IV access ‚Äî two large bore IVs",
    "IV fluid ‚Äî cautious: 250mL boluses to maintain SBP 90 mmHg (permissive hypotension for blunt trauma)",
    "O2 ‚Äî high flow, SpO2 95% titrate to 94-98%",
    "Analgesia ‚Äî Methoxyflurane / Fentanyl IN ‚Äî appropriate analgesic considering BP",
    "Log roll ‚Äî examine posterior",
    "Temperature management ‚Äî prevent hypothermia (lethal triad)",
    "Packaging ‚Äî scoop/KED, vacuum mattress",
    "Rapid transport ‚Äî load and go, do NOT remain on scene",
    "MICA escalation ‚Äî major trauma pre-notification to trauma centre (Alfred, RMH)"
  ],
  kq: [
    { q: "What is the 'lethal triad' in major trauma and how does prehospital management aim to prevent it?", max: 2, answer: "The lethal triad: (1) Hypothermia ‚Äî impairs clotting factors and myocardial function; (2) Acidosis ‚Äî from poor perfusion and lactate accumulation; (3) Coagulopathy ‚Äî impaired clotting, worsened by hypothermia and acidosis. Prehospital prevention: maintain warmth (blankets, heated ambulance), avoid excessive crystalloid fluids (dilutes clotting factors), control haemorrhage rapidly, minimise scene time, permissive hypotension." },
    { q: "Why is permissive hypotension (targeting SBP 80-90 mmHg) the current approach in haemorrhagic shock from blunt trauma?", max: 2, answer: "Aggressive fluid resuscitation targeting normal BP: dilutes clotting factors (coagulopathy); increases hydrostatic pressure dislodging clots; causes hypothermia (cold fluids); has not been shown to improve outcomes. Permissive hypotension maintains minimal perfusion to vital organs while limiting ongoing haemorrhage until surgical haemostasis. Target SBP 90 for blunt trauma (higher than penetrating ‚Äî 80 ‚Äî due to concurrent TBI risk)." },
    { q: "Why is the pelvic binder applied before the traction splint for the femur fracture?", max: 1, answer: "The pelvic binder compresses the fractured pelvis, reducing pelvic volume and tamponading haemorrhage (potentially 3-4L blood loss). Applying traction to the femur before the pelvic binder could distract the pelvis, increasing pelvic volume and worsening haemorrhage. Sequence: haemorrhage control ‚Üí pelvic binder ‚Üí traction splint." }
  ]
},

{
  id: 16, category: "Adult", subcategory: "Environment", type: "trauma",
  title: "Burns", subtitle: "42yo Male ‚Äî House Fire",
  cpg: "CPG A0805", level: "C/D",
  dispatch: "Response to a residential fire in Dandenong. 42-year-old male, extricated from burning house by Fire Brigade. Full thickness burns to face, chest and both arms. Eyebrows singed. Hoarse voice noted. Patient conscious.",
  vitals: { GCS:14, SpO2:"93%", RR:"24/min", HR:"116 bpm", BP:"132/84", Temp:"35.8¬∞C", BGL:"7.4 mmol/L", Rhythm:"Sinus tachycardia" },
  key_hx: "Unknown PMH. Trapped in room fire for approximately 10 minutes. Hoarse voice, singed nasal hairs, carbonaceous (sooty) sputum. Burns to face, chest, bilateral arms. Partner states he was shouting in the room (steam/hot gas inhalation likely).",
  flags: ["Inhalation injury suspected ‚Äî hoarse voice, singed nasal hairs, sooty sputum, ENCLOSED SPACE", "Airway may deteriorate rapidly with oedema ‚Äî consider EARLY intubation (MICA)", "Burns to face/neck = high airway risk", "Carbon monoxide poisoning ‚Äî high-flow O2 regardless of SpO2"],
  ddx: ["Burns with inhalation injury (primary)", "Carbon monoxide poisoning", "Cyanide toxicity (fire + synthetic materials)", "Airway burns ‚Äî laryngeal oedema"],
  provisional: "Burns ‚Äî Inhalation Injury + CO poisoning suspected",
  treatment: [
    "High flow O2 via NRB mask ‚Äî 100% O2 immediately (CO poisoning ‚Äî regardless of SpO2)",
    "Airway assessment ‚Äî note hoarseness, stridor (early MICA consult for intubation before oedema worsens)",
    "DO NOT apply wet dressings to large burns ‚Äî risk of hypothermia",
    "Cover burns with dry, non-adherent dressings or burn sheets",
    "IV access ‚Äî two large bore, preferably through unburnt skin",
    "IV fluid ‚Äî Hartmann's as per Parkland formula (MICA will manage ‚Äî notify)",
    "Analgesia ‚Äî Morphine/Fentanyl IV (burns are extremely painful)",
    "Temperature management ‚Äî hypothermia risk, warm environment",
    "BSA estimation ‚Äî rule of nines",
    "Remove jewellery, clothing from affected areas",
    "Do NOT burst blisters",
    "MICA escalation ‚Äî inhalation injury, airway risk, significant burns",
    "Pre-notify burns unit (Alfred, RCH) ‚Äî major burns"
  ],
  kq: [
    { q: "Why is 100% high-flow oxygen indicated in this patient regardless of SpO2 reading?", max: 2, answer: "CO (carbon monoxide) binds to haemoglobin with 250x greater affinity than O2, forming carboxyhaemoglobin (COHb). Standard pulse oximetry CANNOT differentiate COHb from oxyhaemoglobin ‚Äî SpO2 reads falsely normal. 100% O2 reduces the half-life of COHb from ~5 hours (room air) to ~1 hour. High-flow O2 must be administered immediately and continuously regardless of pulse oximetry readings." },
    { q: "What features in this patient suggest inhalation injury and why is early MICA escalation important for airway management?", max: 2, answer: "Inhalation injury features: hoarse voice (laryngeal oedema), singed nasal hairs and eyebrows, carbonaceous (sooty) sputum, exposure in enclosed space, facial burns. Importance of early intubation: airway oedema progresses rapidly over 2-8 hours post-burn; delayed intubation may make intubation impossible (impossible airway from oedema); early intubation while the airway is still manageable is far safer than waiting." },
    { q: "Using the 'Rule of Nines', estimate the percentage Total Body Surface Area (TBSA) burned: face, chest, and both arms.", max: 1, answer: "Rule of Nines: Head/face = 9%, Anterior trunk (chest + abdomen) = 18% (chest alone ~9%), Each arm = 9% (both arms = 18%). Estimated TBSA: face (9%) + chest (9%) + both arms (18%) = ~36% TBSA. This is a major burn requiring burns unit transfer and IV fluid resuscitation." }
  ]
},

{
  id: 17, category: "Adult", subcategory: "Trauma", type: "trauma",
  title: "Spinal Injury", subtitle: "23yo Female ‚Äî Fall from Horse",
  cpg: "CPG A0804", level: "C/D",
  dispatch: "Response to an equestrian centre in the Yarra Valley. 23-year-old female, thrown from horse and landed on her neck/back. Found by bystanders face down in arena. Reports inability to move legs. Conscious and distressed.",
  vitals: { GCS:15, SpO2:"96%", RR:"20/min", HR:"62 bpm", BP:"92/58", Temp:"36.6¬∞C", BGL:"5.5 mmol/L", Rhythm:"Sinus bradycardia" },
  key_hx: "No PMH. Horse fall from approximately 1.8m. Face down on landing. Denies head strike. Unable to move or feel legs since incident. Upper limbs moving normally. Priapism noted (significant sign).",
  flags: ["Neurogenic shock ‚Äî bradycardia + hypotension after spinal injury", "Priapism ‚Äî involuntary erection, sign of severe spinal cord injury", "C-spine/thoracic injury suspected ‚Äî complete immobilisation required", "Do NOT aggressively fluid resuscitate neurogenic shock ‚Äî different mechanism to haemorrhagic"],
  ddx: ["Spinal cord injury with neurogenic shock (primary)", "Haemorrhagic shock concurrent (must exclude)", "Incomplete spinal cord injury"],
  provisional: "Spinal Cord Injury ‚Äî Neurogenic Shock",
  treatment: [
    "C-spine ‚Äî manual immobilisation maintained throughout",
    "Log roll ‚Äî minimum 4 personnel, maintain spinal alignment",
    "Cervical collar ‚Äî appropriate size",
    "Long spinal board / scoop + head blocks + straps",
    "O2 ‚Äî titrate to SpO2 94-98%",
    "IV access",
    "IV fluid ‚Äî cautious bolus for neurogenic shock (not same as haemorrhagic) ‚Äî 250mL boluses",
    "Monitor for concurrent haemorrhage ‚Äî neurogenic shock + haemorrhage can coexist",
    "Do NOT aggressively prime the patient (risk of pulmonary oedema in neurogenic shock)",
    "Bladder ‚Äî monitor for retention",
    "Analgesia ‚Äî titrate carefully",
    "Temperature management ‚Äî loss of temperature regulation below level of injury",
    "Transport ‚Äî spinal precautions maintained",
    "MICA escalation ‚Äî SCI with neurogenic shock",
    "Pre-notify neurosurgical / spinal unit"
  ],
  kq: [
    { q: "What is neurogenic shock and how does it differ from haemorrhagic shock in assessment and management?", max: 2, answer: "Neurogenic shock occurs when loss of sympathetic tone (below the level of spinal cord injury) causes vasodilation (hypotension) and loss of compensatory tachycardia (bradycardia). Key difference from haemorrhagic shock: haemorrhagic = tachycardia + hypotension + pale/clammy; neurogenic = bradycardia + hypotension + warm/flushed below lesion. Management differs: neurogenic shock does NOT require aggressive fluid resuscitation (no volume loss ‚Äî vasodilation only); excessive fluids can cause pulmonary oedema. Vasopressors (MICA) are more appropriate." },
    { q: "What is priapism and why is it a significant clinical finding in this context?", max: 2, answer: "Priapism is an involuntary, persistent penile erection not associated with sexual stimulation. In the context of trauma, it indicates loss of sympathetic tone controlling penile vasculature ‚Äî a sign of significant spinal cord injury (typically cervical or upper thoracic). It confirms neurogenic involvement and should be documented as part of the trauma assessment. It does not require treatment but indicates the severity of the injury." },
    { q: "When performing a log roll on this patient, how many personnel are minimum and what is each person's role?", max: 1, answer: "Minimum 4 personnel: (1) Head/C-spine controller ‚Äî gives commands, maintains manual inline stabilisation, directs the log roll; (2) Shoulders; (3) Hips/pelvis; (4) Legs/feet. Additional person can place the board. Log roll is controlled, simultaneous, on the command of the head controller. The body must move as a single unit ‚Äî no twisting or segmental movement." }
  ]
},

{
  id: 18, category: "Adult", subcategory: "Cardiac Arrest", type: "trauma",
  title: "Traumatic Cardiac Arrest", subtitle: "16yo Male ‚Äî Penetrating Chest Injury",
  cpg: "CPG A0201-2", level: "C/D",
  dispatch: "Urgent response to a park in Broadmeadows. 16-year-old male, found unconscious with penetrating wound to left chest. Witness reports he collapsed approximately 3 minutes ago. No bystander CPR. Presumed stab wound.",
  vitals: { GCS:3, SpO2:"Undetectable", RR:"0/min (agonal)", HR:"0 (no palpable pulse)", BP:"Undetectable", Temp:"N/A", BGL:"N/A", Rhythm:"PEA" },
  key_hx: "Unknown PMH. 16yo male. Penetrating chest wound left anterior. Witnessed collapse 3 min ago. Stab wound suspected. Bystanders report brief respiratory effort after collapse.",
  flags: ["Traumatic cardiac arrest ‚Äî reversible causes H&T essential", "Penetrating = higher survival than blunt TCA", "Needle decompression bilateral immediately", "Scene time MUST be minimal ‚Äî surgery is the only definitive treatment"],
  ddx: ["Traumatic cardiac arrest ‚Äî penetrating (primary)", "Tension pneumothorax (must decompress immediately)", "Haemothorax", "Cardiac tamponade"],
  provisional: "Traumatic Cardiac Arrest ‚Äî Penetrating",
  treatment: [
    "CPR ‚Äî immediate high quality",
    "Needle decompression BILATERAL ‚Äî tension pneumothorax must be excluded immediately",
    "Airway ‚Äî ETT (MICA) or supraglottic airway",
    "O2 100%",
    "IV/IO access ‚Äî large bore bilateral",
    "IV fluid bolus ‚Äî 250mL NS/Hartmann's",
    "Adrenaline 1mg IV ‚Äî as per cardiac arrest CPG",
    "Identify and treat reversible causes ‚Äî Hs and Ts (Hypovolaemia, Hypoxia, Tension PTX, Tamponade)",
    "Wound ‚Äî seal penetrating chest wound (3-sided dressing)",
    "MINIMAL SCENE TIME ‚Äî transport with CPR in progress",
    "MICA escalation ‚Äî traumatic arrest",
    "Pre-notify trauma centre ‚Äî consider ED thoracotomy candidacy (penetrating, witnessed arrest, short down time)",
    "Transport time critical ‚Äî surgery is only definitive treatment"
  ],
  kq: [
    { q: "Why does penetrating traumatic cardiac arrest have better survival than blunt TCA, and what makes early hospital arrival critical?", max: 2, answer: "Penetrating TCA survival is higher because: the mechanism is often a single reversible cause (haemothorax, tension PTX, or tamponade); cardiac function may be preserved; reversible causes can be treated. Blunt TCA has multiple injuries and widespread physiological disruption with lower reversibility. Early hospital arrival is critical because: ED/surgical thoracotomy can relieve tamponade; open cardiac massage; surgical haemostasis are only available in-hospital. Scene time is the enemy ‚Äî load and go." },
    { q: "Cardiac tamponade is a possible cause of this arrest. What are the clinical signs (Beck's triad) and how is it treated prehospital?", max: 2, answer: "Beck's triad: hypotension, elevated JVP (distended neck veins), muffled heart sounds. Prehospital management: NO prehospital pericardiocentesis in standard ALS scope. Focus on CPR, bilateral decompression, rapid transport. MICA may perform emergency pericardiocentesis. Definitive treatment is surgical (thoracotomy + pericardiotomy) ‚Äî hospital." },
    { q: "What criteria would make this patient unsuitable for continued resuscitation in traumatic cardiac arrest?", max: 1, answer: "Traumatic arrest withholding/cessation criteria per CPG A0203: Blunt TCA with unwitnessed arrest and no signs of life = poor survival. Penetrating TCA with short down time (this patient ‚Äî 3 min, witnessed) = should continue. Resuscitation may be ceased if: sustained asystole despite optimised resuscitation; multiple incompatible injuries; prolonged no-flow time with no response. Consult AV Clinician." }
  ]
},

{
  id: 19, category: "Adult", subcategory: "Trauma", type: "trauma",
  title: "Elderly Fall", subtitle: "82yo Female ‚Äî Neck of Femur Fracture",
  cpg: "CPG A0808", level: "C/D",
  dispatch: "Response to a residential home in Camberwell. 82-year-old female, found on the floor by daughter, had been lying on floor approximately 8 hours. Unable to get up. Right leg shortened and externally rotated. Patient is confused.",
  vitals: { GCS:13, SpO2:"95%", RR:"18/min", HR:"106 bpm", BP:"102/66", Temp:"35.4¬∞C", BGL:"4.2 mmol/L", Rhythm:"Atrial Fibrillation" },
  key_hx: "AF on warfarin. Hypertension. Mild dementia. Lives alone. Found after 8 hours on floor. Right hip shortened + externally rotated = NOF fracture. Anticoagulated.",
  flags: ["Long lie (~8 hours) ‚Äî rhabdomyolysis risk, pressure injury, dehydration, hypothermia", "Anticoagulated ‚Äî warfarin: bleeding risk peri-operatively", "Frailty status ‚Äî assess using Clinical Frailty Scale", "Hypothermia 35.4¬∞C ‚Äî warm patient", "AF + warfarin ‚Äî INR unknown, clinical flag for bleeding"],
  ddx: ["Right NOF fracture (primary)", "Intertrochanteric fracture", "Pelvic fracture", "Pathological fracture"],
  provisional: "Right NOF fracture ‚Äî Long lie, multiple clinical flags",
  treatment: [
    "Analgesia ‚Äî Methoxyflurane initially, Morphine/Fentanyl IV",
    "IV access ‚Äî large bore",
    "IV fluid ‚Äî 500mL bolus (dehydration, BP 102/66, tachycardia)",
    "Temperature management ‚Äî hypothermia 35.4¬∞C, warm blankets, heated ambulance",
    "BGL ‚Äî 4.2, monitor closely (borderline)",
    "Do NOT attempt to straighten or manipulate the limb",
    "Traction ‚Äî NOT indicated for NOF fracture (traction splint is for mid-shaft femur only)",
    "Padding and splinting in position of comfort",
    "Pressure area assessment ‚Äî 8 hour lie risk",
    "Frailty assessment ‚Äî Clinical Frailty Scale",
    "Clinical Flags ‚Äî anticoagulation (warfarin), frailty, AF, fall risk",
    "12-lead ECG ‚Äî rate control in AF, exclude ACS as precipitant",
    "Transport ‚Äî hospital for surgical management",
    "Safeguarding consideration ‚Äî isolated elderly patient, 8-hour lie"
  ],
  kq: [
    { q: "This patient has been lying on the floor for 8 hours. What are the three most significant complications of a long lie that must be assessed and managed?", max: 2, answer: "(1) Rhabdomyolysis ‚Äî muscle breakdown from pressure ischaemia releases myoglobin ‚Üí acute renal failure. Signs: dark/cola-coloured urine, CK elevation (hospital), weakness. Prehospital: IV fluids, hospital notification. (2) Hypothermia (confirmed 35.4¬∞C) ‚Äî impairs cardiac function, coagulation, immune response. (3) Dehydration/electrolyte disturbance ‚Äî contributes to AKI, pre-renal failure. Also: pressure injuries, aspiration pneumonia (if vomiting)." },
    { q: "Why is a traction splint (Sager/Thomas) NOT appropriate for this patient's NOF fracture?", max: 2, answer: "Traction splints are indicated for isolated mid-shaft femoral fractures only. NOF (neck of femur) fractures: traction would distract the fracture site, worsen pain, and risk neurovascular injury; there is no effective traction point; the fracture is intracapsular or extracapsular ‚Äî not mid-shaft. NOF fractures should be splinted in the position of comfort with padding between the legs. Immobilisation, not traction." },
    { q: "How does the frailty assessment influence your care pathway and documentation for this patient?", max: 1, answer: "Clinical Frailty Scale (CPG A0109): Assessing frailty (Category 1-9) influences: escalation of care decisions (category 7-8 frailty may warrant palliative-aligned care); Virtual ED pathway eligibility; documentation for receiving team. Frailty + 8-hour lie + confusion + AF = multiple clinical flags (CPG A0108). Document frailty score, circumstances, safeguarding concerns, and clinical flag triggers clearly." }
  ]
},

{
  id: 20, category: "Adult", subcategory: "Environment", type: "trauma",
  title: "Drowning / Near-Drowning", subtitle: "31yo Male ‚Äî Surf Rescue",
  cpg: "CPG A0803", level: "C/D",
  dispatch: "Response to a beach in Torquay. 31-year-old male, rescued by Lifesavers after approximately 3-4 minutes submersion in surf. CPR in progress by lifeguards on arrival. Patient not responding.",
  vitals: { GCS:3, SpO2:"Undetectable", RR:"0/min", HR:"0 (VF on monitor)", BP:"Undetectable", Temp:"33.2¬∞C (hypothermic)", BGL:"N/A", Rhythm:"Ventricular Fibrillation" },
  key_hx: "Unknown PMH. Caught in rip. Lifeguards performed CPR for approximately 4 minutes prior to arrival. No signs of trauma. Water temperature approximately 14¬∞C.",
  flags: ["Hypothermic cardiac arrest ‚Äî 'not dead until warm and dead'", "VF in hypothermia ‚Äî defibrillation should be attempted, may not respond until warmed", "Risk of cold-water aspiration ‚Äî suction, airway management priority", "Excellent neurological prognosis possible even with prolonged arrest if hypothermic"],
  ddx: ["Drowning / submersion injury with hypothermic cardiac arrest", "Arrhythmia-precipitated drowning (rule out primary cardiac cause)", "Traumatic injury during drowning"],
  provisional: "Drowning ‚Äî Hypothermic Cardiac Arrest (VF)",
  treatment: [
    "Defibrillation ‚Äî 200J biphasic immediately (VF)",
    "CPR ‚Äî continuous, high quality",
    "Airway ‚Äî ETT (MICA) or suction + supraglottic airway",
    "O2 100%",
    "IV/IO access",
    "Adrenaline 1mg IV ‚Äî as per cardiac arrest CPG (modified in hypothermia ‚Äî may withhold until >30¬∞C)",
    "Rewarm ‚Äî remove wet clothing, warm blankets, warm IV fluids",
    "Do NOT cease resuscitation due to hypothermia alone ‚Äî 'not dead until warm and dead'",
    "Limit defibrillation attempts to 3 if <30¬∞C (further shocks ineffective until warmed)",
    "MICA escalation ‚Äî hypothermic cardiac arrest",
    "Pre-notify receiving hospital ‚Äî hypothermic arrest, ECMO/CPB rewarming may be required",
    "Spinal precautions if dive/surf mechanism",
    "Continuous temperature monitoring"
  ],
  kq: [
    { q: "What does 'not dead until warm and dead' mean and how does it influence your decision to continue resuscitation?", max: 2, answer: "Hypothermia provides profound neuroprotection ‚Äî severely hypothermic patients (core temp <30¬∞C) can survive prolonged cardiac arrest with good neurological outcome because metabolic rate and oxygen consumption are dramatically reduced. 'Not dead until warm and dead' means: do NOT declare death or cease resuscitation based on hypothermic cardiac arrest alone. Resuscitation should continue until core temperature is restored to near-normal and the patient fails to respond. ECMO-assisted rewarming at hospital may be required for return of spontaneous circulation." },
    { q: "How does VF management differ in hypothermic cardiac arrest compared to normothermic VF?", max: 2, answer: "In hypothermia <30¬∞C: defibrillation should still be attempted (up to 3 shocks); if unsuccessful, further defibrillation may be ineffective until temperature rises above 30¬∞C ‚Äî limit to 3 attempts; Adrenaline and antiarrhythmics may accumulate (reduced metabolism) ‚Äî some protocols recommend withholding or reducing frequency until >30¬∞C; The heart may be too cold to respond to medications. Core rewarming is the definitive treatment for hypothermic VF. Reassess rhythm and shock as temperature rises." },
    { q: "What are two specific risks from cold saltwater drowning that influence your airway and respiratory management?", max: 1, answer: "(1) Aspiration of seawater ‚Äî hypertonic saltwater draws fluid into alveoli, worsening pulmonary oedema; freshwater drowning is isosomotic ‚Äî both cause surfactant washout and atelectasis. Requires suction, ETT, PEEP ventilation. (2) Cold water laryngospasm ‚Äî can cause near-total airway obstruction even in submersion. Airway management and suction are priorities before and during resuscitation." }
  ]
},

// ============================================================
// PAEDIATRIC (6 scenarios)
// ============================================================
{
  id: 21, category: "Paediatric", subcategory: "Cardiac Arrest", type: "paediatric",
  title: "Paediatric Cardiac Arrest", subtitle: "3yo Female ‚Äî Medical Arrest",
  cpg: "CPG P0201-1", level: "C/D",
  dispatch: "Urgent response to a private residence in Epping. 3-year-old female, found unresponsive in bedroom by mother. No bystander CPR. Mother on phone to 000. Time unknown.",
  vitals: { GCS:3, SpO2:"Undetectable", RR:"0/min", HR:"0 ‚Äî Asystole", BP:"Undetectable", Temp:"N/A", BGL:"N/A", Rhythm:"Asystole" },
  key_hx: "Unknown PMH. 3yo, approx 15kg. Found unresponsive in bedroom. No trauma identified. No witnessed collapse. Mother reports she was well yesterday.",
  flags: ["Paediatric cardiac arrest ‚Äî asphyxial more common than primary cardiac", "Airway + oxygenation is priority (different to adult)", "Weight-based dosing ‚Äî ~15kg, Adrenaline 0.15mg IV/IO (0.01mg/kg)", "IO access if IV fails ‚Äî do NOT delay"],
  ddx: ["Asphyxial cardiac arrest (primary ‚Äî paediatric)", "SIDS/SUDI (if very young)", "Metabolic cause", "Head trauma (non-accidental injury must be considered)"],
  provisional: "Paediatric Cardiac Arrest ‚Äî Asystole",
  treatment: [
    "CPR ‚Äî 15:2 ratio (2 rescuers) ‚Äî high quality chest compressions 4cm depth",
    "Airway ‚Äî BVM ventilation priority (asphyxial arrest ‚Äî O2 delivery critical)",
    "Supraglottic airway or ETT (MICA) ‚Äî age 3, size 3.5-4.0 uncuffed",
    "O2 100% immediately",
    "IO access if IV fails ‚Äî tibial tuberosity (primary for paediatric arrest)",
    "Adrenaline 0.15mg IV/IO (0.01mg/kg for 15kg) every 3-5 min",
    "Identify reversible causes ‚Äî Hs and Ts",
    "Warm patient ‚Äî hypothermia worsens outcomes",
    "BGL ‚Äî hypoglycaemia common in arrested children",
    "Consider Dextrose 10% 5mL/kg IV/IO if hypoglycaemia confirmed",
    "MICA escalation ‚Äî paediatric arrest",
    "Consider non-accidental injury ‚Äî documented for safeguarding",
    "Family support ‚Äî critical incident, manage family compassionately",
    "Pre-notify hospital ‚Äî paediatric cardiac arrest, ETA"
  ],
  kq: [
    { q: "How does paediatric cardiac arrest differ from adult cardiac arrest in aetiology and why does this change the priority of management?", max: 2, answer: "Paediatric cardiac arrest is most commonly asphyxial (respiratory failure ‚Üí hypoxia ‚Üí cardiac arrest), unlike adults where primary cardiac causes (VF/VT) predominate. This means: airway and oxygenation are the absolute first priority; BVM ventilation should not be delayed; 15:2 compression:ventilation ratio used (2 rescuers) to ensure adequate ventilation; shockable rhythms (VF/pVT) are less common but defibrillate if present. In asphyxial arrest, restoring oxygenation can restore cardiac output." },
    { q: "Calculate the Adrenaline dose for this 15kg child and describe the route of administration if IV access is not immediately available.", max: 2, answer: "Adrenaline dose: 0.01mg/kg = 0.01 x 15 = 0.15mg IV/IO. Draw up 0.15mL of 1:1000 (1mg/mL). If IV not immediately available: IO access ‚Äî anterior tibial tuberosity (anteromedial surface, 2cm below tibial tuberosity, 1-2cm medial) using EZ-IO or manual IO needle. IO is as effective as IV for drug delivery in cardiac arrest. Do NOT delay Adrenaline for IV access." },
    { q: "Non-accidental injury must be considered. What findings or circumstances would raise your index of suspicion?", max: 1, answer: "Raise suspicion for NAI: inconsistent history, delay in calling 000, injuries inconsistent with developmental stage, multiple injuries at different ages, specific injuries (retinal haemorrhage, posterior rib fractures, metaphyseal fractures), unusual affect of carer, previous child protection involvement. Document observations without accusation. Mandatory notification to Child Protection Services if NAI suspected. Treat child first, document factually." }
  ]
},

{
  id: 22, category: "Paediatric", subcategory: "Respiratory", type: "paediatric",
  title: "Paediatric Asthma", subtitle: "8yo Male ‚Äî Severe Exacerbation",
  cpg: "CPG P0602", level: "C/D",
  dispatch: "Response to a primary school in Box Hill. 8-year-old male, acute asthma at school. School nurse reports he has used his own Ventolin 4 times with no improvement. Mother contacted and on her way. Patient is distressed.",
  vitals: { GCS:14, SpO2:"88%", RR:"36/min", HR:"148 bpm", BP:"108/68", Temp:"37.2¬∞C", BGL:"6.2 mmol/L", Rhythm:"Sinus tachycardia" },
  key_hx: "Known asthma since age 4. On Seretide preventer. Prescribed Ventolin puffer. Previous ED admission last year, no ICU. Triggered by exercise and dust. Weighs 28kg. No allergies. No known steroid use today.",
  flags: ["SpO2 88% ‚Äî severe paediatric asthma", "28kg child ‚Äî weight-based dosing required", "Pulsus paradoxus in severe asthma", "Silent chest = life threatening in paediatric asthma", "Dexamethasone ‚Äî reduce airway inflammation"],
  ddx: ["Severe paediatric asthma (primary)", "Anaphylaxis (exclude ‚Äî no skin signs)", "Croup (no stridor)", "Foreign body inhalation (consider in younger children)"],
  provisional: "Severe Paediatric Asthma",
  treatment: [
    "Salbutamol pMDI ‚Äî 4-12 puffs via spacer (titrate to response), O2 via nasal cannulae",
    "Ipratropium Bromide ‚Äî up to 8 puffs if available/prescribed",
    "Dexamethasone ‚Äî for all but mildest presentations",
    "O2 ‚Äî maintain SpO2 94-98%",
    "Positioning ‚Äî upright, position of comfort",
    "IV access (if deteriorating)",
    "Salbutamol nebuliser ‚Äî if pMDI technique inadequate or too distressed",
    "Monitor closely ‚Äî 'bradying down' indicates imminent arrest",
    "Parenteral Adrenaline IM ‚Äî if unable to inhale effectively (life-threatening)",
    "Reassess every 5-10 min",
    "School nurse assistance ‚Äî familiar face for child",
    "MICA escalation ‚Äî SpO2 88%, severe features",
    "Pre-notify receiving paediatric hospital (RCH, Monash Children's)"
  ],
  kq: [
    { q: "What additional clinical signs would tell you this child is deteriorating towards a life-threatening state?", max: 2, answer: "Life-threatening signs: SpO2 <92% (worsening from 88%), silent chest (absent wheeze = no airflow), bradycardia (bradying down = imminent arrest), decreasing GCS/exhaustion, cyanosis, inability to speak/cry, use of accessory muscles + paradoxical breathing. Silent chest in a child previously wheezing = critical emergency ‚Äî prepare for respiratory arrest." },
    { q: "The Salbutamol pMDI is not improving the child. What are your next escalation steps?", max: 2, answer: "1. Ensure correct technique ‚Äî spacer and mask, child calm, 4-12 puffs with 4-6 slow breaths per actuation. 2. Switch to nebulised Salbutamol if pMDI technique inadequate. 3. Add Ipratropium Bromide. 4. Dexamethasone if not already given. 5. If unable to inhale effectively or life-threatening features: parenteral Adrenaline IM (Adrenaline 0.01mg/kg IM). 6. Prepare for bag-valve-mask ventilation if respiratory failure imminent. 7. MICA escalation immediately." },
    { q: "How does the spacer device improve Salbutamol delivery compared to a pMDI alone in a distressed child?", max: 1, answer: "Spacer reduces the coordination requirement between actuation and inhalation (critical in distressed children and young children who cannot coordinate pMDI). Slows particle velocity ‚Üí reduces oropharyngeal deposition ‚Üí increases lower airway delivery. Uses tidal breathing ‚Äî child doesn't need a deep breath. Overall: spacer increases lung deposition from ~10% (pMDI alone) to ~20-30%. Essential for paediatric asthma management." }
  ]
},

{
  id: 23, category: "Paediatric", subcategory: "Medical", type: "paediatric",
  title: "Febrile Seizure", subtitle: "2yo Male ‚Äî Post-Ictal",
  cpg: "CPG P0719", level: "C/D",
  dispatch: "Response to a private residence in Narre Warren. 2-year-old male, had a witnessed tonic-clonic seizure lasting approximately 3 minutes, now post-ictal. Temperature noted by parents as 39.2¬∞C. First seizure. Parents panicked.",
  vitals: { GCS:"10 (post-ictal ‚Äî improving)", SpO2:"97%", RR:"24/min", HR:"168 bpm", BP:"94/58", Temp:"39.2¬∞C", BGL:"4.6 mmol/L", Rhythm:"Sinus tachycardia" },
  key_hx: "Age 2, weight approximately 12kg. No PMH. No known epilepsy. Febrile for 24 hours ‚Äî UTI suspected by parents (GP visit yesterday). First seizure ever. Seizure was tonic-clonic, <3 min, now post-ictal with improving GCS.",
  flags: ["Simple febrile seizure ‚Äî <15min, generalised, single episode, now post-ictal", "No active seizure management required (resolved)", "Fever management and identification of source is priority", "Criteria for COMPLEX febrile seizure: >15min, focal, multiple in 24hrs ‚Äî would require Midazolam"],
  ddx: ["Simple febrile seizure (primary)", "Complex febrile seizure", "Meningitis/encephalitis (must exclude)", "Hypoglycaemia-induced seizure (excluded ‚Äî BGL 4.6)"],
  provisional: "Simple Febrile Seizure",
  treatment: [
    "Reassure parents ‚Äî calm, controlled approach",
    "Recovery position ‚Äî post-ictal, improving GCS",
    "O2 ‚Äî low flow as needed, SpO2 97% ‚Äî not critical",
    "Temperature management ‚Äî tepid sponging, remove excess clothing",
    "Paracetamol suppository or oral (if tolerated) ‚Äî temperature management",
    "Do NOT administer Midazolam ‚Äî seizure has resolved",
    "BGL confirmed ‚Äî not hypoglycaemia",
    "Assess for source of fever (UTI, viral URTI, otitis media)",
    "Assess for meningitis signs ‚Äî neck stiffness, photophobia, Kernig's/Brudzinski's, rash",
    "Monitor for further seizure activity",
    "Transport to hospital ‚Äî first febrile seizure requires investigation",
    "Parental education ‚Äî first seizure, very distressing for family",
    "MICA escalation only if: further seizure, >15 min, focal features, meningitis signs"
  ],
  kq: [
    { q: "What distinguishes a simple febrile seizure from a complex febrile seizure, and how does this change your management?", max: 2, answer: "Simple febrile seizure: <15 minutes, generalised (tonic-clonic), single episode within 24 hours, resolves spontaneously, no focal features, child >6 months. Complex febrile seizure: >15 min (febrile status epilepticus), focal features, multiple episodes in 24 hours. Management difference: simple (as per this case) = no Midazolam needed, reassurance, fever management, transport; complex = Midazolam as per seizure CPG (0.1mg/kg IV or 0.2mg/kg IM/buccal), MICA escalation." },
    { q: "What signs would raise your suspicion for bacterial meningitis in this child rather than a simple febrile seizure?", max: 2, answer: "Meningitis red flags: non-blanching petechial or purpuric rash (meningococcal), neck stiffness (meningismus), photophobia, bulging fontanelle (in infants), Kernig's sign (resistance to knee extension with hip flexed), Brudzinski's sign (knee flexion on neck flexion), very high fever >40¬∞C, toxic appearance, persistent altered consciousness beyond post-ictal period, headache. ANY of these warrants immediate treatment for meningococcal disease (Ceftriaxone ‚Äî MICA)." },
    { q: "What information must you provide to parents regarding febrile seizures before transport?", max: 1, answer: "Key parental education: febrile seizures are common (2-5% of children), usually benign and short-lived; they do not cause brain damage in simple cases; the child will be confused/sleepy afterwards (post-ictal ‚Äî normal); high temperature can cause recurrence ‚Äî manage fever with paracetamol; if another seizure occurs ‚Äî place on side, do not put anything in mouth, call 000 if >5 min. First seizure requires hospital investigation to exclude other causes." }
  ]
},

{
  id: 24, category: "Paediatric", subcategory: "Respiratory", type: "paediatric",
  title: "Croup", subtitle: "18mo Female ‚Äî Stridor at Rest",
  cpg: "CPG P0601-1", level: "C/D",
  dispatch: "Urgent response to a private residence in Cranbourne. 18-month-old female, overnight onset of barking cough and noisy breathing. Parents very anxious. Child is audibly stridorous on arrival.",
  vitals: { GCS:14, SpO2:"92%", RR:"44/min", HR:"162 bpm", BP:"90/54", Temp:"38.0¬∞C", BGL:"5.8 mmol/L", Rhythm:"Sinus tachycardia" },
  key_hx: "18 months, 12kg approximately. No prior croup episodes. No PMH. Audible stridor at rest with intercostal recession. Barking (seal-like) cough. Onset overnight. No drooling. No foreign body history.",
  flags: ["Stridor at rest + SpO2 92% + recession = moderate-severe croup", "Nebulised Adrenaline indicated", "Dexamethasone for airway inflammation", "DO NOT examine throat ‚Äî may precipitate laryngospasm (epiglottitis risk)", "Agitation worsens stridor ‚Äî minimise interventions, keep parent close"],
  ddx: ["Viral croup (laryngotracheobronchitis) ‚Äî primary", "Epiglottitis (do NOT exclude ‚Äî DO NOT examine throat)", "Foreign body inhalation", "Bacterial tracheitis"],
  provisional: "Moderate-Severe Croup",
  treatment: [
    "Minimise distress ‚Äî keep child with parent, calm environment",
    "Do NOT examine throat ‚Äî risk of complete obstruction (esp. epiglottitis)",
    "Nebulised Adrenaline ‚Äî 5mg in 5mL nebulised (0.5mL of 1:1000 per kg up to 5mL) ‚Äî for stridor at rest",
    "Dexamethasone oral/IM ‚Äî reduce airway inflammation",
    "O2 ‚Äî flow-by or as tolerated (mask may distress child)",
    "Humidified O2 if available ‚Äî may provide comfort (evidence limited)",
    "Position of comfort ‚Äî upright in parent's arms",
    "Avoid upsetting child ‚Äî crying worsens stridor",
    "IV access ‚Äî NOT routinely; only if critical",
    "Reassess at 30 min (Adrenaline effect wears off ‚Äî rebound possible)",
    "Transport ‚Äî all moderate-severe croup require hospital (rebound stridor)",
    "MICA escalation ‚Äî SpO2 92%, stridor at rest",
    "Pre-notify paediatric receiving hospital"
  ],
  kq: [
    { q: "Why is examining the throat (with a tongue depressor) absolutely contraindicated in a child with stridor, and what condition specifically makes this dangerous?", max: 2, answer: "Epiglottitis (bacterial ‚Äî Haemophilus influenzae type b or Streptococcus) can present identically to severe croup. The inflamed, cherry-red epiglottis can completely obstruct the airway if disturbed by examination. A child with epiglottitis may maintain a partially open airway by sitting in a specific position ‚Äî forced examination can precipitate complete laryngospasm and respiratory arrest. Epiglottitis features: drooling, inability to swallow, muffled voice, toxic appearance, rapidly progressive, no barking cough. If epiglottitis suspected: immediate MICA escalation, paediatric anaesthesia notification." },
    { q: "How does nebulised Adrenaline work in croup and why is hospital observation required after administration?", max: 2, answer: "Nebulised Adrenaline works via alpha-adrenergic vasoconstriction of the subglottic mucosa, reducing oedema and subglottic diameter. Onset: 10-30 minutes. Duration: 2-3 hours. Hospital observation required because: Adrenaline effect wears off ‚Äî rebound oedema (worsening of stridor) can occur 2-3 hours post-administration; the child may re-obstruct. All children receiving nebulised Adrenaline require minimum 3-4 hours hospital observation." },
    { q: "What clinical features differentiate mild, moderate, and severe croup in terms of required management?", max: 1, answer: "Mild: occasional barking cough, no stridor at rest, no recession, SpO2 normal ‚Üí oral Dexamethasone, parents can manage at home (with instructions). Moderate: stridor at rest, mild-moderate recession, SpO2 ‚â•92%, child maintaining airway ‚Üí Dexamethasone + nebulised Adrenaline, hospital transport. Severe: marked stridor at rest, severe recession, SpO2 <92%, cyanosis, exhaustion, altered consciousness ‚Üí immediate nebulised Adrenaline, O2, MICA, transport as priority." }
  ]
},

{
  id: 25, category: "Paediatric", subcategory: "Trauma", type: "paediatric",
  title: "Paediatric Major Trauma", subtitle: "11yo Male ‚Äî Hit by Car at School Zone",
  cpg: "CPG P0806", level: "C/D",
  dispatch: "Urgent response to a suburban road in Geelong. 11-year-old male, struck by car at school zone. Bystanders estimate 40km/h impact. Child hit and thrown approximately 4 metres. On ground, semi-conscious.",
  vitals: { GCS:11, SpO2:"94%", RR:"28/min", HR:"144 bpm", BP:"88/52", Temp:"36.3¬∞C", BGL:"5.6 mmol/L", Rhythm:"Sinus tachycardia" },
  key_hx: "11yo, approximately 35kg. Struck by car at 40km/h, thrown 4m. Obvious deformity left femur. Abdominal tenderness and guarding. GCS declining from 15 to 11 since bystander report. No known PMH.",
  flags: ["Paediatric haemorrhagic shock ‚Äî children compensate well then decompensate rapidly", "Tachycardia is the primary early compensatory response in children", "BP is preserved until 30-40% blood loss ‚Äî hypotension is a LATE and CRITICAL finding", "Weight-based fluid and drug dosing ‚Äî 35kg"],
  ddx: ["Paediatric major trauma ‚Äî haemorrhagic shock", "Intraabdominal haemorrhage (guarding)", "Traumatic brain injury (declining GCS)", "Femoral fracture with significant haemorrhage"],
  provisional: "Paediatric Major Trauma ‚Äî Haemorrhagic Shock + Declining GCS",
  treatment: [
    "C-spine ‚Äî manual immobilisation",
    "Airway ‚Äî manage with adjuncts, O2 high flow",
    "IV/IO access ‚Äî 35kg, two attempts for IV then IO",
    "Fluid ‚Äî cautious boluses 10-20mL/kg NS/Hartmann's, reassess after each",
    "Femoral fracture ‚Äî traction splint only if mid-shaft, isolated (not NOF, pelvic fx)",
    "GCS declining ‚Äî Traumatic Head Injury concurrent (CPG A/P0803)",
    "Avoid hypotension AND hyperoxia ‚Äî both worsen TBI",
    "Avoid over-resuscitation ‚Äî target improving conscious state, not normal BP",
    "Temperature management ‚Äî hypothermia risk, small body mass",
    "Rapid packaging and transport ‚Äî do NOT remain on scene",
    "MICA escalation ‚Äî paediatric major trauma, declining GCS",
    "Pre-notify paediatric trauma centre (RCH) ‚Äî code trauma paediatric",
    "Safeguarding ‚Äî document mechanism, bystander information"
  ],
  kq: [
    { q: "Why is tachycardia a more reliable early indicator of shock in children than hypotension?", max: 2, answer: "Children have higher physiological reserve and compensate for blood loss primarily by increasing heart rate (sympathetic response). Blood pressure is maintained by vasoconstriction and tachycardia until 30-40% blood volume is lost. By the time hypotension is present in a child, they have lost a critical proportion of circulating volume and are in decompensated shock ‚Äî about to arrest. Tachycardia is the sentinel early warning sign. Normal paediatric BP values also differ by age ‚Äî always compare to age-appropriate normal values." },
    { q: "How does fluid resuscitation in paediatric major trauma differ from adult resuscitation in terms of volume and targets?", max: 2, answer: "Paediatric resuscitation: initial bolus 10-20mL/kg (NOT 500mL-1L as in adults) ‚Äî reassess after each bolus; target improving GCS and HR, adequate perfusion ‚Äî NOT normal BP (permissive hypotension target as in adults is less well defined in children); smaller boluses reduce risk of hypothermia and dilutional coagulopathy; IO is equivalent to IV. Avoid excessive crystalloid ‚Äî associated with hypothermia, coagulopathy, and abdominal compartment syndrome." },
    { q: "This child's GCS is declining from 15 to 11. How does this change your treatment priorities and what must you avoid in the management of concurrent TBI?", max: 1, answer: "Declining GCS adds TBI management priority: AVOID hypotension (target SBP appropriate for age ‚Äî consider 70+2xage mmHg), AVOID hypoxia (SpO2 >94%), AVOID hyperoxia (SpO2 >98%), AVOID hypercapnia (ventilate to ETCO2 35-40), AVOID hyperthermia. These secondary brain injury factors worsen outcome. Rapid transport to neurosurgical/paediatric trauma centre is critical ‚Äî do not delay on scene." }
  ]
},

{
  id: 26, category: "Paediatric", subcategory: "Medical", type: "paediatric",
  title: "Paediatric Anaphylaxis", subtitle: "6yo Female ‚Äî Allergic Reaction at Restaurant",
  cpg: "CPG P0704", level: "C/D",
  dispatch: "Response to a restaurant in Lygon Street. 6-year-old female, known peanut allergy, possible peanut exposure. Now with hives, vomiting and difficulty breathing. Parents present. Epipen used by parents approximately 5 minutes ago.",
  vitals: { GCS:14, SpO2:"95%", RR:"28/min", HR:"138 bpm", BP:"82/54", Temp:"37.0¬∞C", BGL:"5.4 mmol/L", Rhythm:"Sinus tachycardia" },
  key_hx: "6yo, approximately 22kg. Known severe peanut allergy. Suspected peanut in meal. Parents administered Epipen Junior (0.15mg) 5 min ago. Hives all over body, vomiting once, lip swelling, audible wheeze.",
  flags: ["Epipen already used ‚Äî check response, may need further Adrenaline", "Weight 22kg ‚Äî Adrenaline 0.22mg IM (0.01mg/kg)", "Persistent symptoms despite Epipen ‚Äî incomplete response", "Biphasic reaction risk ‚Äî minimum 4 hours hospital observation"],
  ddx: ["Paediatric anaphylaxis ‚Äî peanut (primary)", "Severe allergic reaction", "Asthma exacerbation concurrent"],
  provisional: "Anaphylaxis ‚Äî Paediatric, Peanut Allergen",
  treatment: [
    "Assess Epipen response ‚Äî symptoms persisting despite 5 min post Epipen",
    "Adrenaline IM 0.22mg (0.01mg/kg x 22kg) ‚Äî anterolateral mid-thigh",
    "Position supine unless respiratory symptoms dominate",
    "O2 ‚Äî maintain SpO2 94-98%",
    "IV access",
    "IV fluid bolus ‚Äî 10-20mL/kg for hypotension (BP 82/54)",
    "Salbutamol ‚Äî if bronchospasm persists after Adrenaline",
    "Dexamethasone ‚Äî airway inflammation",
    "Bring Epipen Junior to hospital with patient",
    "Parents' presence ‚Äî essential for child cooperation",
    "Transport ‚Äî ALL paediatric anaphylaxis to hospital (biphasic risk)",
    "Minimum 4 hours hospital observation",
    "MICA escalation ‚Äî hypotension in child, incomplete response to Epipen"
  ],
  kq: [
    { q: "The parents used an Epipen Junior (0.15mg). This child weighs 22kg. Is the Epipen dose appropriate and what dose would you administer now?", max: 2, answer: "Epipen Junior contains 0.15mg Adrenaline ‚Äî designed for children 15-30kg. For 22kg: recommended dose = 0.01mg/kg = 0.22mg. The Epipen Junior (0.15mg) is slightly underdosed for this child but was the appropriate device available. Now: administer Adrenaline 0.22mg IM (0.22mL of 1:1000 solution) to anterolateral mid-thigh. If symptoms still persisting at 5 min, repeat at 0.22mg." },
    { q: "How does paediatric anaphylaxis fluid resuscitation differ from adult in terms of volumes?", max: 2, answer: "Paediatric fluid bolus: 10-20mL/kg (not the 500-1000mL adult bolus). For 22kg child: 220-440mL Normal Saline bolus, reassess after each bolus. Use smaller, weight-based volumes ‚Äî children have smaller circulating volumes (80mL/kg) and are at risk of fluid overload. Reassess HR, BP, conscious state, and perfusion after each bolus." },
    { q: "Why must all paediatric anaphylaxis patients be transported to hospital even if they appear completely recovered?", max: 1, answer: "Biphasic anaphylaxis occurs in approximately 20% of cases ‚Äî symptoms recur hours after initial resolution without further allergen exposure. Children have less physiological reserve and may deteriorate more rapidly than adults. The auto-injector dose may be insufficient (underdose for weight). Hospital observation minimum 4 hours allows monitoring for biphasic reaction and PICC line insertion for Adrenaline infusion if required." }
  ]
},

// ============================================================
// OBSTETRIC (4 scenarios)
// ============================================================
{
  id: 27, category: "Maternity", subcategory: "Cord Prolapse", type: "obstetric",
  title: "Imminent Delivery", subtitle: "29yo Female ‚Äî Precipitous Labour",
  cpg: "CPG M0301", level: "C/D",
  dispatch: "Urgent response to a private residence in Werribee. 29-year-old female, 38 weeks gestation, contractions 2 minutes apart. States she feels like she needs to push. Husband has called 000. First child.",
  vitals: { GCS:15, SpO2:"98%", RR:"18/min", HR:"98 bpm", BP:"128/78", Temp:"36.9¬∞C", BGL:"5.6 mmol/L", Rhythm:"Normal sinus" },
  key_hx: "G1P0, 38 weeks, antenatal care with GP and midwife. No complications in pregnancy. No known maternal medical conditions. Contractions 2 min apart, strong. States desire to push with each contraction. No bleeding visible.",
  flags: ["Imminent delivery ‚Äî urge to push, 2 min contractions, 38 weeks", "Prepare birth kit immediately on arrival", "Primary PPH occurs within 24 hours of delivery ‚Äî monitor closely", "Normal birth vs. complications ‚Äî be ready"],
  ddx: ["Normal term delivery ‚Äî imminent", "Precipitous (rapid) delivery", "Preterm labour (38 weeks ‚Äî term)"],
  provisional: "Imminent Normal Delivery ‚Äî G1P0, 38 weeks",
  treatment: [
    "Birth kit preparation ‚Äî gloves, towels, cord clamps x2, scissors, neonatal resus equipment",
    "Gentle visual examination ‚Äî crowning? Presenting part? Cord?",
    "Position ‚Äî semi-recumbent or left lateral",
    "Do NOT tell patient not to push ‚Äî guide controlled pushing",
    "Support perineum ‚Äî gentle guiding hands during crowning",
    "Head delivery ‚Äî check for nuchal cord on delivery",
    "Clear airway ‚Äî gentle wipe of face/mouth",
    "Support shoulders and body delivery",
    "Dry and stimulate newborn ‚Äî towel, warm, stimulate",
    "Clamp and cut cord after 1-3 minutes (delayed cord clamping) unless compromised",
    "Skin-to-skin if newborn vigorous",
    "Assess Apgar scores at 1 and 5 minutes",
    "Active management of third stage ‚Äî IV access, uterine massage, Syntocinon (MICA) if PPH",
    "Monitor mother ‚Äî uterine tone, blood loss, BP, HR",
    "Transport both mother and newborn post-delivery"
  ],
  kq: [
    { q: "What are the Apgar scores, what do you assess, and at what time points?", max: 2, answer: "Apgar score assesses 5 criteria at 1 minute and 5 minutes: Appearance (skin colour ‚Äî pink/blue/white), Pulse (HR ‚Äî >100/absent), Grimace (reflex irritability ‚Äî cry/grimace/none), Activity (muscle tone ‚Äî active/some flexion/floppy), Respiration (breathing effort ‚Äî strong cry/weak/absent). Each scored 0-2, total 0-10. Score 7-10 = normal; 4-6 = needs stimulation/O2; 0-3 = requires immediate resuscitation. Score at 1 min guides initial actions; score at 5 min indicates response to interventions." },
    { q: "What is delayed cord clamping and why is it recommended?", max: 2, answer: "Delayed cord clamping (DCC) = waiting 1-3 minutes before clamping and cutting the cord (vs. immediate clamping <1 min). Benefits: allows additional 80-100mL of placental blood transfusion to the newborn; increases iron stores; improves cardiovascular stability; reduces risk of intraventricular haemorrhage in preterm infants; reduces need for blood transfusion. Exception: compromise of mother (haemorrhage) or compromised newborn needing immediate resuscitation." },
    { q: "After the baby is delivered, what are the first steps to assess and initiate neonatal resuscitation if required?", max: 1, answer: "Assess in first 30 seconds: term gestation? Breathing/crying? Tone (floppy vs. active)? If YES to all three ‚Üí skin-to-skin, warmth, monitoring. If NO to any ‚Üí Warm and dry, stimulate (rub back/flick feet), position airway (neutral sniffing position), suction only if obvious airway obstruction. Reassess after 30 seconds: if still not breathing/HR <100 ‚Üí BVM ventilation 40-60 breaths/min. If HR <60 despite ventilation ‚Üí CPR (3:1 ratio). CPG N0201." }
  ]
},

{
  id: 28, category: "Maternity", subcategory: "Pre-eclampsia / Eclampsia", type: "obstetric",
  title: "Pre-Eclampsia / Eclampsia", subtitle: "34yo Female ‚Äî Seizure in Pregnancy",
  cpg: "CPG M0202", level: "C/D",
  dispatch: "Urgent response to a private residence in South Yarra. 34-year-old female, 36 weeks pregnant, currently seizing. Husband called 000. No previous seizure history. He reports she had a severe headache for the past few hours and her hands are swollen.",
  vitals: { GCS:"3 (seizing ‚Äî improving post-ictal)", SpO2:"89%", RR:"Irregular", HR:"108 bpm", BP:"186/118", Temp:"37.1¬∞C", BGL:"5.8 mmol/L", Rhythm:"Sinus tachycardia" },
  key_hx: "G2P1, 36 weeks. Previous normal pregnancy. Hypertension this pregnancy (diagnosed 32 weeks, on labetalol). Severe headache x3 hours. Visual disturbances (flashing lights). Facial and hand oedema. Now post-ictal.",
  flags: ["Eclampsia ‚Äî seizure + severe hypertension + pregnancy", "Magnesium Sulfate is the treatment for eclampsia (MICA)", "Do NOT use Midazolam as first line in eclampsia", "Left lateral position ‚Äî uterine displacement, aortocaval compression", "Pre-eclampsia warning signs: severe headache, visual changes, oedema"],
  ddx: ["Eclampsia (primary)", "Pre-eclampsia without seizure", "Epilepsy in pregnancy", "Intracranial haemorrhage"],
  provisional: "Eclampsia ‚Äî 36 weeks gestation",
  treatment: [
    "Left lateral position ‚Äî aortocaval compression relief, safer for baby",
    "Airway ‚Äî position, suction, O2 high flow",
    "Magnesium Sulfate ‚Äî primary treatment for eclamptic seizure (MICA scope)",
    "Do NOT use Midazolam as first line ‚Äî MgSO4 is treatment for eclampsia",
    "BP management ‚Äî severe hypertension (BP 186/118) to be managed in hospital",
    "IV access",
    "Continuous monitoring ‚Äî BP, fetal HR if able",
    "Maintain left lateral tilt throughout",
    "Position to avoid injury during seizure",
    "Monitor for further seizures and for recurrence post-treatment",
    "MICA escalation ‚Äî eclampsia is MICA scope for MgSO4",
    "Pre-notify obstetric hospital (RWH, Monash Health, Mercy) ‚Äî eclampsia at 36 weeks",
    "Communicate fetal status"
  ],
  kq: [
    { q: "What is the difference between pre-eclampsia and eclampsia, and what warning signs should alert you to progression?", max: 2, answer: "Pre-eclampsia: hypertension (>140/90) + proteinuria in pregnancy (>20 weeks), with or without end-organ dysfunction. Eclampsia: pre-eclampsia + new-onset seizures (not attributable to other cause). Warning signs of progression to eclampsia (severe pre-eclampsia): severe headache (intracranial hypertension), visual disturbances (scotomata, flashing lights ‚Äî retinal vasospasm), epigastric/RUQ pain (HELLP/hepatic involvement), rapidly worsening oedema, BP ‚â•160/110." },
    { q: "Why is Magnesium Sulfate the preferred treatment for eclampsia rather than Midazolam?", max: 2, answer: "MgSO4 is specifically indicated for eclampsia because: it targets the underlying pathophysiology (cerebral vasospasm and neuronal excitability from endothelial dysfunction in eclampsia); it prevents recurrent seizures; it has been shown to be superior to phenytoin and diazepam for eclamptic seizures. Midazolam is a general anticonvulsant not targeting the eclamptic mechanism. Additionally, MgSO4 has fewer neonatal respiratory effects than benzodiazepines. Note: MgSO4 is MICA scope ‚Äî ALS paramedics should focus on supportive care and escalate." },
    { q: "Why is the left lateral position important for this patient and what physiological complication does it prevent?", max: 1, answer: "After approximately 20 weeks gestation, the gravid uterus can compress the inferior vena cava (IVC) and aorta when the patient is supine (aortocaval compression). This reduces venous return to the heart, reducing cardiac output, causing maternal hypotension AND reduced placental perfusion (uteroplacental insufficiency) ‚Äî fetal distress. Left lateral positioning (or left lateral tilt 15-30¬∞) displaces the uterus off the great vessels. Maintain throughout transport." }
  ]
},

{
  id: 29, category: "Maternity", subcategory: "Primary Postpartum Haemorrhage", type: "obstetric",
  title: "Primary Postpartum Haemorrhage", subtitle: "26yo Female ‚Äî Massive PPH at Home Birth",
  cpg: "CPG M0401", level: "C/D",
  dispatch: "Urgent response to a private residence in Byron Bay... no sorry ‚Äî Thornbury. 26-year-old female, home birth 30 minutes ago. Midwife reports massive bleeding, estimated 1200mL+ blood loss so far. Patient now pale and tachycardic.",
  vitals: { GCS:13, SpO2:"94%", RR:"24/min", HR:"138 bpm", BP:"74/42", Temp:"35.6¬∞C", BGL:"5.2 mmol/L", Rhythm:"Sinus tachycardia" },
  key_hx: "G2P2. 26 years old. Uncomplicated home birth 30 min ago under independent midwife care. Spontaneous vaginal delivery. Placenta delivered. Uterine atony suspected (boggy uterus on examination by midwife). Estimated blood loss 1200mL+.",
  flags: ["Primary PPH ‚Äî >500mL blood loss within 24 hours of delivery", "Haemorrhagic shock ‚Äî BP 74/42, HR 138, GCS 13", "Uterine atony ‚Äî most common cause of PPH", "Syntocinon (Oxytocin) ‚Äî MICA scope, primary pharmacological treatment", "Uterine massage and bimanual compression ‚Äî ALS scope"],
  ddx: ["Primary PPH ‚Äî uterine atony (primary)", "Retained placenta", "Genital tract trauma (lacerations)", "Coagulopathy"],
  provisional: "Primary PPH ‚Äî Uterine Atony, Haemorrhagic Shock",
  treatment: [
    "IV access ‚Äî two large bore IVs immediately",
    "IV fluid ‚Äî NS/Hartmann's 500mL-1000mL boluses ‚Äî haemorrhagic shock",
    "Uterine massage ‚Äî fundal massage to stimulate uterine contraction",
    "Bimanual compression ‚Äî if uterus remains atonic (with midwife guidance)",
    "Syntocinon (Oxytocin) 10 IU IM ‚Äî MICA scope (coordinate with attending midwife)",
    "O2 ‚Äî high flow via NRB",
    "Keep warm ‚Äî hypothermia worsens coagulopathy",
    "Bladder catheterisation (in hospital) ‚Äî full bladder impairs uterine contraction",
    "Position ‚Äî supine, legs elevated if tolerated (shock position)",
    "Continuous monitoring ‚Äî BP, HR, SpO2, blood loss volume",
    "MICA escalation ‚Äî immediate, PPH with haemorrhagic shock",
    "Pre-notify obstetric hospital ‚Äî major PPH, haemorrhagic shock, ETA",
    "Newborn ‚Äî ensure newborn is with midwife and being monitored"
  ],
  kq: [
    { q: "What is Primary PPH, what are the 'Four Ts' causes, and which is most common?", max: 2, answer: "Primary PPH: blood loss ‚â•500mL within 24 hours of delivery (or ‚â•1000mL = major PPH). The Four Ts: (1) Tone ‚Äî uterine atony (most common, 80% of PPH) ‚Äî uterus fails to contract after delivery; (2) Tissue ‚Äî retained placenta or placental fragments; (3) Trauma ‚Äî genital tract lacerations, uterine rupture; (4) Thrombin ‚Äî coagulopathy. Uterine atony is by far the most common cause. Clinical sign: boggy/soft uterus on palpation (vs. normal firm contracted uterus)." },
    { q: "How does uterine fundal massage help in PPH and what is the technique?", max: 2, answer: "Fundal massage stimulates uterine muscle contraction (myometrium), which mechanically compresses uterine blood vessels and helps expel clots. Technique: place one hand suprapubically (above the fundus ‚Äî located at the midline, level of umbilicus post-delivery), apply firm circular massage in a kneading motion. Bimanual compression (internal + external): one hand inside vagina (fist in anterior fornix), one hand externally on fundus ‚Äî compress the uterus between both hands. Requires appropriate training and is performed with the attending midwife." },
    { q: "Why is hypothermia a critical concern in this patient and how does it worsen haemorrhage?", max: 1, answer: "Hypothermia impairs coagulation function: clotting factors require near-normal temperature (37¬∞C) to function effectively; hypothermia causes platelet dysfunction and reduced clotting factor activity; combined with acidosis and coagulopathy = 'lethal triad'. In PPH, ongoing haemorrhage causes hypothermia from evaporative and haemorrhagic cooling. Prevention: warm IV fluids if possible, warm blankets, warm transport environment. Permitting hypothermia in haemorrhagic shock worsens coagulopathy in a patient already at risk." }
  ]
},

{
  id: 30, category: "Maternity", subcategory: "Normal Birth", type: "obstetric",
  title: "Cord Prolapse", subtitle: "32yo Female ‚Äî Labour with Cord Prolapse",
  cpg: "CPG M0304", level: "C/D",
  dispatch: "Urgent response to a private residence in Footscray. 32-year-old female, 39 weeks pregnant, in active labour. Waters broke approximately 20 minutes ago. Now reports feeling something coming out. Husband on phone, says he can see 'something' at the vaginal opening.",
  vitals: { GCS:15, SpO2:"98%", RR:"20/min", HR:"102 bpm", BP:"124/78", Temp:"36.8¬∞C", BGL:"5.4 mmol/L", Rhythm:"Normal sinus" },
  key_hx: "G3P2, 39 weeks. All previous normal deliveries. Waters broke 20 min ago. Contractions 3 min apart. Something visible at vaginal opening ‚Äî cord prolapse confirmed on visual inspection. Baby in vertex presentation (confirmed by midwife at last visit).",
  flags: ["CORD PROLAPSE ‚Äî obstetric emergency, time critical", "Compress cord between contractions ‚Äî manual elevation", "Position ‚Äî knee-chest or head down/Trendelenburg to relieve pressure", "Do NOT allow cord to dry out ‚Äî keep moist/warm", "IMMEDIATE transport ‚Äî caesarean section is the only definitive treatment"],
  ddx: ["Cord prolapse (confirmed)", "Normal labour (excluded ‚Äî cord visible)", "Cord presentation (prior to rupture of membranes)"],
  provisional: "Cord Prolapse ‚Äî Obstetric Emergency",
  treatment: [
    "IMMEDIATE ‚Äî manual elevation of presenting part off cord (gloved hand in vagina)",
    "Keep hand in position ‚Äî do NOT remove until surgical delivery",
    "Knee-chest position or exaggerated Trendelenburg ‚Äî relieve gravity pressure on cord",
    "Do NOT pull on cord ‚Äî do NOT allow cord to dry",
    "Wrap cord loosely in warm, moist dressing if outside vagina",
    "O2 ‚Äî high flow to mother (maximise fetal oxygenation)",
    "IV access",
    "Do NOT attempt to replace cord into uterus",
    "Rapid transport ‚Äî most critical ALS action: load and go",
    "Continuous pressure maintained during transport",
    "Fetal heart monitoring (if available)",
    "MICA escalation ‚Äî immediate",
    "Pre-notify obstetric hospital ‚Äî cord prolapse, ETA, fetal HR if known",
    "Keep mother calm ‚Äî extreme stress response"
  ],
  kq: [
    { q: "Why is cord prolapse an immediate life-threatening emergency for the fetus and what is the mechanism of fetal compromise?", max: 2, answer: "Cord prolapse: the umbilical cord descends through the cervix ahead of (or alongside) the presenting part after rupture of membranes. The presenting part (usually fetal head) compresses the cord against the pelvis/cervix during contractions (and between contractions due to gravity). Cord compression ‚Üí occlusion of umbilical vessels ‚Üí interruption of fetal oxygenation and blood flow ‚Üí rapid fetal hypoxia, acidosis, and death if not relieved. Every minute without decompression worsens fetal outcome." },
    { q: "Describe the manual technique to relieve cord compression and why must you maintain this until surgical delivery?", max: 2, answer: "Manual technique: gloved hand inserted into vagina, fingers cup the presenting part (fetal head) and elevate it upward and off the cord ‚Äî relieving compression without displacing the cord. The hand must be maintained in position continuously ‚Äî the presenting part will re-compress the cord with every contraction if released. This is maintained throughout transport and until the surgical team takes over in theatre. Combined with positioning (knee-chest/Trendelenburg) to reduce gravitational pressure." },
    { q: "What position should you place the mother in and why?", max: 1, answer: "Knee-chest position (on hands and knees, bottom elevated) OR exaggerated Trendelenburg (head down, pelvis up) ‚Äî these positions use gravity to shift the presenting part away from the pelvis, reducing cord compression between contractions. This is used in addition to (not instead of) manual elevation. During transport: Trendelenburg on the stretcher with manual hand elevation maintained is most practical." }
  ]
},

];

// ============================================================
// STATE
// ============================================================
let currentScenario = null;
let timerInterval = null;
let timerSeconds = 0;
let timerRunning = false;
let customScenarios = []; // loaded from localStorage
let lastAIScenario = null; // holds the most recent AI-generated scenario pending save

let rowStates = {};
let sectionScores = {};
let kqScores = {};

// ============================================================
// LOCAL STORAGE ‚Äî custom scenarios persist permanently
// ============================================================
const STORAGE_KEY = 'av_custom_scenarios_v1';

function loadCustomScenarios() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    customScenarios = raw ? JSON.parse(raw) : [];
  } catch(e) { customScenarios = []; }
  updateCustomCount();
}

function saveCustomScenarios() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(customScenarios));
  updateCustomCount();
}

function updateCustomCount() {
  const el = document.getElementById('custom-count');
  if (el) el.textContent = customScenarios.length;
}

function getAllScenarios() {
  // Custom/edited scenarios with same ID as a built-in override the built-in
  const overriddenIds = new Set(customScenarios.map(s => s._originalId || (s.id && !s.id.toString().startsWith('custom_') && !s.id.toString().startsWith('ai_') ? s.id : null)).filter(Boolean));
  const builtins = SCENARIOS.filter(s => !overriddenIds.has(s.id));
  return [...builtins, ...customScenarios];
}

// ============================================================
// SCORING LOOKUP TABLES
// ============================================================
const TABLE1 = {
  1: {1:2, 2:3, 3:4, 4:5, 5:5},
  2: {1:3, 2:4, 3:5, 4:5, 5:5},
  3: {1:4, 2:5, 3:6, 4:7, 5:8},
  4: {1:5, 2:5, 3:7, 4:8, 5:9},
  5: {1:5, 2:5, 3:8, 4:9, 5:10}
};
const TABLE2 = {
  1: {2:3, 3:4, 4:5, 5:6, 6:7, 7:8, 8:8, 9:8, 10:8},
  2: {2:4, 3:5, 4:6, 5:7, 6:8, 7:8, 8:8, 9:8, 10:8},
  3: {2:5, 3:6, 4:7, 5:8, 6:9, 7:10, 8:11, 9:12, 10:13},
  4: {2:6, 3:7, 4:8, 5:8, 6:10, 7:11, 8:12, 9:13, 10:14},
  5: {2:7, 3:8, 4:8, 5:8, 6:11, 7:12, 8:13, 9:14, 10:15}
};

function kqRawToSec3(raw) {
  if (raw <= 1) return 1;
  if (raw === 2) return 2;
  if (raw === 3) return 3;
  if (raw === 4) return 4;
  return 5;
}

function getOverallScore() {
  const s1 = sectionScores['sec1'] || null;
  const s2 = sectionScores['sec2'] || null;
  const kqRaw = Object.values(kqScores).reduce((a,v)=>a+v,0);
  const s3 = kqRawToSec3(kqRaw);
  if (!s1 || !s2) return null;
  const t1 = (TABLE1[s2] || {})[s1] || null;
  if (!t1) return null;
  const t1c = Math.max(2, Math.min(10, t1));
  const overall = (TABLE2[s3] || {})[t1c] || null;
  return { s1, s2, s3, kqRaw, t1, overall };
}

// ============================================================
// INIT
// ============================================================
document.addEventListener('DOMContentLoaded', () => {
  loadCustomScenarios();
  buildSidebar(getAllScenarios());
  // Show disclaimer unless user has previously accepted it
  if (!localStorage.getItem('av_disclaimer_accepted')) {
    document.getElementById('disclaimer-modal').classList.add('open');
  }
});

// ============================================================
// SIDEBAR
// ============================================================
function toggleSidebar() {
  const sb = document.getElementById('sidebar');
  const ov = document.getElementById('sidebar-overlay');
  const isOpen = sb.classList.contains('open');
  sb.classList.toggle('open', !isOpen);
  ov.classList.toggle('open', !isOpen);
}
function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sidebar-overlay').classList.remove('open');
}

function buildSidebar(scenarios) {
  const list = document.getElementById('scenario-list');
  list.innerHTML = '';

  // Top-level group order and colours
  const groupOrder = ['Adult', 'Paediatric', 'Maternity', 'Newborn', 'Treat and Refer', 'Custom'];
  const groupColors = {
    'Adult': 'var(--navy)', 'Paediatric': 'var(--blue)', 'Maternity': 'var(--purple)',
    'Newborn': 'var(--green)', 'Treat and Refer': '#6D4C41', 'Custom': 'var(--amber)'
  };

  // Subcategory order within each group
  const subcatOrder = {
    'Adult': ['Cardiac Arrest','Airway Management','Cardiac','Pain Relief','Respiratory','Medical','Infection','Mental Health','Trauma','Environment','Toxicology'],
    'Paediatric': ['Cardiac Arrest','Airway Management','Pain Relief','Respiratory','Medical','Infection','Trauma','Environment','Toxicology'],
    'Maternity': ['Antepartum Haemorrhage','Pre-eclampsia / Eclampsia','Normal Birth','Breech / Compound','Preterm Labour','Cord Prolapse','Shoulder Dystocia','Primary Postpartum Haemorrhage','Miscarriage'],
    'Newborn': ['Newborn Resuscitation'],
    'Treat and Refer': ['Epistaxis','Minor Burns'],
    'Custom': []
  };

  // Group scenarios by category ‚Üí subcategory
  const groups = {};
  scenarios.forEach(s => {
    const grp = s.category || 'Custom';
    const sub = s.subcategory || (s.custom || s.ai_generated ? 'Custom' : grp);
    if (!groups[grp]) groups[grp] = {};
    if (!groups[grp][sub]) groups[grp][sub] = [];
    groups[grp][sub].push(s);
  });

  // Render all groups that have scenarios
  const allGroups = [...groupOrder.filter(g => groups[g]), ...Object.keys(groups).filter(g => !groupOrder.includes(g))];

  allGroups.forEach(grp => {
    const subcats = groups[grp];
    const color = groupColors[grp] || 'var(--grey)';
    const totalCount = Object.values(subcats).reduce((n, arr) => n + arr.length, 0);

    const groupEl = document.createElement('div');
    groupEl.className = 'sidebar-group';
    groupEl.dataset.group = grp;

    // Build subcategory HTML
    const orderedSubs = [...(subcatOrder[grp]||[]).filter(s => subcats[s]), ...Object.keys(subcats).filter(s => !(subcatOrder[grp]||[]).includes(s))];

    const subsHtml = orderedSubs.map(sub => {
      const items = subcats[sub] || [];
      return `
        <div class="sidebar-subcat">
          <div class="sidebar-subcat-header" onclick="toggleSubcat(this)">
            <span>${sub}</span><span class="cat-count">${items.length}</span>
          </div>
          <div class="sidebar-subcat-items">
            ${items.map(s => `<div class="scenario-item" id="si-${s.id}" onclick="loadScenario('${s.id}');closeSidebar()">
              <div class="si-title">${s.title}</div>
              <div class="si-sub">${s.subtitle||''}</div>
              <div class="si-cpg">${s.cpg||''}</div>
              <div class="si-badges">${s.ai_generated?'<span class="si-badge ai">AI</span>':''}${s.custom&&!s.ai_generated?'<span class="si-badge custom">Custom</span>':''}${s._edited?'<span class="si-badge" style="background:#16A085;color:white">Edited</span>':''}</div>
            </div>`).join('')}
          </div>
        </div>`;
    }).join('');

    groupEl.innerHTML = `
      <div class="sidebar-group-header" style="background:${color}" onclick="toggleSidebarGroup(this)">
        <span>${grp}</span>
        <div style="display:flex;align-items:center;gap:8px">
          <span class="cat-count">${totalCount}</span>
          <span class="group-chevron">‚ñæ</span>
        </div>
      </div>
      <div class="sidebar-group-body">${subsHtml}</div>`;
    list.appendChild(groupEl);
  });
}

function toggleSidebarGroup(header) {
  const body = header.nextElementSibling;
  const chevron = header.querySelector('.group-chevron');
  const collapsed = body.style.display === 'none';
  body.style.display = collapsed ? '' : 'none';
  if (chevron) chevron.textContent = collapsed ? '‚ñæ' : '‚ñ∏';
}

function toggleSubcat(header) {
  const items = header.nextElementSibling;
  items.style.display = items.style.display === 'none' ? '' : 'none';
}

function filterScenarios(q) {
  const all = getAllScenarios();
  if (!q.trim()) { buildSidebar(all); return; }
  const l = q.toLowerCase();
  buildSidebar(all.filter(s => (s.title||'').toLowerCase().includes(l) || (s.subtitle||'').toLowerCase().includes(l) || (s.category||'').toLowerCase().includes(l) || (s.cpg||'').toLowerCase().includes(l)));
}

// ============================================================
// LOAD SCENARIO
// ============================================================
function loadScenario(id) {
  const all = getAllScenarios();
  const s = all.find(x => String(x.id) === String(id));
  if (!s) return;
  currentScenario = s;
  rowStates = {}; sectionScores = {}; kqScores = {};
  stopTimer(); timerSeconds = 0; updateTimerDisplay();

  document.querySelectorAll('.scenario-item').forEach(el => el.classList.remove('active'));
  const si = document.getElementById('si-'+id);
  if (si) si.classList.add('active');

  document.getElementById('home-screen').style.display = 'none';
  const view = document.getElementById('scenario-view');
  view.style.display = 'block';
  view.innerHTML = renderScenario(s);

  // Embed ECG image if available
  const ecgImg = document.getElementById('ecg-img-' + s.id);
  if (ecgImg) {
    const ecg = getECGImage(s.vitals && s.vitals.Rhythm);
    if (ecg) embedECGImage(ecgImg, ecg.url);
  }

  // Open key sections
  ['sec-dispatch','sec-flags','sec-patient-assessment','sec-diagnosis','sec-implement'].forEach(sid => {
    const b = document.getElementById(sid);
    const h = b && b.previousElementSibling;
    if (b) b.classList.add('open');
    if (h) h.classList.add('open');
  });

  document.getElementById('score-panel-toggle').classList.add('visible');
  updateScoreSheet();
  showStickyBar(s);
  window.scrollTo(0,0);
}


// ============================================================
// ECG RHYTHM ‚Üí WIKIMEDIA IMAGE MAP
// ============================================================
const ECG_IMAGES = {
  // Key: lowercase regex-friendly strings matched against v.Rhythm
  // Value: { url, page, label }
  // URLs use Special:FilePath for reliable, cache-independent hotlinking
  'sinus tachycardia': {
    url: 'https://commons.wikimedia.org/wiki/Special:FilePath/Sinus_Tachycardia_(6_seconds).svg?width=800',
    page: 'https://commons.wikimedia.org/wiki/File:Sinus_Tachycardia_(6_seconds).svg',
    label: 'Sinus Tachycardia'
  },
  'sinus bradycardia': {
    url: 'https://commons.wikimedia.org/wiki/Special:FilePath/Sinus_Bradycardia_(6_seconds).svg?width=800',
    page: 'https://commons.wikimedia.org/wiki/File:Sinus_Bradycardia_(6_seconds).svg',
    label: 'Sinus Bradycardia'
  },
  'normal sinus': {
    url: 'https://commons.wikimedia.org/wiki/Special:FilePath/Normal_Sinus_Rhythm_Unlabeled.jpg?width=800',
    page: 'https://commons.wikimedia.org/wiki/File:Normal_Sinus_Rhythm_Unlabeled.jpg',
    label: 'Normal Sinus Rhythm'
  },
  'sinus rhythm': {
    url: 'https://commons.wikimedia.org/wiki/Special:FilePath/Normal_Sinus_Rhythm_Unlabeled.jpg?width=800',
    page: 'https://commons.wikimedia.org/wiki/File:Normal_Sinus_Rhythm_Unlabeled.jpg',
    label: 'Normal Sinus Rhythm'
  },
  'atrial fibrillation': {
    url: 'https://commons.wikimedia.org/wiki/Special:FilePath/Afib_small_(CardioNetworks_ECGpedia).svg?width=800',
    page: 'https://commons.wikimedia.org/wiki/File:Afib_small_(CardioNetworks_ECGpedia).svg',
    label: 'Atrial Fibrillation'
  },
  'atrial flutter': {
    url: 'https://commons.wikimedia.org/wiki/Special:FilePath/Afl_small_(CardioNetworks_ECGpedia).svg?width=800',
    page: 'https://commons.wikimedia.org/wiki/File:Afl_small_(CardioNetworks_ECGpedia).svg',
    label: 'Atrial Flutter'
  },
  'svt': {
    url: 'https://commons.wikimedia.org/wiki/Special:FilePath/Supraventricular_Tachycardia.svg?width=800',
    page: 'https://commons.wikimedia.org/wiki/File:Supraventricular_Tachycardia.svg',
    label: 'Supraventricular Tachycardia (SVT)'
  },
  'supraventricular tachycardia': {
    url: 'https://commons.wikimedia.org/wiki/Special:FilePath/Supraventricular_Tachycardia.svg?width=800',
    page: 'https://commons.wikimedia.org/wiki/File:Supraventricular_Tachycardia.svg',
    label: 'Supraventricular Tachycardia (SVT)'
  },
  'ventricular tachycardia': {
    url: 'https://commons.wikimedia.org/wiki/Special:FilePath/Ventricular_Tachycardia.svg?width=800',
    page: 'https://commons.wikimedia.org/wiki/File:Ventricular_Tachycardia.svg',
    label: 'Ventricular Tachycardia (VT)'
  },
  'ventricular fibrillation': {
    url: 'https://commons.wikimedia.org/wiki/Special:FilePath/Ventricular_Fibrillation.svg?width=800',
    page: 'https://commons.wikimedia.org/wiki/File:Ventricular_Fibrillation.svg',
    label: 'Ventricular Fibrillation (VF)'
  },
  'complete heart block': {
    url: 'https://commons.wikimedia.org/wiki/Special:FilePath/Completeheartblock.jpg?width=800',
    page: 'https://commons.wikimedia.org/wiki/File:Completeheartblock.jpg',
    label: 'Complete (3rd Degree) Heart Block'
  },
  '3rd degree': {
    url: 'https://commons.wikimedia.org/wiki/Special:FilePath/Completeheartblock.jpg?width=800',
    page: 'https://commons.wikimedia.org/wiki/File:Completeheartblock.jpg',
    label: 'Complete (3rd Degree) Heart Block'
  },
  'third degree': {
    url: 'https://commons.wikimedia.org/wiki/Special:FilePath/Completeheartblock.jpg?width=800',
    page: 'https://commons.wikimedia.org/wiki/File:Completeheartblock.jpg',
    label: 'Complete (3rd Degree) Heart Block'
  },
  'torsades': {
    url: 'https://commons.wikimedia.org/wiki/Special:FilePath/Torsades_de_Pointes_(polymorphic_VT).svg?width=800',
    page: 'https://commons.wikimedia.org/wiki/File:Torsades_de_Pointes_(polymorphic_VT).svg',
    label: 'Torsades de Pointes'
  },
  'pulseless electrical activity': {
    url: 'https://commons.wikimedia.org/wiki/Special:FilePath/Normal_Sinus_Rhythm_Unlabeled.jpg?width=800',
    page: 'https://commons.wikimedia.org/wiki/File:Normal_Sinus_Rhythm_Unlabeled.jpg',
    label: 'PEA (Organised Rhythm ‚Äî No Pulse)'
  },
  'pea': {
    url: 'https://commons.wikimedia.org/wiki/Special:FilePath/Normal_Sinus_Rhythm_Unlabeled.jpg?width=800',
    page: 'https://commons.wikimedia.org/wiki/File:Normal_Sinus_Rhythm_Unlabeled.jpg',
    label: 'PEA (Organised Rhythm ‚Äî No Pulse)'
  },
  'asystole': {
    url: 'https://commons.wikimedia.org/wiki/Special:FilePath/Asystole_2009.jpg?width=800',
    page: 'https://commons.wikimedia.org/wiki/File:Asystole_2009.jpg',
    label: 'Asystole'
  },
  '1st degree': {
    url: 'https://commons.wikimedia.org/wiki/Special:FilePath/First_degree_heart_block.svg?width=800',
    page: 'https://commons.wikimedia.org/wiki/File:First_degree_heart_block.svg',
    label: '1st Degree AV Block'
  },
  'first degree': {
    url: 'https://commons.wikimedia.org/wiki/Special:FilePath/First_degree_heart_block.svg?width=800',
    page: 'https://commons.wikimedia.org/wiki/File:First_degree_heart_block.svg',
    label: '1st Degree AV Block'
  },
  'premature ventricular': {
    url: 'https://commons.wikimedia.org/wiki/Special:FilePath/Premature_Ventricular_Complex.svg?width=800',
    page: 'https://commons.wikimedia.org/wiki/File:Premature_Ventricular_Complex.svg',
    label: 'Premature Ventricular Complex (PVC)'
  },
  'pvc': {
    url: 'https://commons.wikimedia.org/wiki/Special:FilePath/Premature_Ventricular_Complex.svg?width=800',
    page: 'https://commons.wikimedia.org/wiki/File:Premature_Ventricular_Complex.svg',
    label: 'Premature Ventricular Complex (PVC)'
  },
};

function getECGImage(rhythmStr) {
  if (!rhythmStr) return null;
  const r = String(rhythmStr).toLowerCase();
  for (const [key, val] of Object.entries(ECG_IMAGES)) {
    if (r.includes(key)) return val;
  }
  return null;
}

async function embedECGImage(imgEl, url) {
  imgEl.referrerPolicy = 'no-referrer';
  imgEl.src = url;
}

// ============================================================
// AUSTRALIAN DEMOGRAPHIC NAME POOLS (ABS 2021 Census)
// ============================================================
// Weights derived from ABS 2021 ancestry data + country of birth
// Anglo/Celtic/Australian: ~58%, European other: ~8%,
// Chinese: ~5.5%, Indian/South Asian: ~4%, Filipino/SE Asian: ~3%,
// Arabic/Middle Eastern: ~3%, Aboriginal/Torres Strait Islander: ~3.2%,
// NZ/MƒÅori: ~2.5%, African: ~1.5%, other/mixed: remainder
const NAME_POOLS = {
  anglo: {
    weight: 58,
    male:   ['James','William','Oliver','Jack','Noah','Henry','Thomas','Liam','Charlie','George','Patrick','Michael','David','Robert','Andrew','Daniel','Matthew','Ryan','Luke','Nathan','Connor','Ben','Sam','Jake','Ethan'],
    female: ['Charlotte','Olivia','Amelia','Isla','Mia','Grace','Sophie','Ava','Emma','Lily','Zoe','Chloe','Ruby','Ella','Isabella','Lucy','Hannah','Sarah','Emily','Kate','Jessica','Amy','Georgia','Alice','Holly'],
    nb:     ['Riley','Avery','Jordan','Sage','Quinn','Rowan','Hayden','Peyton','Morgan','Darcy'],
    last:   ['Smith','Jones','Williams','Brown','Wilson','Taylor','Johnson','White','Martin','Anderson','Thompson','Walker','Harris','Robinson','Clarke','Mitchell','Campbell','Turner','Hill','Evans','Cooper','Baker','Carter','Morris','Rogers','Murphy','Kelly','Ryan','O\'Brien','McDonald','Fraser','Reid','Scott','Stewart','Cameron','Murray','Graham']
  },
  european: {
    weight: 8,
    male:   ['Marco','Luca','Giovanni','Antonio','Alessandro','Dimitri','Nikolaos','Stefan','Klaus','Hans','Pierre','Jean','Christoph','Viktor','Andrei','Sergio','Miguel','Carlos','Lorenzo','Federico'],
    female: ['Sofia','Elena','Valentina','Giulia','Francesca','Maria','Katerina','Ingrid','Helene','Brigitte','Nadia','Vera','Elisa','Rosa','Lucia','Ines','Annika','Petra','Miriam','Clara'],
    nb:     ['Alex','Sasha','Claude','Luca','Nico'],
    last:   ['Russo','Ferrari','Esposito','Ricci','Marino','Greco','Costa','Bruno','Papadopoulos','Nikolaou','Georgiou','M√ºller','Schmidt','Weber','Meyer','Wagner','Becker','Hoffmann','Dubois','Laurent','Martin','Bernard','Thomas','Petit']
  },
  chinese: {
    weight: 5.5,
    male:   ['Wei','Ming','Jian','Hao','Yang','Fei','Bo','Lei','Tao','Cheng','Kai','Zheng','Jun','Liang','Peng','Xiao','Zhi','Feng','Gang','Hui','Kevin','Jason','Daniel','Andrew','Michael'],
    female: ['Ling','Mei','Xiu','Yan','Fang','Jing','Na','Ting','Xia','Ying','Hui','Zhen','Amy','Linda','Jennifer','Alice','Helen','Grace','Lily','Vivian'],
    nb:     ['Xin','Yuan','Jian','Chen','Wei'],
    last:   ['Wang','Li','Zhang','Liu','Chen','Yang','Huang','Zhao','Wu','Zhou','Xu','Sun','Ma','Zhu','Hu','Lin','Guo','He','Gao','Luo','Zheng','Liang','Tang','Xiao','Dong']
  },
  indian: {
    weight: 4,
    male:   ['Arjun','Rahul','Vikram','Aditya','Rohit','Sanjay','Raj','Priya','Amit','Suresh','Deepak','Vijay','Kiran','Manoj','Ravi','Sunil','Anand','Nikhil','Akash','Kartik','Naveen','Harish','Mohan','Ajay','Sachin'],
    female: ['Priya','Anjali','Pooja','Sunita','Rekha','Ananya','Divya','Kavya','Sneha','Meera','Nisha','Riya','Aisha','Simran','Pallavi','Neha','Swati','Tanvi','Ishita','Aarti'],
    nb:     ['Arya','Kiran','Jyoti','Sasha','Rohan'],
    last:   ['Sharma','Singh','Kumar','Patel','Gupta','Shah','Mehta','Joshi','Mishra','Rao','Nair','Pillai','Reddy','Iyer','Desai','Verma','Agarwal','Sinha','Malhotra','Bose']
  },
  seast_asian: {
    weight: 3,
    male:   ['Nguyen','Minh','Duc','Thanh','Quang','Huy','Khoa','Bao','Tuan','Duy','Jose','Juan','Miguel','Angelo','Carlo','Ramon','Eduardo','Romeo','Marlo','Danilo'],
    female: ['Linh','Huong','Mai','Phuong','Lan','Thi','Ngan','Thuy','Hoa','Yen','Maria','Ana','Rosa','Luz','Lorna','Belen','Marites','Cristina','Rowena','Jasmine'],
    nb:     ['Kim','Thai','Bui','Tran','Lee'],
    last:   ['Nguyen','Tran','Le','Pham','Hoang','Ngo','Do','Dao','Duong','Vu','Santos','Reyes','Cruz','Garcia','Dela Cruz','Gonzalez','Ramos','Flores','Torres','Mendoza']
  },
  arabic: {
    weight: 3,
    male:   ['Ahmed','Mohamed','Ali','Hassan','Omar','Khalid','Ibrahim','Yusuf','Tariq','Karim','Walid','Samir','Fadi','Nader','Ramzi','Adnan','Bilal','Ziad','Samer','Hasan'],
    female: ['Fatima','Aisha','Mariam','Nour','Sara','Layla','Rania','Dina','Hana','Yasmin','Samira','Nadia','Lina','Mona','Rana','Sana','Ruba','Abeer','Ghada','Iman'],
    nb:     ['Nour','Sami','Rami','Karim','Majd'],
    last:   ['Al-Hassan','El-Masri','Khalil','Mansour','Haddad','Nassar','Saleh','Khoury','Azar','Rizk','Ibrahim','Abdallah','Nasser','Yousef','Hamdan','Aoun','Chehab','Awad','Jaber','Shahin']
  },
  atsi: {
    weight: 3.2,
    male:   ['Jarrah','Bunjil','Tjapaltjarri','Koori','Wiremu','Tane','Matiu','Hemi','Rangi','Piripi','Dale','David','Shane','Jason','Matthew','Wayne','Troy','Kyle','Brett','Darren'],
    female: ['Kirra','Noongar','Yindi','Bindi','Marlee','Aroha','Hine','Mere','Tui','Roimata','Tracey','Kerry','Michelle','Sandra','Sharon','Donna','Debra','Rebecca','Leanne','Kylie'],
    nb:     ['Riley','Jamie','Kai','Morgan','Jordan'],
    last:   ['Briggs','Walker','Johnson','Williams','Murray','Anderson','Thomas','Jackson','Brown','Taylor','Smith','Jones','Davis','Wilson','Harris','White','Thompson','Martin','Lewis','Clarke']
  },
  nz_pacific: {
    weight: 2.5,
    male:   ['Liam','Ethan','Noah','Jack','William','Sione','Taufa','Peni','Jone','Vili','Fale','Tana','Mose','Sitiveni','Filipo'],
    female: ['Charlotte','Olivia','Isabella','Amelia','Sophie','Sela','Mele','Litia','Ana','Moana','Tina','Luisa','Sina','Fili','Vai'],
    nb:     ['Sam','Riley','Jordan','Taylor','Morgan'],
    last:   ['Tuilagi','Fifita','Taufa','Latu','Fono','Tonga','Soa','Vaka','Fisi','Nuku','Wilson','Brown','Thompson','Walker','Taylor','Davis','Anderson','Harris','Martin','White']
  },
  african: {
    weight: 1.5,
    male:   ['Kwame','Kofi','Emmanuel','Samuel','Daniel','Joseph','Michael','David','Peter','Paul','Abebe','Tesfaye','Dawit','Yohannes','Bekele','Chidi','Emeka','Obinna','Tunde','Seun'],
    female: ['Amara','Afia','Ama','Adwoa','Akosua','Fatou','Mariama','Aminata','Kadiatou','Fatoumata','Tigist','Mekdes','Selam','Hiwot','Almaz','Ngozi','Chioma','Adaeze','Blessing','Favour'],
    nb:     ['Kofi','Amara','Sasha','Jordan','Sam'],
    last:   ['Mensah','Asante','Owusu','Osei','Boateng','Adjei','Ofori','Appiah','Darko','Amoah','Haile','Bekele','Tadesse','Girma','Tekle','Okafor','Nwosu','Eze','Adeyemi','Afolabi']
  }
};

function weightedRandomName(gender) {
  // Build weighted pool
  const pools = Object.values(NAME_POOLS);
  const total = pools.reduce((s, p) => s + p.weight, 0);
  let r = Math.random() * total;
  let chosen = pools[0];
  for (const pool of pools) {
    r -= pool.weight;
    if (r <= 0) { chosen = pool; break; }
  }
  const gKey = gender === 'Male' ? 'male' : gender === 'Female' ? 'female' : 'nb';
  const firstArr = chosen[gKey] || chosen.male;
  const first = firstArr[Math.floor(Math.random() * firstArr.length)];
  const last = chosen.last[Math.floor(Math.random() * chosen.last.length)];
  return { first, last, full: `${first} ${last}` };
}

function randomAustralianPatient() {
  // ABS 2021: 49.3% male, 50.7% female; include small non-binary weight for representation
  const genderRoll = Math.random();
  const gender = genderRoll < 0.493 ? 'Male' : genderRoll < 0.985 ? 'Female' : 'Non-binary';
  const name = weightedRandomName(gender);
  const age = Math.floor(Math.random() * 70) + 18; // 18‚Äì87
  return { name: name.full, gender, age };
}

// ============================================================
// RENDER SCENARIO
// ============================================================
function renderScenario(s) {
  const isCustom = s.custom || s.ai_generated;
  const catColors = { 'Adult':'var(--navy)', 'Paediatric':'var(--blue)', 'Maternity':'var(--purple)', 'Newborn':'var(--green)', 'Treat and Refer':'#6D4C41' };
  const catBg = { 'Adult':'#1C3A6E', 'Paediatric':'#2E86C1', 'Maternity':'#7D3C98', 'Newborn':'#1E8449', 'Treat and Refer':'#4E342E' };
  const isTrauma = (s.subcategory === 'Trauma' || s.category === 'Paediatric' && s.subcategory === 'Trauma');

  const vitalsHtml = Object.entries(s.vitals||{}).map(([k,v]) => {
    const abn = isAbnormal(k, v);
    return `<div class="vital-item${abn?' abnormal':''} "><div class="vl">${k}</div><div class="vv">${v}</div></div>`;
  }).join('');

  const flagsHtml = (s.flags||[]).map(f=>`<li class="flag-item"><div class="flag-dot"></div>${f}</li>`).join('');

  const kqHtml = (s.kq||[]).map((q,i) => {
    const scoreButtons = Array.from({length:q.max+1},(_,n) => `<button class="kq-score-btn" id="kqs-${i}-${n}" onclick="setKQScore(${i},${n},${q.max})">${n}</button>`).join('');
    const criteria = q.max === 2
      ? `<li><b>0:</b> Unable/unstructured/3+ prompts</li><li><b>1:</b> Partially correct/1-2 prompts</li><li><b>2:</b> All correct, no prompts</li>`
      : `<li><b>0:</b> Unable/unstructured/2+ prompts</li><li><b>1:</b> All correct/0-1 prompts</li>`;
    return `<div class="kq-block">
      <div class="kq-question"><div class="kq-num">${i+1}</div><div>${q.q} <small style="color:var(--grey);font-weight:400">(max ${q.max} pt${q.max>1?'s':''})</small></div></div>
      <div class="kq-body">
        <div class="kq-score-row">
          <span class="kq-score-label">Score:</span>${scoreButtons}
          <span style="font-size:11px;color:var(--grey)">/ ${q.max}</span>
          ${q.answer?`<button class="reveal-btn" onclick="toggleAnswer(this)">Show answer</button>`:''}
        </div>
        <ul class="kq-criteria">${criteria}</ul>
        ${q.answer?`<div class="kq-answer">${q.answer}</div>`:''}
      </div>
    </div>`;
  }).join('');

  const treatmentHtml = (s.treatment||[]).map((t,i)=>`<li>${t}</li>`).join('');

  return `
<div class="scenario-header">
  <div class="sh-left">
    <h2>${s.title}</h2>
    <div class="sh-sub">${s.subtitle||''}</div>
    <div class="sh-badges">
      <span class="badge" style="background:${catBg[s.category]||'#1C3A6E'}">${s.category}${s.subcategory ? ' ‚Äî '+s.subcategory : ''}</span>
      ${s.cpg?`<span class="badge amber-badge">${s.cpg}</span>`:''}
      <span class="badge">Level ${s.level||'C/D'}</span>
      ${s.ai_generated?'<span class="ai-generated-badge">‚ú¶ AI</span>':''}
      ${s.custom&&!s.ai_generated?'<span class="badge custom-badge">Custom</span>':''}
      ${s._edited?'<span class="badge" style="background:#16A085">‚úé Edited</span>':''}
    </div>
    ${isCustom?'<div class="ai-disclaimer">‚ö†Ô∏è Custom scenario ‚Äî verify all clinical content against current AV CPGs before use.</div>':''}
  </div>
  <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px;flex-shrink:0">
    <button onclick="openEditModal()" style="background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.3);color:white;padding:7px 14px;border-radius:7px;cursor:pointer;font-size:12px;font-weight:700;white-space:nowrap">‚úèÔ∏è Edit Scenario</button>
  </div>
</div>
<div class="scenario-body">
  <div class="grad-bar">
    <div class="grad-field"><label>Graduate:</label><input type="text" id="grad-name" placeholder="Name"></div>
    <div class="grad-field"><label>ID:</label><input type="text" id="grad-id" placeholder="Emp #" style="width:90px"></div>
    <div class="grad-field"><label>Assessor:</label><input type="text" id="grad-assessor" placeholder="Name"></div>
    <div class="grad-field"><label>Date:</label><input type="date" id="grad-date" value="${new Date().toISOString().slice(0,10)}"></div>
    <div class="grad-field"><label>Level:</label><select id="grad-level"><option>C</option><option>D</option></select></div>
  </div>
  <div class="action-bar">
    <button class="action-btn" onclick="expandAll()">‚äï Expand All</button>
    <button class="action-btn" onclick="collapseAll()">‚äñ Collapse All</button>
    <button class="action-btn" onclick="window.print()">üñ® Print</button>
    <button class="action-btn" onclick="resetAll()">‚Ü∫ Reset</button>
    <button class="action-btn" onclick="toggleScoreSheet()" style="background:var(--navy);color:white;border-color:var(--navy)">üìä Score</button>
  </div>

  <!-- DISPATCH -->
  <div class="section">
    <div class="section-header open" onclick="toggleSection(this)">
      <div class="section-icon navy">üìª</div>
      <div class="section-title">Dispatch & Presentation</div>
      <div class="section-chevron">‚ñæ</div>
    </div>
    <div class="section-body open" id="sec-dispatch">
      <div class="dispatch-card" style="margin:-14px -16px 12px; border-radius:0">
        <div>
          <div class="dc-label">Dispatch</div>
          <div class="dc-text">${s.dispatch||'No dispatch information provided.'}</div>
          ${s.key_hx?`<div class="dc-label" style="margin-top:10px">Key History</div><div class="dc-text" style="opacity:0.85">${s.key_hx}</div>`:''}
        </div>
        <div class="vitals-grid">${vitalsHtml}</div>
      </div>
    </div>
  </div>

  <!-- FLAGS -->
  <div class="section">
    <div class="section-header open" onclick="toggleSection(this)">
      <div class="section-icon red">‚öë</div>
      <div class="section-title">Clinical Flags & Assessor Notes</div>
      <div class="section-chevron">‚ñæ</div>
    </div>
    <div class="section-body open" id="sec-flags">
      <ul class="flags-list">${flagsHtml}</ul>
      ${(s.provisional||s.ddx)?`<div class="ddx-info"><strong>Provisional Dx:</strong> ${s.provisional||'‚Äî'}<br><strong>DDx:</strong> ${(s.ddx||[]).join(' / ')||'‚Äî'}</div>`:''}
      ${(()=>{ const ecg = getECGImage(s.vitals&&s.vitals.Rhythm); if(!ecg) return ''; return `<div class="ecg-strip-section"><div class="ecg-strip-label">üìà Reference ECG Strip ‚Äî ${ecg.label}</div><img class="ecg-strip-img" id="ecg-img-${s.id}" alt="${ecg.label}" referrerpolicy="no-referrer" onerror="this.style.opacity=0.3"><div class="ecg-strip-caption">Source: <a href="${ecg.page}" target="_blank" rel="noopener">Wikimedia Commons</a> ‚Äî CC BY-SA / Public Domain</div></div>`; })()}
    </div>
  </div>

  <!-- SECTION 1 -->
  ${renderSection1(s, isTrauma)}

  <!-- SECTION 2 -->
  ${renderSection2(s)}

  <!-- KNOWLEDGE QUESTIONS -->
  <div class="section">
    <div class="section-header" onclick="toggleSection(this)">
      <div class="section-icon blue">3</div>
      <div class="section-title">Section 3: Knowledge Questions</div>
      <span class="section-badge" id="s3-badge">0/5 pts</span>
      <div class="section-chevron">‚ñæ</div>
    </div>
    <div class="section-body">
      ${kqHtml || '<p style="color:var(--grey);font-size:13px;padding:10px 0">No knowledge questions defined for this scenario.</p>'}
      <div style="margin-top:10px;font-size:11px;color:var(--grey)">Section 3 score (1‚Äì5): 0-1pts‚Üí1 &nbsp; 2pts‚Üí2 &nbsp; 3pts‚Üí3 &nbsp; 4pts‚Üí4 &nbsp; 5pts‚Üí5</div>
    </div>
  </div>

  <!-- COMMENTS -->
  <div class="section">
    <div class="section-header" onclick="toggleSection(this)">
      <div class="section-icon grey" style="background:var(--grey)">üí¨</div>
      <div class="section-title">Assessor Comments & Feedback</div>
      <div class="section-chevron">‚ñæ</div>
    </div>
    <div class="section-body">
      <div class="comments-area" style="padding:0">
        <h3 style="margin-bottom:6px">Section 1 ‚Äî Patient Assessment</h3>
        <textarea placeholder="Comments on assessment structure and technique‚Ä¶"></textarea>
        <h3 style="margin-top:14px;margin-bottom:6px">Section 2 ‚Äî Diagnosis & Care Pathways</h3>
        <textarea placeholder="Comments on clinical reasoning and management‚Ä¶"></textarea>
        <h3 style="margin-top:14px;margin-bottom:6px">Section 3 ‚Äî Knowledge Questions</h3>
        <textarea placeholder="Comments on knowledge depth and accuracy‚Ä¶"></textarea>
        <h3 style="margin-top:14px;margin-bottom:6px">Overall / Summary Feedback</h3>
        <textarea style="min-height:100px" placeholder="Overall feedback for graduate‚Ä¶"></textarea>
      </div>
    </div>
  </div>

</div>
<div class="scenario-cpg-footer">
  <strong>Clinical basis:</strong> This scenario is based on <strong>Ambulance Victoria Clinical Practice Guidelines Version 7.1.0</strong>${s.cpg ? ` (${s.cpg})` : ''}. ${s.custom || s.ai_generated ? 'AI-generated ‚Äî verify all clinical details against current published AV CPGs before formal assessment use.' : 'Adapted for verbal assessment purposes. Always verify against the current published edition.'} &nbsp;|&nbsp; Not an official AV product.
</div>`;
}

// ============================================================
// RENDER SECTION 1 ‚Äî Patient Assessment
// ============================================================
function renderSection1(s, isTrauma) {
  const v = s.vitals || {};

  // Derive contextual hints from scenario data
  const gcsNum = parseFloat(String(v.GCS)) || 15;
  const avpu = gcsNum >= 14 ? 'A' : gcsNum >= 10 ? 'V' : gcsNum >= 6 ? 'P' : 'U';
  const rrNum = parseFloat(String(v.RR)) || 16;
  const wobHint = v.SpO2 && parseFloat(v.SpO2) < 94 ? `SpO‚ÇÇ ${v.SpO2}` : v.RR && (rrNum > 25 || rrNum < 10) ? `RR ${v.RR}` : '';
  // Well/Unwell ‚Äî only UNWELL if immediate life threat present
  const sbp = (() => { const m = String(v.BP||'').match(/(\d+)\//); return m ? parseInt(m[1]) : 120; })();
  const rrN = parseFloat(String(v.RR)) || 16;
  const spo2N = parseFloat(String(v.SpO2)) || 99;
  const immediateLifeThreat = gcsNum <= 8 || sbp < 80 || spo2N < 85 || rrN > 40 || rrN < 6
    || String(v.Rhythm||'').toLowerCase().match(/vf|vt\b|asystole|pea|arrest/)
    || String(v.GCS||'').toLowerCase().includes('arrest');
  const wellHint = immediateLifeThreat ? 'UNWELL' : 'Well';
  const dispatchShort = (s.dispatch||'').split('.')[0].replace(/^Responded to [^.]+\. /,'').slice(0,60);
  const keyHxShort = (s.key_hx||'').slice(0, 70);
  const flagsHint = (s.flags||[]).slice(0,2).join('; ');
  const ddxHint = (s.ddx||[]).slice(0,3).join(', ');
  const provisionalHint = s.provisional || '';

  const hint = (val, key='') => {
    if (!val) return '';
    const abn = key ? isAbnormal(key, val) : false;
    const bg = abn ? 'var(--red)' : 'var(--navy)';
    return `<span class="vital-hint" style="background:${bg}">${val}</span>`;
  };
  const infoHint = (val) => val ? `<span class="vital-hint" style="background:#2E4057;max-width:220px;white-space:normal;line-height:1.3;vertical-align:top">${val}</span>` : '';

  const mkTick = (id, type, label) => `<button class="tick-btn" id="tick-${id}-${type}" onclick="toggleTick('${id}','${type}')" title="${label}">‚Äî</button>`;
  const mkRow = (id, label, indent=false) => `
    <tr>
      <td class="elem-label${indent?' indent':''}">${label}</td>
      <td class="tick-col">${mkTick(id,'prompted','Prompting Required')}</td>
      <td class="tick-col">${mkTick(id,'incomplete','Incomplete/Incorrect')}</td>
      <td class="tick-col">${mkTick(id,'complete','All Complete')}</td>
    </tr>`;
  const mkSubRow = (id, label, hintVal='', hintKey='', info=false) => `
    <tr>
      <td class="elem-label indent">${label}${info ? infoHint(hintVal) : hint(hintVal, hintKey)}</td>
      <td class="tick-col">${mkTick(id,'prompted','Prompting Required')}</td>
      <td colspan="2"></td>
    </tr>`;
  const mkFreeRow = (id, label) => `
    <tr>
      <td colspan="4" style="padding:6px 8px">
        <span style="font-size:11px;color:var(--grey);margin-right:8px">${label}:</span>
        <input class="ddx-input" style="width:calc(100% - 160px);display:inline-block" placeholder="Enter‚Ä¶">
        ${mkTick(id,'prompted','Prompting Required')}
      </td>
    </tr>`;

  const ltRows = (s.treatment||[]).slice(0,3).map((t,i) => mkRow(`lt${i+1}`, t||`Life threat ${i+1}`)).join('') || mkRow('lt1','Life threat 1')+mkRow('lt2','Life threat 2')+mkRow('lt3','Life threat 3');

  const secondarySurvey = isTrauma ? `
    <div class="asmt-section-header"><div class="asmt-section-title trauma">Secondary Survey ‚Äî Trauma Head-to-Toe</div><button class="all-complete-btn" onclick="markGroupComplete('ss')">‚úì All Complete</button></div>
    <table class="asmt-table" data-group="ss">
      <thead><tr><th class="left">Element</th><th>Prompting</th><th>Incomplete</th><th>Complete</th></tr></thead>
      <tbody>
        ${mkRow('ss-head','Head and face (eyes/pupils)')}${mkRow('ss-neck','Neck',true)}${mkRow('ss-chest','Chest',true)}${mkRow('ss-abdomen','Abdomen',true)}${mkRow('ss-back','Back',true)}${mkRow('ss-pelvis','Pelvis',true)}${mkRow('ss-limbs','Limbs (incl. neurovascular)',true)}${mkRow('ss-other','Other/medical consideration',true)}
      </tbody>
    </table>` : `
    <div class="asmt-section-header"><div class="asmt-section-title">Secondary Survey ‚Äî Body Systems</div><button class="all-complete-btn" onclick="markGroupComplete('ss')">‚úì All Complete</button></div>
    <table class="asmt-table" data-group="ss">
      <thead><tr><th class="left">Element</th><th>Prompting</th><th>Incomplete</th><th>Complete</th></tr></thead>
      <tbody>
        ${mkRow('ss-neuro','Neurological')}${mkRow('ss-cardio','Cardiovascular',true)}${mkRow('ss-resp','Respiratory',true)}${mkRow('ss-gi','Gastrointestinal',true)}${mkRow('ss-gu','Genitourinary',true)}${mkRow('ss-msk','Musculoskeletal',true)}${mkRow('ss-skin','Integumentary/Skin',true)}${mkRow('ss-other','Other/trauma consideration',true)}
      </tbody>
    </table>`;

  return `
  <div class="section">
    <div class="section-header open" onclick="toggleSection(this)">
      <div class="section-icon navy">1</div>
      <div class="section-title">Section 1: Patient Assessment</div>
      <span class="section-badge" id="s1-badge">Not scored</span>
      <div class="section-chevron">‚ñæ</div>
    </div>
    <div class="section-body open" id="sec-patient-assessment">

      <div class="asmt-section-header"><div class="asmt-section-title">Pre-arrival &amp; Scene</div><button class="all-complete-btn" onclick="markGroupComplete('prearr')">‚úì All Complete</button></div>
      <table class="asmt-table" data-group="prearr">
        <thead><tr><th class="left" style="width:46%">Element</th><th style="width:18%">Prompting Required</th><th style="width:18%">Sub-section Incomplete</th><th style="width:18%">All Complete</th></tr></thead>
        <tbody>
          ${mkRow('hf','Human Factors and Biases')}
          ${mkRow('dra','Dynamic Risk Assessment')}
          ${mkSubRow('ppe','PPE')}${mkSubRow('dangers','Dangers')}
          ${mkRow('rapid','Rapid Assessment (Adult/PAT)')}
          ${mkSubRow('alertness','Alertness', gcsNum < 15 ? `GCS ${v.GCS}` : 'Alert', gcsNum < 14 ? 'GCS' : '')}${mkSubRow('wob1','Work of Breathing', wobHint)}${mkSubRow('skin1','Skin')}${mkSubRow('wellunwell','Well / Unwell', wellHint, wellHint==='UNWELL'?'flag':'')}
        </tbody>
      </table>

      <div class="asmt-section-header"><div class="asmt-section-title">Primary Survey ‚Äî RABCDE</div><button class="all-complete-btn" onclick="markGroupComplete('rabcde')">‚úì All Complete</button></div>
      <table class="asmt-table" data-group="rabcde">
        <thead><tr><th class="left">Element</th><th>Prompting</th><th>Incomplete</th><th>Complete</th></tr></thead>
        <tbody>
          ${mkRow('response','Response')}
          ${mkSubRow('airway','Airway')}${mkSubRow('cspine','Cervical Spine consideration')}${mkSubRow('breathing','Breathing', v.RR ? `${v.RR}, SpO‚ÇÇ ${v.SpO2||'?'}` : '')}${mkSubRow('circ','Circulation', v.HR && v.BP ? `HR ${v.HR}, BP ${v.BP}` : '')}${mkSubRow('haem','Haemorrhage')}${mkSubRow('disability','Disability (AVPU)', `${avpu} ‚Äî GCS ${v.GCS||'15'}`)}${mkSubRow('exposure','Exposure')}
        </tbody>
      </table>

      <div class="asmt-section-header"><div class="asmt-section-title">Life Threat Management</div><button class="all-complete-btn" onclick="markGroupComplete('lt')">‚úì All Complete</button></div>
      <table class="asmt-table" data-group="lt">
        <thead><tr><th class="left">Expected management (from scenario)</th><th>Prompting</th><th>Incomplete</th><th>Complete</th></tr></thead>
        <tbody>${ltRows}</tbody>
      </table>

      <div class="asmt-section-header"><div class="asmt-section-title history">History &amp; Past History</div><button class="all-complete-btn" onclick="markGroupComplete('hx')">‚úì All Complete</button></div>
      <table class="asmt-table" data-group="hx">
        <thead><tr><th class="left">Element</th><th>Prompting</th><th>Incomplete</th><th>Complete</th></tr></thead>
        <tbody>
          ${mkRow('sitrep','Early SITREP / Request backup')}
          ${mkSubRow('limitation','Limitation of treatment / Consent')}${mkSubRow('rest','Rest / Position')}${mkSubRow('rapport','Rapport & Reassurance')}
          ${mkRow('hxhist','History of injury/illness')}
          ${mkSubRow('hxtimeline','Timeline')}${mkSubRow('hxnature','Nature')}${mkSubRow('hxprodromal','Prodromal symptoms')}${mkSubRow('hxaggreliev','Aggravating / Relieving factors')}${mkSubRow('hxassoc','Associated circumstances')}${mkSubRow('hxsimilar','Similar episodes')}
          ${mkRow('phmedical', `Medical conditions${keyHxShort ? infoHint(keyHxShort) : ''}`)}
          ${mkSubRow('phmeds','Medications')}${mkSubRow('phallergies','Allergies')}${mkSubRow('phrisk','Risk factors')}${mkSubRow('phsocial','Social & environmental')}
        </tbody>
      </table>

      <div class="asmt-section-header"><div class="asmt-section-title vss">Vital Signs Survey</div><button class="all-complete-btn" onclick="markGroupComplete('vss')">‚úì All Complete</button></div>
      <table class="asmt-table" data-group="vss">
        <thead><tr><th class="left">Element</th><th>Prompting</th><th>Incomplete</th><th>Complete</th></tr></thead>
        <tbody>
          ${mkRow('rsa','RSA ‚Äî Respiratory')}
          ${mkSubRow('appearance','Appearance')}${mkSubRow('speech','Speech')}${mkSubRow('breathsounds','Breath/Chest sounds')}${mkSubRow('rr','Respiratory Rate', v.RR||'', 'RR')}${mkSubRow('rrhythm','Respiratory Rhythm')}${mkSubRow('wob2','Work of Breathing')}${mkSubRow('spo2','SpO‚ÇÇ', v.SpO2||'', 'SpO2')}
          ${mkRow('psa','PSA ‚Äî Circulatory')}
          ${mkSubRow('bp','BP', v.BP||'', 'BP')}${mkSubRow('hr','HR', v.HR||'', 'HR')}${mkSubRow('skin2','Skin')}${mkSubRow('conscstate','Conscious State', `GCS ${v.GCS||'15'} ‚Äî ${avpu}`)}
          ${mkRow('gcstotal', v.GCS ? `GCS${hint(String(v.GCS), 'GCS')}` : 'GCS')}
          ${mkSubRow('eyes','Eyes')}${mkSubRow('verbal','Verbal')}${mkSubRow('motor','Motor')}
          ${mkRow('adjuncts','Assessment Adjuncts')}
          ${mkSubRow('weight','Weight')}${mkSubRow('temp','Temperature', v.Temp||'', 'Temp')}${mkSubRow('bgl','Blood Glucose Level', v.BGL||'', 'BGL')}${mkSubRow('ketones','Blood Ketone Level')}${mkSubRow('etco2','EtCO‚ÇÇ')}
          ${mkRow('monitor','Monitor / ECG')}
          ${mkSubRow('vrhythm','Ventricular Rhythm', v.Rhythm||'', 'Rhythm')}${mkSubRow('vrate','Ventricular Rate (¬±10bpm)', v.HR||'')}${mkSubRow('pwave','P Wave')}${mkSubRow('pr','PR Interval')}${mkSubRow('qrs','QRS Duration')}${mkSubRow('interp','Correct Rhythm Interpretation')}${mkSubRow('lead12','12 Lead (as appropriate)')}
        </tbody>
      </table>

      ${secondarySurvey}

      <div class="asmt-section-header"><div class="asmt-section-title">Focussed Assessments</div><button class="all-complete-btn" onclick="markGroupComplete('fa')">‚úì All Complete</button></div>
      <table class="asmt-table" data-group="fa">
        <tbody>
          ${mkFreeRow('fa1','Tool 1 (MASS, qSOFA, Anaphylaxis criteria, ACT FAST‚Ä¶)')}
          ${mkFreeRow('fa2','Tool 2')}
          ${mkFreeRow('fa3','Tool 3')}
        </tbody>
      </table>

      <div class="score-row" style="margin-top:12px">
        <table class="asmt-table">
          <tr>
            <td style="padding:10px;font-size:12px;font-weight:700;width:40%">Section 1 Score</td>
            <td style="padding:10px">
              <div class="score-radio-group">
                ${[1,2,3,4,5].map(n=>`<button class="score-radio-btn" id="s1-btn-${n}" onclick="setSectionScore('sec1',${n},true)">${n}</button>`).join('')}
              </div>
              <div class="auto-score-indicator" id="s1-auto-note">Auto-calculated from ticks ‚Äî tap to override</div>
            </td>
          </tr>
        </table>
      </div>
    </div>
  </div>`;
}

// ============================================================
// RENDER SECTION 2
// ============================================================
function renderSection2(s) {
  const hint = (val, key='') => {
    if (!val) return '';
    const abn = key ? isAbnormal(key, val) : false;
    const bg = abn ? 'var(--red)' : 'var(--navy)';
    return `<span class="vital-hint" style="background:${bg}">${val}</span>`;
  };
  const infoHint = (val) => val ? `<span class="vital-hint" style="background:#2E4057;max-width:220px;white-space:normal;line-height:1.3;vertical-align:top">${val}</span>` : '';

  const flagsHint = (s.flags||[]).filter(Boolean).slice(0,2).join('; ');
  const ddxHint = (s.ddx||[]).filter(Boolean).slice(0,3).join(', ');
  const provisionalHint = s.provisional || '';

  const mkTick = (id, type) => `<button class="tick-btn" id="tick-${id}-${type}" onclick="toggleTick('${id}','${type}')">‚Äî</button>`;
  const mkRow = (id, label, indent=false) => `
    <tr>
      <td class="elem-label${indent?' indent':''}">${label}</td>
      <td class="tick-col">${mkTick(id,'prompted')}</td>
      <td class="tick-col">${mkTick(id,'incomplete')}</td>
      <td class="tick-col">${mkTick(id,'complete')}</td>
    </tr>`;
  const treatHtml = (s.treatment||[]).map((t,i)=>`<li>${t}</li>`).join('');

  return `
  <div class="section">
    <div class="section-header open" onclick="toggleSection(this)">
      <div class="section-icon amber">2</div>
      <div class="section-title">Section 2: Diagnosis, Care Pathways & Treatment</div>
      <span class="section-badge" id="s2-badge">Not scored</span>
      <div class="section-chevron">‚ñæ</div>
    </div>
    <div class="section-body open" id="sec-diagnosis">
      <div class="asmt-section-header"><div class="asmt-section-title diagnosis">Risk &amp; Patient Safety</div><button class="all-complete-btn" onclick="markGroupComplete('risk')">‚úì All Complete</button></div>
      <table class="asmt-table" data-group="risk">
        <thead><tr><th class="left" style="width:46%">Element</th><th style="width:18%">Prompting Required</th><th style="width:18%">Sub-section Incomplete</th><th style="width:18%">All Complete</th></tr></thead>
        <tbody>
          ${mkRow('flags-id', `Clinical flags / Patient Safety (CPG A0/P0108)${flagsHint ? infoHint(flagsHint) : ''}`)}
          ${mkRow('frailty','Frailty status considered',true)}
          ${mkRow('triage','Trauma Triage / Paediatric Time Critical (if applicable)',true)}
        </tbody>
      </table>

      <div class="asmt-section-header"><div class="asmt-section-title diagnosis">Differential Diagnosis</div><button class="all-complete-btn" onclick="markGroupComplete('ddxgrp')">‚úì All Complete</button></div>
      <table class="asmt-table" data-group="ddxgrp">
        <tbody>
          <tr>
            <td colspan="4" style="padding:6px 8px">
              <span style="font-size:11px;color:var(--grey);margin-right:6px">Relevant DDx:</span>
              <input class="ddx-input" style="width:calc(100% - 120px);display:inline-block" placeholder="Stated differentials‚Ä¶">
              ${`<button class="tick-btn" id="tick-ddx-prompted" onclick="toggleTick('ddx','prompted')" title="Prompting Required">‚Äî</button>`}
            </td>
          </tr>
          <tr>
            <td colspan="4" style="padding:6px 8px">
              <span style="font-size:11px;color:var(--grey);margin-right:6px">Clinical Problems:</span>
              <input class="ddx-input" style="width:calc(100% - 130px);display:inline-block" placeholder="Relevant clinical problems identified‚Ä¶">
            </td>
          </tr>
          ${mkRow('provdx', `Provisional Diagnosis${provisionalHint ? infoHint(provisionalHint) : ''}`)}
        </tbody>
      </table>

      <div class="asmt-section-header"><div class="asmt-section-title diagnosis">Care Pathways ‚Äî Plan</div><button class="all-complete-btn" onclick="markGroupComplete('care')">‚úì All Complete</button></div>
      <table class="asmt-table" data-group="care">
        <thead><tr><th class="left">Element</th><th>Prompting</th><th>Incomplete</th><th>Complete</th></tr></thead>
        <tbody>
          <tr>
            <td colspan="4" style="padding:6px 8px">
              <span style="font-size:11px;color:var(--grey);margin-right:6px">Care pathway/options:</span>
              <input class="ddx-input" style="width:calc(100% - 160px);display:inline-block" placeholder="Verbalised treatment options‚Ä¶">
              ${`<button class="tick-btn" id="tick-cpo-prompted" onclick="toggleTick('cpo','prompted')">‚Äî</button>`}
            </td>
          </tr>
          ${mkRow('extric','Consider extrication',true)}
          ${mkRow('escalate','Escalates care (MICA/referral/consultation)',true)}
        </tbody>
      </table>

      <div class="asmt-section-header"><div class="asmt-section-title implement">Implement &amp; Reassess</div><button class="all-complete-btn" onclick="markGroupComplete('impl')">‚úì All Complete</button></div>
      <table class="asmt-table" data-group="impl" id="sec-implement">
        <thead><tr><th class="left">Element</th><th>Prompting</th><th>Incomplete</th><th>Complete</th></tr></thead>
        <tbody>
          ${mkRow('mgmt', `Appropriate management as per CPGs${s.cpg ? hint(s.cpg) : ''}`)}
          ${mkRow('calcs','Calculations correct',true)}
          ${mkRow('transport','Transported to appropriate facility',true)}
          ${mkRow('monitor2','Monitor trends/timeframe/rationale',true)}
          <tr>
            <td colspan="4" style="padding:6px 8px">
              <span style="font-size:11px;color:var(--grey);margin-right:6px">Deterioration risks:</span>
              <input class="ddx-input" style="width:calc(100% - 150px);display:inline-block" placeholder="Risks identified‚Ä¶">
              ${`<button class="tick-btn" id="tick-detn-prompted" onclick="toggleTick('detn','prompted')">‚Äî</button>`}
            </td>
          </tr>
        </tbody>
      </table>

      ${treatHtml ? `<div class="treatment-box"><h4>Expected Treatment ‚Äî ${s.cpg||'Scenario'}</h4><ol>${treatHtml}</ol></div>` : ''}

      <div style="margin-top:12px">
        <table class="asmt-table">
          <tr>
            <td style="padding:10px;font-size:12px;font-weight:700;width:40%">Section 2 Score</td>
            <td style="padding:10px">
              <div class="score-radio-group">
                ${[1,2,3,4,5].map(n=>`<button class="score-radio-btn" id="s2-btn-${n}" onclick="setSectionScore('sec2',${n},true)">${n}</button>`).join('')}
              </div>
              <div class="auto-score-indicator" id="s2-auto-note">Auto-calculated from ticks ‚Äî tap to override</div>
            </td>
          </tr>
        </table>
      </div>
    </div>
  </div>`;
}

// ============================================================
// TICK & AUTO-SCORE LOGIC
// ============================================================
let scoreOverridden = { sec1: false, sec2: false };

function toggleTick(rowId, type) {
  const current = (rowStates[rowId] || {})[type];
  if (!rowStates[rowId]) rowStates[rowId] = {};
  rowStates[rowId][type] = current ? null : type;
  const btn = document.getElementById(`tick-${rowId}-${type}`);
  if (!btn) return;
  btn.className = 'tick-btn' + (rowStates[rowId][type] ? ' '+type : '');
  btn.textContent = rowStates[rowId][type] ? (type==='prompted'?'P':type==='incomplete'?'‚úï':'‚úì') : '‚Äî';
  if (!scoreOverridden.sec1) autoScore('sec1');
  if (!scoreOverridden.sec2) autoScore('sec2');
  updateScoreSheet();
}

function markGroupComplete(groupId) {
  const table = document.querySelector(`table[data-group="${groupId}"]`);
  if (!table) return;
  // Mark all complete-column buttons as complete
  table.querySelectorAll('.tick-btn[id$="-complete"]').forEach(btn => {
    const id = btn.id.replace('tick-','').replace('-complete','');
    if (!rowStates[id]) rowStates[id] = {};
    rowStates[id].complete = 'complete';
    rowStates[id].prompted = null;
    rowStates[id].incomplete = null;
    btn.className = 'tick-btn complete'; btn.textContent = '‚úì';
    const pBtn = document.getElementById(`tick-${id}-prompted`);
    const iBtn = document.getElementById(`tick-${id}-incomplete`);
    if (pBtn) { pBtn.className = 'tick-btn'; pBtn.textContent = '‚Äî'; }
    if (iBtn) { iBtn.className = 'tick-btn'; iBtn.textContent = '‚Äî'; }
  });
  // Clear any prompted sub-row buttons (they don't have a complete col)
  table.querySelectorAll('.tick-btn[id$="-prompted"]').forEach(btn => {
    const id = btn.id.replace('tick-','').replace('-prompted','');
    if (!document.getElementById(`tick-${id}-complete`)) {
      if (!rowStates[id]) rowStates[id] = {};
      rowStates[id].prompted = null;
      btn.className = 'tick-btn'; btn.textContent = '‚Äî';
    }
  });
  scoreOverridden.sec1 = false; scoreOverridden.sec2 = false;
  autoScore('sec1'); autoScore('sec2');
  updateScoreSheet();
  showToast('‚úì Group marked complete');
}

function autoScore(sec) {
  if (scoreOverridden[sec]) return;
  let redCount = 0, promptedCount = 0, hasAny = false;
  Object.values(rowStates).forEach(state => {
    if (state.incomplete) redCount++;
    if (state.prompted) promptedCount++;
    if (state.complete || state.incomplete || state.prompted) hasAny = true;
  });
  if (!hasAny) return;
  let score;
  if (redCount >= 2) score = 1;
  else if (redCount === 1 || promptedCount >= 8) score = 2;
  else if (promptedCount >= 5) score = 3;
  else if (promptedCount >= 3) score = 4;
  else score = 5;
  applyScore(sec, score);
  const noteId = sec === 'sec1' ? 's1-auto-note' : 's2-auto-note';
  const note = document.getElementById(noteId);
  if (note) note.textContent = `Auto: ${score}/5 ‚Äî tap to override`;
}

function setSectionScore(sec, n, manual=false) {
  const same = sectionScores[sec] === n;
  if (manual) {
    scoreOverridden[sec] = !same;
    const noteId = sec === 'sec1' ? 's1-auto-note' : 's2-auto-note';
    const note = document.getElementById(noteId);
    if (note) note.textContent = !same ? 'Manually set ‚Äî ticks will not change this' : 'Auto-calculated from ticks ‚Äî tap to override';
  }
  applyScore(sec, same ? null : n);
  updateScoreSheet();
}

function applyScore(sec, n) {
  sectionScores[sec] = n;
  const prefix = sec === 'sec1' ? 's1' : 's2';
  [1,2,3,4,5].forEach(i => {
    const btn = document.getElementById(`${prefix}-btn-${i}`);
    if (btn) btn.className = 'score-radio-btn' + (n===i ? ` sel-${i}` : '');
  });
  const badge = document.getElementById(`${prefix}-badge`);
  if (badge) badge.textContent = n ? `Score: ${n}/5` : 'Not scored';
}

function setKQScore(idx, score, max) {
  const current = kqScores[idx];
  kqScores[idx] = (current === score) ? 0 : score;
  for (let i = 0; i <= max; i++) {
    const btn = document.getElementById(`kqs-${idx}-${i}`);
    if (btn) btn.className = 'kq-score-btn' + (kqScores[idx]===i?` sel-${i}`:'');
  }
  const s = currentScenario;
  const kqMax = (s&&s.kq) ? s.kq.reduce((a,q)=>a+q.max,0) : 5;
  const kqRaw = Object.values(kqScores).reduce((a,v)=>a+(v||0),0);
  const badge = document.getElementById('s3-badge');
  if (badge) badge.textContent = `${kqRaw}/${kqMax} pts`;
  updateScoreSheet();
}

function toggleAnswer(btn) {
  const ans = btn.closest('.kq-body').querySelector('.kq-answer');
  if (!ans) return;
  const visible = ans.classList.toggle('visible');
  btn.textContent = visible ? 'Hide answer' : 'Show answer';
}

// ============================================================
// SECTION TOGGLE
// ============================================================
function toggleSection(header) {
  const body = header.nextElementSibling;
  header.classList.toggle('open');
  body.classList.toggle('open');
}
function expandAll() { document.querySelectorAll('.section-body').forEach(b=>b.classList.add('open')); document.querySelectorAll('.section-header').forEach(h=>h.classList.add('open')); }
function collapseAll() { document.querySelectorAll('.section-body').forEach(b=>b.classList.remove('open')); document.querySelectorAll('.section-header').forEach(h=>h.classList.remove('open')); }

// ============================================================
// TIMER
// ============================================================
function startTimer() { if (!timerRunning) { timerRunning=true; timerInterval=setInterval(updateTimerDisplay,1000); } }
function stopTimer() { timerRunning=false; clearInterval(timerInterval); }
function resetTimer() { stopTimer(); timerSeconds=0; updateTimerDisplay(); }
function updateTimerDisplay() {
  timerSeconds++;
  const remaining = Math.max(0, 28*60 - timerSeconds);
  const m = Math.floor(remaining/60), s = remaining%60;
  const timeStr = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  const cls = remaining===0?'danger':remaining<=300?'warning':'';
  // Update both the sticky bar timer and the legacy in-page one if present
  const sticky = document.getElementById('sticky-timer-display');
  if (sticky) { sticky.textContent = timeStr; sticky.className = cls; }
  const legacy = document.getElementById('timer-display');
  if (legacy) { legacy.textContent = timeStr; legacy.className = cls; }
}

// ============================================================
// RESET
// ============================================================
function resetAll() {
  rowStates = {}; sectionScores = {}; kqScores = {};
  scoreOverridden = { sec1: false, sec2: false };
  document.querySelectorAll('.tick-btn').forEach(el => { el.className='tick-btn'; el.textContent='‚Äî'; });
  document.querySelectorAll('.score-radio-btn').forEach(el => el.className='score-radio-btn');
  document.querySelectorAll('.kq-score-btn').forEach(el => el.className='kq-score-btn');
  document.querySelectorAll('.kq-answer').forEach(el => el.classList.remove('visible'));
  document.querySelectorAll('textarea:not(.modal-overlay textarea), input[type=text]:not(.modal-overlay input)').forEach(el => { if (!el.id.startsWith('grad-') && el.id!=='search-input') el.value=''; });
  const s1b = document.getElementById('s1-badge'); if(s1b) s1b.textContent='Not scored';
  const s2b = document.getElementById('s2-badge'); if(s2b) s2b.textContent='Not scored';
  const s3b = document.getElementById('s3-badge'); if(s3b) s3b.textContent='0/5 pts';
  const s1n = document.getElementById('s1-auto-note'); if(s1n) s1n.textContent='Auto-calculated from ticks ‚Äî tap to override';
  const s2n = document.getElementById('s2-auto-note'); if(s2n) s2n.textContent='Auto-calculated from ticks ‚Äî tap to override';
  updateScoreSheet();
}

// ============================================================
// VITALS ABNORMAL
// ============================================================
function isAbnormal(key, value) {
  const v = String(value).toLowerCase();
  if (key==='SpO2') { const n=parseFloat(v); return n<94; }
  if (key==='HR') { const n=parseFloat(v); return n<60||n>100; }
  if (key==='RR') { const n=parseFloat(v); return n<12||n>20; }
  if (key==='BP') { const m=v.match(/(\d+)\/(\d+)/); if(m) return parseInt(m[1])<90||parseInt(m[1])>160; }
  if (key==='BGL') { const n=parseFloat(v); return n<4||n>10; }
  if (key==='GCS') { const n=parseFloat(v); return n<14; }
  if (key==='Temp') { const n=parseFloat(v); return n<36||n>38.5; }
  if (v.includes('vf')||v.includes('vt')||v.includes('asystole')||v.includes('block')||v.includes('pea')||v.includes('fibrillat')) return true;
  return false;
}

// ============================================================
// SCORE SHEET (bottom sheet on iPad)
// ============================================================
function toggleScoreSheet() {
  const sheet = document.getElementById('score-sheet');
  const ov = document.getElementById('score-sheet-overlay');
  const isOpen = sheet.classList.contains('open');
  if (!isOpen) {
    updateScoreSheet();
    sheet.classList.add('open');
    ov.classList.add('open');
  } else {
    closeScoreSheet();
  }
}
function closeScoreSheet() {
  document.getElementById('score-sheet').classList.remove('open');
  document.getElementById('score-sheet-overlay').classList.remove('open');
}

function updateScoreSheet() {
  const result = getOverallScore();
  const s = currentScenario;
  const kqRaw = Object.values(kqScores).reduce((a,v)=>a+(v||0),0);
  const kqMax = (s&&s.kq) ? s.kq.reduce((a,q)=>a+q.max,0) : 5;
  const s3 = kqRawToSec3(kqRaw);

  const scoreColorClass = n => n ? `s${Math.min(n,5)}` : 'none';

  const t1Html = result ? `
    <div class="sp-section">
      <div class="sp-section-label">Table 1 (Sec1 + Sec2)</div>
      <div class="sp-score-row"><span>Combined score</span><span class="sp-score-val">${result.t1}/10</span></div>
    </div>` : '';

  const table1Grid = (() => {
    const s1 = sectionScores['sec1'];
    const s2 = sectionScores['sec2'];
    let html = `<div class="sp-section"><div class="sp-section-label">Table 1 Lookup</div><table class="lookup-table"><tr><th>S2‚Üì S1‚Üí</th>${[1,2,3,4,5].map(i=>`<th>${i}</th>`).join('')}</tr>`;
    for (let r=1;r<=5;r++) {
      html+=`<tr><th>${r}</th>`;
      for (let c=1;c<=5;c++) {
        const v = (TABLE1[r]||{})[c]||'';
        const hl = (s1===c&&s2===r)?'highlight':'';
        html+=`<td class="${hl}">${v}</td>`;
      }
      html+=`</tr>`;
    }
    html+=`</table></div>`;
    return html;
  })();

  const overallHtml = result ? `
    <div class="total-score-display">
      <div><span class="ts-num">${result.overall||'‚Äî'}</span><span class="ts-denom">/15</span></div>
      <div class="ts-label">Overall Score</div>
      ${result.overall ? `<div class="result-badge ${result.overall>=9?'pass':'fail'}">${result.overall>=9?'‚úì PASS':'‚úó FAIL'}</div>` : ''}
    </div>` : `<div class="total-score-display"><div class="ts-label" style="color:var(--grey);padding:10px">Score sections 1 & 2 to see overall result</div></div>`;

  document.getElementById('score-sheet-body').innerHTML = `
    <div class="sp-section">
      <div class="sp-section-label">Section 1 ‚Äî Patient Assessment</div>
      <div class="sp-score-row"><span>Score</span><span class="sp-score-val ${scoreColorClass(sectionScores['sec1'])}">${sectionScores['sec1']?sectionScores['sec1']+'/5':'‚Äî'}</span></div>
    </div>
    <div class="sp-section">
      <div class="sp-section-label">Section 2 ‚Äî Diagnosis & Care</div>
      <div class="sp-score-row"><span>Score</span><span class="sp-score-val ${scoreColorClass(sectionScores['sec2'])}">${sectionScores['sec2']?sectionScores['sec2']+'/5':'‚Äî'}</span></div>
    </div>
    <div class="sp-section">
      <div class="sp-section-label">Section 3 ‚Äî Knowledge</div>
      <div class="sp-score-row"><span>Raw points</span><span>${kqRaw}/${kqMax}</span></div>
      <div class="sp-score-row"><span>Section score</span><span class="sp-score-val">${s3}/5</span></div>
    </div>
    ${t1Html}
    ${table1Grid}
    ${overallHtml}
    <button id="reset-btn" onclick="resetAll()">‚Ü∫ Reset Assessment</button>
  `;
}

// ============================================================
// AI MODAL
// ============================================================
function openAIModal() { document.getElementById('ai-modal').classList.add('open'); }
function closeAIModal() { document.getElementById('ai-modal').classList.remove('open'); }
document.getElementById('ai-modal').addEventListener('click', e => { if(e.target===document.getElementById('ai-modal')) closeAIModal(); });

async function generateAIScenario() {
  const apiKey = unlockedKey || document.getElementById('api-key-input').value.trim();
  const catVal = document.getElementById('gen-category').value;
  const [category, subcategory] = catVal.includes('|') ? catVal.split('|') : [catVal, catVal];
  const complaint = document.getElementById('gen-complaint').value.trim();
  const complexity = document.getElementById('gen-complexity').value;
  if (!apiKey) { showAIStatus('error','‚ö†Ô∏è Please enter your Anthropic API key.'); return; }
  const btn = document.getElementById('generate-scenario-btn');
  btn.disabled = true;
  btn.textContent = 'Generating‚Ä¶';
  document.getElementById('ai-save-bar').classList.remove('visible');
  lastAIScenario = null;
  showAIStatus('loading','‚ú¶ Generating scenario‚Ä¶ this may take 15‚Äì30 seconds.');
  const complaintLine = complaint ? `The scenario should involve: ${complaint}.` : `Choose a realistic and educationally valuable ${category} ‚Äî ${subcategory} presentation.`;
  const patient = randomAustralianPatient();
  const complexityNote = {standard:'Standard, core presentation with typical management.',complex:'Include a complicating factor ‚Äî comorbidity, atypical feature, or medication interaction.','high-acuity':'High acuity, time-critical, multi-system with at least one life-threatening element.'}[complexity];
  const patientNote = `Patient demographics: ${patient.age}yo ${patient.gender}, name: ${patient.name}. Use this name and demographics in the dispatch and scenario.`;

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'x-api-key': apiKey, 'anthropic-version': '2023-06-01', 'anthropic-dangerous-direct-browser-access': 'true' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 4000,
        system: 'You are a clinical scenario writer for Ambulance Victoria (AV) paramedic education. Write accurate ALS (Level C/D) verbal assessment scenarios based strictly on AV CPGs. Respond with valid JSON only ‚Äî no markdown, no preamble.',
        messages: [{ role: 'user', content: `Generate an ALS (Level C/D) verbal scenario for Ambulance Victoria.\nCategory: ${category} ‚Äî ${subcategory}\n${complaintLine}\n${complexityNote}\n${patientNote}\nReturn ONLY a valid JSON object:\n{"title":"","subtitle":"","category":"${category}","subcategory":"${subcategory}","type":"","cpg":"","level":"C/D","dispatch":"","vitals":{"GCS":"","SpO2":"","RR":"","HR":"","BP":"","Temp":"","BGL":"","Rhythm":""},"key_hx":"","flags":["","","",""],"ddx":["","","",""],"provisional":"","treatment":["","","","","","","","","",""],"kq":[{"q":"","max":2,"answer":""},{"q":"","max":2,"answer":""},{"q":"","max":1,"answer":""}]}` }]
      })
    });
    if (!response.ok) { const e=await response.json().catch(()=>({})); throw new Error(e.error?.message||`API error ${response.status}`); }
    const data = await response.json();
    const raw = data.content.map(c=>c.text||'').join('');
    const scenario = JSON.parse(raw.replace(/```json|```/g,'').trim());
    scenario.id = 'ai_' + Date.now();
    scenario.ai_generated = true;
    scenario.custom = true;
    if (!scenario.level) scenario.level = 'C/D';
    lastAIScenario = scenario;
    showAIStatus('success', `‚úì Scenario generated: "${scenario.title}" ‚Äî load it now, or save it to your permanent library.`);
    btn.textContent = '‚ú¶ Generate Scenario';
    document.getElementById('ai-save-bar').classList.add('visible');
    btn.disabled = false;
    // Auto-load it so user can see it right away
    if (!customScenarios.find(x => x.id === scenario.id)) {
      // Don't save yet ‚Äî just make it loadable temporarily
    }
    buildSidebar(getAllScenarios());
    // Add temporarily to sidebar for immediate loading
    const tempList = [...getAllScenarios(), scenario];
    buildSidebar(tempList);
  } catch(e) { showAIStatus('error', `‚úï Error: ${e.message}`); btn.textContent = '‚ú¶ Generate Scenario'; btn.disabled = false; }
}

function saveLastAIScenario() {
  if (!lastAIScenario) return;
  // Check not already saved
  if (customScenarios.find(x => x.id === lastAIScenario.id)) {
    showToast('Already saved!');
    return;
  }
  customScenarios.push(lastAIScenario);
  saveCustomScenarios();
  buildSidebar(getAllScenarios());
  document.getElementById('ai-save-bar').innerHTML = '<p style="color:var(--green)">‚úì Saved to your permanent library! Find it in the sidebar.</p>';
  showToast('‚úì Scenario saved to library');
}

function showAIStatus(type, msg) {
  const el = document.getElementById('ai-status');
  el.className = type;
  el.innerHTML = type === 'loading'
    ? `<div class="ai-spinner"></div><span>${msg}</span>`
    : msg;
}

// ============================================================
// MANUAL CREATE MODAL
// ============================================================
let kqCount = 0;
let kqMaxValues = {};

function openCreateModal() {
  kqCount = 0; kqMaxValues = {};
  document.getElementById('c-kq-list').innerHTML = '';
  document.getElementById('c-flags-list').innerHTML = '';
  document.getElementById('c-ddx-list').innerHTML = '';
  document.getElementById('c-treatment-list').innerHTML = '';
  // Clear fields
  ['c-title','c-subtitle','c-cpg','c-dispatch','c-keyhx','c-provisional',
   'cv-gcs','cv-spo2','cv-rr','cv-hr','cv-bp','cv-temp','cv-bgl','cv-rhythm'].forEach(id => {
    const el = document.getElementById(id); if(el) el.value='';
  });
  // Add default items
  addRepItem('c-flags-list','flag'); addRepItem('c-flags-list','flag');
  addRepItem('c-ddx-list','ddx'); addRepItem('c-ddx-list','ddx'); addRepItem('c-ddx-list','ddx');
  addRepItem('c-treatment-list','treatment'); addRepItem('c-treatment-list','treatment'); addRepItem('c-treatment-list','treatment');
  addKQBlock(); addKQBlock();
  document.getElementById('create-modal').classList.add('open');
}
function closeCreateModal() { document.getElementById('create-modal').classList.remove('open'); }
document.getElementById('create-modal').addEventListener('click', e => { if(e.target===document.getElementById('create-modal')) closeCreateModal(); });

function addRepItem(listId, type) {
  const list = document.getElementById(listId);
  const item = document.createElement('div');
  item.className = 'repeating-item';
  const placeholder = type==='flag' ? 'Clinical flag or assessor note‚Ä¶' : type==='ddx' ? 'Differential diagnosis‚Ä¶' : 'Treatment / management step‚Ä¶';
  item.innerHTML = `<input type="text" placeholder="${placeholder}"><button class="rep-remove-btn" onclick="this.parentElement.remove()">√ó</button>`;
  list.appendChild(item);
}

function addKQBlock() {
  if (kqCount >= 3) { showToast('Maximum 3 knowledge questions per scenario'); return; }
  const idx = kqCount++;
  kqMaxValues[idx] = 2;
  const block = document.createElement('div');
  block.className = 'kq-create-block';
  block.id = `kqcb-${idx}`;
  block.innerHTML = `
    <label>Question ${idx+1}</label>
    <textarea id="kqc-q-${idx}" placeholder="Enter the knowledge question‚Ä¶" rows="2"></textarea>
    <label>Model Answer</label>
    <textarea id="kqc-a-${idx}" placeholder="Enter the expected answer / key points‚Ä¶" rows="3"></textarea>
    <div class="kq-max-select">
      <label>Max points:</label>
      <button class="kq-max-btn active" id="kqmb-${idx}-2" onclick="setKQMax(${idx},2)">2</button>
      <button class="kq-max-btn" id="kqmb-${idx}-1" onclick="setKQMax(${idx},1)">1</button>
    </div>`;
  document.getElementById('c-kq-list').appendChild(block);
  if (kqCount >= 3) document.getElementById('c-add-kq-btn').style.display='none';
}

function setKQMax(idx, val) {
  kqMaxValues[idx] = val;
  document.getElementById(`kqmb-${idx}-1`).classList.toggle('active', val===1);
  document.getElementById(`kqmb-${idx}-2`).classList.toggle('active', val===2);
}

function saveManualScenario() {
  const title = document.getElementById('c-title').value.trim();
  const catVal = document.getElementById('c-category').value;
  const [category, subcategory] = catVal.includes('|') ? catVal.split('|') : [catVal, catVal];
  if (!title) { showToast('‚ö†Ô∏è Title is required'); return; }

  const getList = (listId) => Array.from(document.querySelectorAll(`#${listId} .repeating-item input`)).map(i=>i.value.trim()).filter(Boolean);

  const scenario = {
    id: 'custom_' + Date.now(),
    custom: true,
    ai_generated: false,
    title,
    subtitle: document.getElementById('c-subtitle').value.trim(),
    category,
    subcategory,
    type: subcategory && subcategory.toLowerCase().includes('trauma') ? 'trauma' : category.toLowerCase().includes('paed') ? 'paediatric' : category === 'Maternity' ? 'obstetric' : 'medical',
    cpg: document.getElementById('c-cpg').value.trim() || 'Custom',
    level: 'C/D',
    dispatch: document.getElementById('c-dispatch').value.trim(),
    key_hx: document.getElementById('c-keyhx').value.trim(),
    vitals: {
      GCS: document.getElementById('cv-gcs').value.trim() || '15',
      SpO2: document.getElementById('cv-spo2').value.trim() || '‚Äî',
      RR: document.getElementById('cv-rr').value.trim() || '‚Äî',
      HR: document.getElementById('cv-hr').value.trim() || '‚Äî',
      BP: document.getElementById('cv-bp').value.trim() || '‚Äî',
      Temp: document.getElementById('cv-temp').value.trim() || '‚Äî',
      BGL: document.getElementById('cv-bgl').value.trim() || '‚Äî',
      Rhythm: document.getElementById('cv-rhythm').value.trim() || '‚Äî',
    },
    flags: getList('c-flags-list'),
    ddx: getList('c-ddx-list'),
    provisional: document.getElementById('c-provisional').value.trim(),
    treatment: getList('c-treatment-list'),
    kq: Array.from({length:kqCount}, (_,i) => {
      const q = (document.getElementById(`kqc-q-${i}`)||{}).value || '';
      const a = (document.getElementById(`kqc-a-${i}`)||{}).value || '';
      return q.trim() ? { q: q.trim(), max: kqMaxValues[i]||2, answer: a.trim() } : null;
    }).filter(Boolean)
  };

  customScenarios.push(scenario);
  saveCustomScenarios();
  buildSidebar(getAllScenarios());
  closeCreateModal();
  showToast('‚úì Scenario saved to library!');

  // Auto-load it
  loadScenario(scenario.id);
}

// ============================================================
// MANAGE CUSTOM MODAL
// ============================================================
function openManageModal() {
  renderManageModal();
  document.getElementById('manage-modal').classList.add('open');
}
function closeManageModal() { document.getElementById('manage-modal').classList.remove('open'); }
document.getElementById('manage-modal').addEventListener('click', e => { if(e.target===document.getElementById('manage-modal')) closeManageModal(); });

function renderManageModal() {
  const body = document.getElementById('manage-modal-body');
  if (customScenarios.length === 0) {
    body.innerHTML = `<div class="no-custom-msg">
      <div style="font-size:36px;margin-bottom:12px">üìã</div>
      <p>No custom scenarios yet.</p>
      <p style="margin-top:6px">Use the AI Generator or Create Manually to add scenarios.</p>
      <div style="display:flex;gap:10px;justify-content:center;margin-top:16px">
        <button class="modal-submit-btn amber" style="flex:1" onclick="closeManageModal();openAIModal()">‚ú¶ AI Generator</button>
        <button class="modal-submit-btn green" style="flex:1" onclick="closeManageModal();openCreateModal()">‚úèÔ∏è Create</button>
      </div>
    </div>`;
    return;
  }
  body.innerHTML = `
    <p style="font-size:12px;color:var(--grey);margin-bottom:12px">${customScenarios.length} custom scenario${customScenarios.length>1?'s':''} saved to this device.</p>
    ${customScenarios.map(s=>`
      <div class="manage-scenario-item">
        <div class="msi-info">
          <div class="msi-title">${s.title}</div>
          <div class="msi-sub">${s.subtitle||s.category} ${s.ai_generated?'¬∑ AI generated':'¬∑ Manual'}</div>
        </div>
        <button class="action-btn" onclick="closeManageModal();loadScenario('${s.id}')" style="margin-right:4px">Load</button>
        <button class="msi-delete-btn" onclick="deleteCustomScenario('${s.id}')">Delete</button>
      </div>`).join('')}
    <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">
      <button onclick="if(confirm('Delete ALL custom scenarios?')){customScenarios=[];saveCustomScenarios();buildSidebar(getAllScenarios());renderManageModal();}" style="width:100%;padding:12px;background:var(--red-light);color:var(--red);border:1px solid #F5B7B1;border-radius:8px;font-weight:700;cursor:pointer;font-size:13px">üóë Delete All Custom Scenarios</button>
    </div>`;
}

function deleteCustomScenario(id) {
  customScenarios = customScenarios.filter(s => String(s.id) !== String(id));
  saveCustomScenarios();
  buildSidebar(getAllScenarios());
  renderManageModal();
  showToast('Scenario deleted');
}

// ============================================================
// STICKY BAR
// ============================================================
function showStickyBar(s) {
  document.getElementById('sticky-bar').classList.add('visible');
  document.getElementById('sticky-bar-offset').classList.add('visible');

  // Title
  document.getElementById('sticky-title-name').textContent = s.title || '‚Äî';
  document.getElementById('sticky-title-sub').textContent = s.subtitle || s.category || '';

  // Vitals
  const vitalsEl = document.getElementById('sticky-vitals');
  const priorityKeys = ['HR','BP','SpO2','RR','GCS','BGL','Rhythm','Temp'];
  const vitals = s.vitals || {};
  // Show priority keys first, then any others
  const keys = [...priorityKeys.filter(k => vitals[k]), ...Object.keys(vitals).filter(k => !priorityKeys.includes(k))];
  vitalsEl.innerHTML = keys.map(k => {
    const v = vitals[k];
    const abn = isAbnormal(k, v);
    return `<div class="sv-item${abn?' abnormal':''}"><div class="sv-label">${k}</div><div class="sv-value">${v}</div></div>`;
  }).join('');

  // Reset sticky timer display
  const remaining = Math.max(0, 28*60 - timerSeconds);
  const m = Math.floor(remaining/60), ss = remaining%60;
  const el = document.getElementById('sticky-timer-display');
  if (el) el.textContent = `${String(m).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
}

// ============================================================
// EDIT MODAL
// ============================================================
let editKQCount = 0;
let editKQMaxValues = {};

function openEditModal() {
  if (!currentScenario) return;
  const s = currentScenario;
  editKQCount = 0; editKQMaxValues = {};
  document.getElementById('e-kq-list').innerHTML = '';
  document.getElementById('e-flags-list').innerHTML = '';
  document.getElementById('e-ddx-list').innerHTML = '';
  document.getElementById('e-treatment-list').innerHTML = '';

  // Populate fields
  document.getElementById('e-title').value = s.title || '';
  document.getElementById('e-subtitle').value = s.subtitle || '';
  // Set category dropdown - value format is "category|subcategory"
  const catSelectVal = s.subcategory ? `${s.category}|${s.subcategory}` : s.category;
  const catEl = document.getElementById('e-category');
  if (catEl) {
    // Try exact match first, then fallback to category only
    catEl.value = catSelectVal;
    if (!catEl.value) catEl.value = s.category;
  }
  document.getElementById('e-cpg').value = s.cpg || '';
  document.getElementById('e-dispatch').value = s.dispatch || '';
  document.getElementById('e-keyhx').value = s.key_hx || '';
  document.getElementById('e-provisional').value = s.provisional || '';

  const v = s.vitals || {};
  document.getElementById('ev-gcs').value = v.GCS || '';
  document.getElementById('ev-spo2').value = v.SpO2 || '';
  document.getElementById('ev-rr').value = v.RR || '';
  document.getElementById('ev-hr').value = v.HR || '';
  document.getElementById('ev-bp').value = v.BP || '';
  document.getElementById('ev-temp').value = v.Temp || '';
  document.getElementById('ev-bgl').value = v.BGL || '';
  document.getElementById('ev-rhythm').value = v.Rhythm || '';

  (s.flags || []).forEach(f => addRepItemTo('e-flags-list', 'flag', f));
  (s.ddx || []).forEach(d => addRepItemTo('e-ddx-list', 'ddx', d));
  (s.treatment || []).forEach(t => addRepItemTo('e-treatment-list', 'treatment', t));
  (s.kq || []).forEach(q => addEditKQBlock(q));

  document.getElementById('e-add-kq-btn').style.display = editKQCount >= 3 ? 'none' : '';
  document.getElementById('edit-modal').classList.add('open');
}

function closeEditModal() { document.getElementById('edit-modal').classList.remove('open'); }
document.getElementById('edit-modal').addEventListener('click', e => { if(e.target===document.getElementById('edit-modal')) closeEditModal(); });

function addRepItemTo(listId, type, value='') {
  const list = document.getElementById(listId);
  const item = document.createElement('div');
  item.className = 'repeating-item';
  const placeholder = type==='flag' ? 'Clinical flag‚Ä¶' : type==='ddx' ? 'Differential diagnosis‚Ä¶' : 'Treatment step‚Ä¶';
  item.innerHTML = `<input type="text" placeholder="${placeholder}" value="${value.replace(/"/g,'&quot;')}"><button class="rep-remove-btn" onclick="this.parentElement.remove()">√ó</button>`;
  list.appendChild(item);
}

function addEditKQBlock(existing) {
  if (editKQCount >= 3) return;
  const idx = editKQCount++;
  const maxVal = existing ? existing.max : 2;
  editKQMaxValues[idx] = maxVal;
  const block = document.createElement('div');
  block.className = 'kq-create-block';
  block.id = `ekqcb-${idx}`;
  block.innerHTML = `
    <label>Question ${idx+1}</label>
    <textarea id="ekqc-q-${idx}" rows="2">${existing ? existing.q.replace(/</g,'&lt;') : ''}</textarea>
    <label>Model Answer</label>
    <textarea id="ekqc-a-${idx}" rows="3">${existing ? (existing.answer||'').replace(/</g,'&lt;') : ''}</textarea>
    <div class="kq-max-select">
      <label>Max points:</label>
      <button class="kq-max-btn ${maxVal===2?'active':''}" id="ekqmb-${idx}-2" onclick="setEditKQMax(${idx},2)">2</button>
      <button class="kq-max-btn ${maxVal===1?'active':''}" id="ekqmb-${idx}-1" onclick="setEditKQMax(${idx},1)">1</button>
    </div>`;
  document.getElementById('e-kq-list').appendChild(block);
  if (editKQCount >= 3) document.getElementById('e-add-kq-btn').style.display = 'none';
}

function setEditKQMax(idx, val) {
  editKQMaxValues[idx] = val;
  document.getElementById(`ekqmb-${idx}-1`).classList.toggle('active', val===1);
  document.getElementById(`ekqmb-${idx}-2`).classList.toggle('active', val===2);
}

function getRepListValues(listId) {
  return Array.from(document.querySelectorAll(`#${listId} .repeating-item input`)).map(i=>i.value.trim()).filter(Boolean);
}

function saveEditedScenario() {
  if (!currentScenario) return;
  const orig = currentScenario;

  const catVal = document.getElementById('e-category').value;
  const [editCat, editSub] = catVal.includes('|') ? catVal.split('|') : [catVal, orig.subcategory || catVal];

  const edited = {
    ...orig,
    _edited: true,
    _originalId: orig._originalId || orig.id,
    title: document.getElementById('e-title').value.trim() || orig.title,
    subtitle: document.getElementById('e-subtitle').value.trim(),
    category: editCat,
    subcategory: editSub,
    cpg: document.getElementById('e-cpg').value.trim(),
    dispatch: document.getElementById('e-dispatch').value.trim(),
    key_hx: document.getElementById('e-keyhx').value.trim(),
    provisional: document.getElementById('e-provisional').value.trim(),
    vitals: {
      GCS: document.getElementById('ev-gcs').value.trim() || orig.vitals?.GCS || '‚Äî',
      SpO2: document.getElementById('ev-spo2').value.trim() || orig.vitals?.SpO2 || '‚Äî',
      RR: document.getElementById('ev-rr').value.trim() || orig.vitals?.RR || '‚Äî',
      HR: document.getElementById('ev-hr').value.trim() || orig.vitals?.HR || '‚Äî',
      BP: document.getElementById('ev-bp').value.trim() || orig.vitals?.BP || '‚Äî',
      Temp: document.getElementById('ev-temp').value.trim() || orig.vitals?.Temp || '‚Äî',
      BGL: document.getElementById('ev-bgl').value.trim() || orig.vitals?.BGL || '‚Äî',
      Rhythm: document.getElementById('ev-rhythm').value.trim() || orig.vitals?.Rhythm || '‚Äî',
    },
    flags: getRepListValues('e-flags-list'),
    ddx: getRepListValues('e-ddx-list'),
    treatment: getRepListValues('e-treatment-list'),
    kq: Array.from({length: editKQCount}, (_, i) => {
      const q = (document.getElementById(`ekqc-q-${i}`) || {}).value || '';
      const a = (document.getElementById(`ekqc-a-${i}`) || {}).value || '';
      return q.trim() ? { q: q.trim(), max: editKQMaxValues[i] || 2, answer: a.trim() } : null;
    }).filter(Boolean)
  };

  // Store in custom scenarios (keyed by original ID so it overrides)
  const existingIdx = customScenarios.findIndex(s => s._originalId === edited._originalId || s.id === orig.id);
  if (existingIdx >= 0) {
    customScenarios[existingIdx] = edited;
  } else {
    // For built-in scenarios, store with original id so it takes precedence
    edited.id = orig.id; // keep same id so sidebar item loads it
    customScenarios.push(edited);
  }
  saveCustomScenarios();
  buildSidebar(getAllScenarios());
  closeEditModal();

  // Reload the edited version
  currentScenario = edited;
  const view = document.getElementById('scenario-view');
  view.innerHTML = renderScenario(edited);
  // Embed ECG
  const ecgImgE = document.getElementById('ecg-img-' + edited.id);
  if (ecgImgE) { const ecgE = getECGImage(edited.vitals && edited.vitals.Rhythm); if (ecgE) embedECGImage(ecgImgE, ecgE.url); }
  ['sec-dispatch','sec-flags','sec-patient-assessment','sec-diagnosis','sec-implement'].forEach(sid => {
    const h = b && b.previousElementSibling;
    if (b) b.classList.add('open');
    if (h) h.classList.add('open');
  });
  showStickyBar(edited);
  showToast('‚úì Scenario saved ‚Äî edits applied');
}

function revertScenarioEdits() {
  if (!currentScenario) return;
  const origId = currentScenario._originalId || currentScenario.id;
  const confirmed = confirm('Revert to the original built-in version? Your edits to this scenario will be deleted.');
  if (!confirmed) return;
  customScenarios = customScenarios.filter(s => s._originalId !== origId && s.id !== origId);
  saveCustomScenarios();
  closeEditModal();
  // Reload original
  const orig = SCENARIOS.find(s => s.id === origId || String(s.id) === String(origId));
  if (orig) {
    buildSidebar(getAllScenarios());
    currentScenario = orig;
    const view = document.getElementById('scenario-view');
    view.innerHTML = renderScenario(orig);
    ['sec-dispatch','sec-flags','sec-patient-assessment','sec-diagnosis','sec-implement'].forEach(sid => {
      const b = document.getElementById(sid);
      const h = b && b.previousElementSibling;
      if (b) b.classList.add('open');
      if (h) h.classList.add('open');
    });
    showStickyBar(orig);
    showToast('‚Ü∫ Reverted to original');
  }
}


// ============================================================
// HIDDEN API UNLOCK
// ============================================================
const PRELOADED_KEY = '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';
let unlockedKey = null;

function checkUnlockCode(val) {
  const status = document.getElementById('unlock-status');
  const keyInput = document.getElementById('api-key-input');
  if (val === 'humeavtest') {
    unlockedKey = PRELOADED_KEY;
    if (status) { status.textContent = '‚úì Access granted'; status.style.color = 'var(--green)'; }
    if (keyInput) { keyInput.value = ''; keyInput.placeholder = 'Access code active ‚Äî no key needed'; keyInput.disabled = true; }
  } else {
    unlockedKey = null;
    if (status) { status.textContent = ''; }
    if (keyInput) { keyInput.disabled = false; keyInput.placeholder = 'sk-ant-api03-‚Ä¶'; }
  }
}

// ============================================================
// DISCLAIMER
// ============================================================
function acceptDisclaimer() {
  if (document.getElementById('disclaimer-dont-show').checked) {
    localStorage.setItem('av_disclaimer_accepted', '1');
  }
  document.getElementById('disclaimer-modal').classList.remove('open');
}

// ============================================================
// TOAST
// ============================================================
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2800);
}

</script>
</body>
</html>
